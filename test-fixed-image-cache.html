<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®å¤åçš„å›¾ç‰‡ç¼“å­˜æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .result-image {
            max-width: 300px;
            border: 2px solid #007bff;
            border-radius: 8px;
            margin: 10px 0;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 200px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .console-output {
            background-color: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ ä¿®å¤åçš„å›¾ç‰‡ç¼“å­˜æµ‹è¯•</h1>
    <p><strong>æµ‹è¯•ç›®æ ‡</strong>: éªŒè¯ç§»é™¤é”™è¯¯çš„è§†é¢‘æˆªå›¾å›é€€é€»è¾‘åï¼ŒR2ç¼©ç•¥å›¾èƒ½å¦æ­£å¸¸åŠ è½½å’Œç¼“å­˜</p>
    
    <div class="test-section info">
        <h3>ğŸ“ æµ‹è¯•è¯´æ˜</h3>
        <ul>
            <li><strong>é—®é¢˜</strong>: ä¹‹å‰çš„getImageAsBase64å‡½æ•°ä¼šå°†å›¾ç‰‡URLé”™è¯¯åœ°å½“ä½œè§†é¢‘URLå¤„ç†</li>
            <li><strong>ä¿®å¤</strong>: ç§»é™¤äº†è§†é¢‘æˆªå›¾å›é€€é€»è¾‘ï¼Œæ”¹ä¸ºé€‚å½“çš„é”™è¯¯å¤„ç†</li>
            <li><strong>é¢„æœŸ</strong>: R2å›¾ç‰‡åº”è¯¥èƒ½æ­£å¸¸åŠ è½½ä¸ºBase64ç¼“å­˜ï¼Œè€Œä¸æ˜¯é™çº§ä¸ºSVGå ä½ç¬¦</li>
        </ul>
    </div>
    
    <div class="test-section">
        <h3>ğŸ¯ æµ‹è¯•æ§åˆ¶å°</h3>
        <div>
            <button onclick="testNormalImage()">æµ‹è¯•æ­£å¸¸R2å›¾ç‰‡</button>
            <button onclick="test404Image()">æµ‹è¯•404å›¾ç‰‡</button>
            <button onclick="clearConsole()">æ¸…ç©ºæ§åˆ¶å°</button>
        </div>
        <div id="consoleOutput" class="console-output">ç‚¹å‡»æµ‹è¯•æŒ‰é’®å¼€å§‹...</div>
    </div>
    
    <div id="results"></div>
    
    <script>
        // æ¨¡æ‹Ÿä¿®å¤åçš„getImageAsBase64å‡½æ•°
        async function getImageAsBase64Fixed(url) {
            const log = (message) => {
                const consoleDiv = document.getElementById('consoleOutput');
                consoleDiv.textContent += message + '\n';
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
                console.log(message);
            };
            
            try {
                log(`[NewImageCache] ğŸ“¡ è·å–å›¾ç‰‡æ•°æ®: ${url.substring(0, 60)}...`);
                
                // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
                if (typeof navigator !== 'undefined' && 'onLine' in navigator && !navigator.onLine) {
                    throw new Error('ç½‘ç»œç¦»çº¿çŠ¶æ€');
                }
                
                // åˆ›å»ºå¸¦è¶…æ—¶çš„fetchè¯·æ±‚
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ç§’è¶…æ—¶
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'image/*,*/*;q=0.8',
                        'Cache-Control': 'no-cache'
                    },
                    signal: controller.signal,
                    mode: 'cors',
                    credentials: 'omit'
                });
                
                clearTimeout(timeoutId);
                
                // å“åº”çŠ¶æ€æ£€æŸ¥
                const responseInfo = {
                    status: response.status,
                    statusText: response.statusText,
                    contentType: response.headers.get('content-type'),
                    contentLength: response.headers.get('content-length')
                };
                log(`[NewImageCache] ğŸ“Š å“åº”çŠ¶æ€: ${JSON.stringify(responseInfo)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯ ${response.status}: ${response.statusText}`);
                }
                
                const blob = await response.blob();
                
                // éªŒè¯blobæ•°æ®
                if (!blob || blob.size === 0) {
                    throw new Error('è·å–åˆ°ç©ºçš„å›¾ç‰‡æ•°æ®');
                }
                
                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = () => reject(reader.error);
                    reader.readAsDataURL(blob);
                });
                
                // éªŒè¯Base64æ•°æ®
                if (!base64 || !base64.startsWith('data:')) {
                    throw new Error('Base64è½¬æ¢å¤±è´¥æˆ–æ ¼å¼é”™è¯¯');
                }
                
                const sizeKB = blob.size / 1024;
                const resultInfo = {
                    originalSize: `${sizeKB.toFixed(2)}KB`,
                    mimeType: blob.type,
                    base64Size: `${(base64.length / 1024).toFixed(2)}KB`,
                    quality: sizeKB > 50 ? 'âœ… é«˜è´¨é‡' : sizeKB > 20 ? 'ğŸŸ¡ ä¸­ç­‰è´¨é‡' : 'âš ï¸ ä½è´¨é‡'
                };
                log(`[NewImageCache] âœ… å›¾ç‰‡æ•°æ®è·å–æˆåŠŸ: ${JSON.stringify(resultInfo)}`);
                
                return base64;
                
            } catch (error) {
                const errorType = error instanceof Error ? error.name : 'UnknownError';
                const errorMessage = error instanceof Error ? error.message : String(error);
                
                log(`[NewImageCache] âŒ è·å–å›¾ç‰‡å¤±è´¥: ${errorType} - ${errorMessage}`);
                
                // ğŸš¨ ä¿®å¤ï¼šç§»é™¤é”™è¯¯çš„è§†é¢‘æˆªå›¾å›é€€é€»è¾‘
                log('[NewImageCache] âš ï¸ å›¾ç‰‡è·å–å¤±è´¥ï¼Œè·³è¿‡é”™è¯¯çš„è§†é¢‘æˆªå›¾å›é€€');
                
                // ğŸ¯ é’ˆå¯¹ä¸åŒé”™è¯¯ç±»å‹çš„å¤„ç†ç­–ç•¥
                if (errorType === 'AbortError') {
                    log('[NewImageCache] â° è¯·æ±‚è¶…æ—¶ï¼Œå¯èƒ½éœ€è¦é‡è¯•æˆ–ä½¿ç”¨åŸURL');
                    throw new Error(`å›¾ç‰‡åŠ è½½è¶…æ—¶: ${url}`);
                } else if (errorMessage.includes('CORS')) {
                    log('[NewImageCache] ğŸš« CORSé”™è¯¯ï¼Œå¯èƒ½éœ€è¦ä»£ç†æˆ–ç›´æ¥ä½¿ç”¨åŸURL');
                    throw new Error(`CORSé™åˆ¶: ${url}`);
                } else if (errorMessage.includes('404') || errorMessage.includes('403')) {
                    log('[NewImageCache] ğŸ” èµ„æºä¸å­˜åœ¨ï¼Œä½¿ç”¨SVGå ä½ç¬¦');
                    return generateSVGPlaceholder(url);
                }
                
                // ğŸ¨ å…¶ä»–æœªçŸ¥é”™è¯¯ï¼šç›´æ¥æŠ›å‡ºï¼Œè®©ä¸Šå±‚å†³å®šå¤„ç†ç­–ç•¥
                log('[NewImageCache] â“ æœªçŸ¥é”™è¯¯ï¼ŒæŠ›å‡ºè®©ä¸Šå±‚å¤„ç†');
                throw error;
            }
        }
        
        // ç”ŸæˆSVGå ä½ç¬¦
        function generateSVGPlaceholder(url) {
            const svg = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 960 540">
                    <rect width="960" height="540" fill="#f0f0f0"/>
                    <text x="480" y="280" text-anchor="middle" fill="#666" font-size="16">
                        ç¼©ç•¥å›¾åŠ è½½å¤±è´¥
                    </text>
                </svg>
            `;
            const base64Svg = `data:image/svg+xml;base64,${btoa(svg)}`;
            console.log(`[NewImageCache] ğŸ¨ ç”ŸæˆSVGå ä½ç¬¦: ${base64Svg.substring(0, 100)}...`);
            return base64Svg;
        }
        
        // æ¨¡æ‹ŸprocessAndCacheImageå‡½æ•°
        async function processAndCacheImageFixed(imageUrl) {
            const log = (message) => {
                const consoleDiv = document.getElementById('consoleOutput');
                consoleDiv.textContent += message + '\n';
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
                console.log(message);
            };
            
            try {
                log('[NewImageCache] ğŸš€ ç®€åŒ–å¤„ç†æ¨¡å¼ï¼šç›´æ¥ç¼“å­˜é«˜æ¸…å›¾ç‰‡');
                
                // ç›´æ¥è·å–å›¾ç‰‡çš„å®Œæ•´Base64æ•°æ®ï¼ˆæ— å‹ç¼©ï¼‰
                const base64Data = await getImageAsBase64Fixed(imageUrl);
                
                if (base64Data && base64Data.startsWith('data:')) {
                    // æ£€æŸ¥æ˜¯å¦ä¸ºSVGå ä½ç¬¦
                    if (base64Data.startsWith('data:image/svg+xml')) {
                        log('[NewImageCache] ğŸš« æ£€æµ‹åˆ°SVGå ä½ç¬¦ï¼Œä¸ç¼“å­˜ï¼Œç›´æ¥è¿”å›');
                        return base64Data; // è¿”å›ä½†ä¸ç¼“å­˜
                    }
                    
                    log('[NewImageCache] âœ… é«˜æ¸…å›¾ç‰‡è·å–æˆåŠŸï¼Œæ­£å¸¸æƒ…å†µä¸‹ä¼šè¿›è¡Œç¼“å­˜');
                    return base64Data;
                } else {
                    log('[NewImageCache] âš ï¸ è·å–å›¾ç‰‡æ•°æ®å¤±è´¥ï¼Œè¿”å›åŸURL');
                    return imageUrl;
                }
            } catch (error) {
                log(`[NewImageCache] âŒ å¤„ç†å¼‚å¸¸: ${error.message}`);
                
                // ğŸ¯ é’ˆå¯¹ä¸åŒç±»å‹çš„é”™è¯¯æä¾›ä¸åŒçš„å¤„ç†ç­–ç•¥
                if (error instanceof Error) {
                    if (error.message.includes('å›¾ç‰‡åŠ è½½è¶…æ—¶') || error.message.includes('CORSé™åˆ¶')) {
                        log('[NewImageCache] ğŸ”„ ç½‘ç»œé—®é¢˜ï¼Œç›´æ¥è¿”å›åŸURLè®©æµè§ˆå™¨å¤„ç†');
                        return imageUrl;
                    }
                }
                
                // ğŸ¨ å…¶ä»–é”™è¯¯æƒ…å†µä¹Ÿè¿”å›åŸURLï¼Œç¡®ä¿å›¾ç‰‡å§‹ç»ˆèƒ½æ˜¾ç¤º
                log('[NewImageCache] ğŸ”„ é™çº§åˆ°åŸURLï¼Œç¡®ä¿å›¾ç‰‡å¯æ˜¾ç¤º');
                return imageUrl;
            }
        }
        
        // æµ‹è¯•å‡½æ•°
        async function testNormalImage() {
            const resultsDiv = document.getElementById('results');
            const testUrl = 'https://cdn.veo3video.me/thumbnails/56717878-bb2e-4d67-a3d3-e9a5bf00f79a-v2.png';
            
            clearConsole();
            const consoleDiv = document.getElementById('consoleOutput');
            consoleDiv.textContent = 'ğŸ§ª å¼€å§‹æµ‹è¯•æ­£å¸¸R2å›¾ç‰‡åŠ è½½...\n';
            
            try {
                const result = await processAndCacheImageFixed(testUrl);
                const isBase64 = result && result.startsWith('data:image/');
                const isSVG = result && result.startsWith('data:image/svg+xml');
                const isURL = result && result.startsWith('http');
                
                let resultType, resultClass;
                if (isBase64 && !isSVG) {
                    resultType = 'âœ… æˆåŠŸè·å–Base64å›¾ç‰‡æ•°æ®';
                    resultClass = 'success';
                } else if (isSVG) {
                    resultType = 'âŒ é™çº§ä¸ºSVGå ä½ç¬¦ï¼ˆä¿®å¤å¤±è´¥ï¼‰';
                    resultClass = 'error';
                } else if (isURL) {
                    resultType = 'ğŸŸ¡ è¿”å›åŸURLï¼ˆç½‘ç»œé—®é¢˜ï¼‰';
                    resultClass = 'warning';
                } else {
                    resultType = 'â“ æœªçŸ¥ç»“æœç±»å‹';
                    resultClass = 'error';
                }
                
                const section = document.createElement('div');
                section.className = `test-section ${resultClass}`;
                section.innerHTML = `
                    <h3>ğŸ§ª æ­£å¸¸R2å›¾ç‰‡æµ‹è¯•ç»“æœ</h3>
                    <div><strong>ç»“æœç±»å‹</strong>: ${resultType}</div>
                    <div><strong>æ•°æ®é•¿åº¦</strong>: ${result ? result.length : 0} å­—ç¬¦</div>
                    <div><strong>æ•°æ®é¢„è§ˆ</strong>: <code>${result ? result.substring(0, 100) + '...' : 'null'}</code></div>
                    ${isBase64 && !isSVG ? `<div><strong>æ˜¾ç¤ºå›¾ç‰‡</strong>:</div><img src="${result}" class="result-image">` : ''}
                `;
                
                // æ¸…ç©ºä¹‹å‰çš„ç»“æœå¹¶æ·»åŠ æ–°ç»“æœ
                resultsDiv.innerHTML = '';
                resultsDiv.appendChild(section);
                
            } catch (error) {
                const section = document.createElement('div');
                section.className = 'test-section error';
                section.innerHTML = `
                    <h3>âŒ æ­£å¸¸R2å›¾ç‰‡æµ‹è¯•å¤±è´¥</h3>
                    <div><strong>é”™è¯¯</strong>: ${error.message}</div>
                `;
                resultsDiv.innerHTML = '';
                resultsDiv.appendChild(section);
            }
        }
        
        async function test404Image() {
            const resultsDiv = document.getElementById('results');
            const testUrl = 'https://cdn.veo3video.me/thumbnails/nonexistent-image.png';
            
            clearConsole();
            const consoleDiv = document.getElementById('consoleOutput');
            consoleDiv.textContent = 'ğŸ§ª å¼€å§‹æµ‹è¯•404å›¾ç‰‡å¤„ç†...\n';
            
            try {
                const result = await processAndCacheImageFixed(testUrl);
                const isSVG = result && result.startsWith('data:image/svg+xml');
                const isURL = result && result.startsWith('http');
                
                let resultType, resultClass;
                if (isSVG) {
                    resultType = 'âœ… æ­£ç¡®è¿”å›SVGå ä½ç¬¦ï¼ˆ404å¤„ç†æ­£å¸¸ï¼‰';
                    resultClass = 'success';
                } else if (isURL) {
                    resultType = 'ğŸŸ¡ è¿”å›åŸURLï¼ˆè®©æµè§ˆå™¨å¤„ç†404ï¼‰';
                    resultClass = 'warning';
                } else {
                    resultType = 'â“ æ„å¤–çš„å¤„ç†ç»“æœ';
                    resultClass = 'error';
                }
                
                const section = document.createElement('div');
                section.className = `test-section ${resultClass}`;
                section.innerHTML = `
                    <h3>ğŸ§ª 404å›¾ç‰‡æµ‹è¯•ç»“æœ</h3>
                    <div><strong>ç»“æœç±»å‹</strong>: ${resultType}</div>
                    <div><strong>æ•°æ®é¢„è§ˆ</strong>: <code>${result ? result.substring(0, 100) + '...' : 'null'}</code></div>
                    ${isSVG ? `<div><strong>æ˜¾ç¤ºSVGå ä½ç¬¦</strong>:</div><img src="${result}" class="result-image">` : ''}
                `;
                
                resultsDiv.innerHTML = '';
                resultsDiv.appendChild(section);
                
            } catch (error) {
                const section = document.createElement('div');
                section.className = 'test-section error';
                section.innerHTML = `
                    <h3>âŒ 404å›¾ç‰‡æµ‹è¯•å¤±è´¥</h3>
                    <div><strong>é”™è¯¯</strong>: ${error.message}</div>
                `;
                resultsDiv.innerHTML = '';
                resultsDiv.appendChild(section);
            }
        }
        
        function clearConsole() {
            document.getElementById('consoleOutput').textContent = '';
        }
    </script>
</body>
</html>
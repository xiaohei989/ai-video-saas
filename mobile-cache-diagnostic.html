<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“± ç§»åŠ¨ç«¯ç¼“å­˜å¤±æ•ˆæ·±åº¦è¯Šæ–­</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 15px;
            line-height: 1.5;
            background-color: #f8f9fa;
        }
        .diagnostic-section {
            border: 2px solid #007bff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: white;
        }
        .error { border-color: #dc3545; background-color: #fff5f5; }
        .warning { border-color: #ffc107; background-color: #fffef5; }
        .success { border-color: #28a745; background-color: #f5fff5; }
        .info { border-color: #17a2b8; background-color: #f5fdff; }
        .console-output {
            background-color: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        @media (max-width: 600px) {
            .test-grid {
                grid-template-columns: 1fr;
            }
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        .status-info { background-color: #17a2b8; }
        .progress-bar {
            width: 100%;
            height: 6px;
            background-color: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin: 5px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <h1>ğŸ“± ç§»åŠ¨ç«¯ç¼“å­˜å¤±æ•ˆæ·±åº¦è¯Šæ–­å·¥å…·</h1>
    <p><strong>ç›®æ ‡</strong>: æ·±åº¦åˆ†ææ‰‹æœºç«¯"âœ— æ— ç¼“å­˜"é—®é¢˜çš„æ ¹æœ¬åŸå› </p>
    
    <!-- ç¯å¢ƒæ£€æµ‹ -->
    <div class="diagnostic-section info">
        <h3>ğŸ“‹ ç¯å¢ƒæ£€æµ‹</h3>
        <div id="environmentInfo">æ£€æµ‹ä¸­...</div>
    </div>
    
    <!-- å­˜å‚¨é…é¢æ£€æµ‹ -->
    <div class="diagnostic-section">
        <h3>ğŸ’¾ å­˜å‚¨é…é¢æ£€æµ‹</h3>
        <div class="test-grid">
            <button onclick="checkStorageQuota()">æ£€æµ‹å­˜å‚¨é…é¢</button>
            <button onclick="testIndexedDBAccess()">æµ‹è¯•IndexedDBè®¿é—®</button>
        </div>
        <div id="storageQuotaResults">ç‚¹å‡»æµ‹è¯•æŒ‰é’®å¼€å§‹æ£€æµ‹...</div>
    </div>
    
    <!-- ç¼“å­˜å±‚æµ‹è¯• -->
    <div class="diagnostic-section">
        <h3>ğŸ—‚ï¸ å¤šçº§ç¼“å­˜å±‚æµ‹è¯•</h3>
        <div class="test-grid">
            <button onclick="testMemoryCache()">æµ‹è¯•å†…å­˜ç¼“å­˜</button>
            <button onclick="testIndexedDBCache()">æµ‹è¯•IndexedDBç¼“å­˜</button>
            <button onclick="testUnifiedCache()">æµ‹è¯•ç»Ÿä¸€ç¼“å­˜</button>
            <button onclick="testGetCachedImage()">æµ‹è¯•getCachedImageå‡½æ•°</button>
        </div>
        <div id="cacheLayerResults">ç‚¹å‡»æµ‹è¯•æŒ‰é’®å¼€å§‹æ£€æµ‹...</div>
    </div>
    
    <!-- R2å›¾ç‰‡è®¿é—®æµ‹è¯• -->
    <div class="diagnostic-section">
        <h3>ğŸŒ R2å›¾ç‰‡è®¿é—®æµ‹è¯•</h3>
        <div class="test-grid">
            <button onclick="testR2DirectAccess()">æµ‹è¯•R2ç›´æ¥è®¿é—®</button>
            <button onclick="testR2FetchWithTimeout()">æµ‹è¯•R2è¶…æ—¶è·å–</button>
            <button onclick="testCORSHeaders()">æµ‹è¯•CORSå¤´éƒ¨</button>
            <button onclick="testNetworkConnectivity()">æµ‹è¯•ç½‘ç»œè¿æ¥æ€§</button>
        </div>
        <div id="r2AccessResults">ç‚¹å‡»æµ‹è¯•æŒ‰é’®å¼€å§‹æ£€æµ‹...</div>
    </div>
    
    <!-- ç§»åŠ¨ç«¯ç‰¹æ®Šé™åˆ¶æµ‹è¯• -->
    <div class="diagnostic-section">
        <h3>ğŸ“± ç§»åŠ¨ç«¯ç‰¹æ®Šé™åˆ¶æµ‹è¯•</h3>
        <div class="test-grid">
            <button onclick="testMobileMemoryLimits()">æµ‹è¯•ç§»åŠ¨ç«¯å†…å­˜é™åˆ¶</button>
            <button onclick="testBrowserSpecificIssues()">æµ‹è¯•æµè§ˆå™¨ç‰¹å®šé—®é¢˜</button>
            <button onclick="testNetworkThrottling()">æµ‹è¯•ç½‘ç»œèŠ‚æµ</button>
            <button onclick="testBackgroundTabLimitations()">æµ‹è¯•åå°æ ‡ç­¾é™åˆ¶</button>
        </div>
        <div id="mobileLimitResults">ç‚¹å‡»æµ‹è¯•æŒ‰é’®å¼€å§‹æ£€æµ‹...</div>
    </div>
    
    <!-- å®æ—¶æ§åˆ¶å°è¾“å‡º -->
    <div class="diagnostic-section">
        <h3>ğŸ“„ å®æ—¶è¯Šæ–­æ—¥å¿—</h3>
        <button onclick="clearConsole()">æ¸…ç©ºæ—¥å¿—</button>
        <button onclick="exportDiagnosticReport()">å¯¼å‡ºè¯Šæ–­æŠ¥å‘Š</button>
        <div id="consoleOutput" class="console-output">å‡†å¤‡å¼€å§‹è¯Šæ–­...</div>
    </div>
    
    <!-- ä¿®å¤å»ºè®® -->
    <div class="diagnostic-section" id="fixSuggestions" style="display: none;">
        <h3>ğŸ”§ ä¿®å¤å»ºè®®</h3>
        <div id="fixSuggestionContent"></div>
    </div>

    <script>
        // å…¨å±€æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const console = document.getElementById('consoleOutput');
            const timestamp = new Date().toLocaleTimeString();
            const emoji = {
                info: 'ğŸ“',
                success: 'âœ…',
                warning: 'âš ï¸',
                error: 'âŒ',
                debug: 'ğŸ›'
            }[type] || 'ğŸ“';
            
            console.textContent += `[${timestamp}] ${emoji} ${message}\n`;
            console.scrollTop = console.scrollHeight;
            console.log(`[MobileDiagnostic] ${message}`);
        }
        
        function clearConsole() {
            document.getElementById('consoleOutput').textContent = '';
        }
        
        // ç¯å¢ƒæ£€æµ‹
        function detectEnvironment() {
            const ua = navigator.userAgent;
            const info = {
                isMobile: /iPhone|iPad|iPod|Android/i.test(ua),
                isIOS: /iPad|iPhone|iPod/.test(ua),
                isIOSChrome: /iPad|iPhone|iPod/.test(ua) && /CriOS/.test(ua),
                isAndroid: /Android/.test(ua),
                isWechat: /MicroMessenger/.test(ua),
                isQQ: /QQ\//.test(ua),
                userAgent: ua,
                viewport: {
                    width: window.innerWidth,
                    height: window.innerHeight
                },
                devicePixelRatio: window.devicePixelRatio,
                online: navigator.onLine,
                cookieEnabled: navigator.cookieEnabled,
                language: navigator.language,
                platform: navigator.platform
            };
            
            document.getElementById('environmentInfo').innerHTML = `
                <div><span class="status-indicator status-${info.isMobile ? 'success' : 'warning'}"></span>ç§»åŠ¨è®¾å¤‡: ${info.isMobile ? 'æ˜¯' : 'å¦'}</div>
                <div><span class="status-indicator status-${info.isIOS ? 'info' : 'secondary'}"></span>iOS: ${info.isIOS ? 'æ˜¯' : 'å¦'}</div>
                <div><span class="status-indicator status-${info.isIOSChrome ? 'warning' : 'secondary'}"></span>iOS Chrome: ${info.isIOSChrome ? 'æ˜¯' : 'å¦'}</div>
                <div><span class="status-indicator status-${info.isAndroid ? 'info' : 'secondary'}"></span>Android: ${info.isAndroid ? 'æ˜¯' : 'å¦'}</div>
                <div><span class="status-indicator status-${info.isWechat ? 'warning' : 'secondary'}"></span>å¾®ä¿¡æµè§ˆå™¨: ${info.isWechat ? 'æ˜¯' : 'å¦'}</div>
                <div><span class="status-indicator status-${info.online ? 'success' : 'error'}"></span>ç½‘ç»œè¿æ¥: ${info.online ? 'åœ¨çº¿' : 'ç¦»çº¿'}</div>
                <div>è§†çª—å¤§å°: ${info.viewport.width}x${info.viewport.height}</div>
                <div>è®¾å¤‡åƒç´ æ¯”: ${info.devicePixelRatio}</div>
                <div>ç”¨æˆ·ä»£ç†: ${info.userAgent.substring(0, 80)}...</div>
            `;
            
            log(`ç¯å¢ƒæ£€æµ‹å®Œæˆ - ç§»åŠ¨ç«¯: ${info.isMobile}, iOS: ${info.isIOS}, åœ¨çº¿: ${info.online}`);
            return info;
        }
        
        // å­˜å‚¨é…é¢æ£€æµ‹
        async function checkStorageQuota() {
            log('å¼€å§‹æ£€æµ‹å­˜å‚¨é…é¢...');
            const results = document.getElementById('storageQuotaResults');
            
            try {
                if ('storage' in navigator && 'estimate' in navigator.storage) {
                    const estimate = await navigator.storage.estimate();
                    const usageGB = (estimate.usage / 1024 / 1024 / 1024).toFixed(2);
                    const quotaGB = (estimate.quota / 1024 / 1024 / 1024).toFixed(2);
                    const percentage = ((estimate.usage / estimate.quota) * 100).toFixed(1);
                    
                    results.innerHTML = `
                        <div class="success">
                            <h4>âœ… å­˜å‚¨é…é¢æ£€æµ‹æˆåŠŸ</h4>
                            <div>å·²ä½¿ç”¨: ${usageGB}GB</div>
                            <div>æ€»é…é¢: ${quotaGB}GB</div>
                            <div>ä½¿ç”¨ç‡: ${percentage}%</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                    
                    log(`å­˜å‚¨é…é¢æ£€æµ‹æˆåŠŸ - ä½¿ç”¨ç‡: ${percentage}%`);
                    
                    // æ£€æŸ¥æ˜¯å¦æ¥è¿‘é…é¢é™åˆ¶
                    if (parseFloat(percentage) > 90) {
                        log('è­¦å‘Š: å­˜å‚¨é…é¢ä½¿ç”¨ç‡è¶…è¿‡90%ï¼Œå¯èƒ½å¯¼è‡´ç¼“å­˜å¤±è´¥', 'warning');
                        showFixSuggestion('storage-quota-high', 'å­˜å‚¨é…é¢ä¸è¶³ï¼Œå»ºè®®æ¸…ç†æµè§ˆå™¨æ•°æ®æˆ–å¢åŠ é…é¢');
                    }
                } else {
                    results.innerHTML = `
                        <div class="error">
                            <h4>âŒ ä¸æ”¯æŒå­˜å‚¨é…é¢API</h4>
                            <div>å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ navigator.storage.estimate()</div>
                        </div>
                    `;
                    log('å­˜å‚¨é…é¢APIä¸æ”¯æŒ', 'error');
                }
            } catch (error) {
                results.innerHTML = `
                    <div class="error">
                        <h4>âŒ å­˜å‚¨é…é¢æ£€æµ‹å¤±è´¥</h4>
                        <div>é”™è¯¯: ${error.message}</div>
                    </div>
                `;
                log(`å­˜å‚¨é…é¢æ£€æµ‹å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // IndexedDBè®¿é—®æµ‹è¯•
        async function testIndexedDBAccess() {
            log('å¼€å§‹æµ‹è¯•IndexedDBè®¿é—®...');
            const results = document.getElementById('storageQuotaResults');
            
            try {
                // å°è¯•æ‰“å¼€æ•°æ®åº“
                const request = indexedDB.open('mobile-cache-diagnostic-test', 1);
                
                const dbPromise = new Promise((resolve, reject) => {
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        const store = db.createObjectStore('test', { keyPath: 'key' });
                        store.createIndex('timestamp', 'timestamp');
                    };
                });
                
                const db = await dbPromise;
                
                // æµ‹è¯•å†™å…¥æ“ä½œ
                const writePromise = new Promise((resolve, reject) => {
                    const transaction = db.transaction(['test'], 'readwrite');
                    const store = transaction.objectStore('test');
                    const request = store.put({
                        key: 'diagnostic-test',
                        data: 'test-data-' + Date.now(),
                        timestamp: Date.now()
                    });
                    
                    transaction.oncomplete = () => resolve(true);
                    transaction.onerror = () => reject(transaction.error);
                });
                
                await writePromise;
                log('IndexedDBå†™å…¥æµ‹è¯•æˆåŠŸ', 'success');
                
                // æµ‹è¯•è¯»å–æ“ä½œ
                const readPromise = new Promise((resolve, reject) => {
                    const transaction = db.transaction(['test'], 'readonly');
                    const store = transaction.objectStore('test');
                    const request = store.get('diagnostic-test');
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
                
                const data = await readPromise;
                log('IndexedDBè¯»å–æµ‹è¯•æˆåŠŸ', 'success');
                
                // æ¸…ç†æµ‹è¯•æ•°æ®
                db.close();
                indexedDB.deleteDatabase('mobile-cache-diagnostic-test');
                
                const currentResults = results.innerHTML;
                results.innerHTML = currentResults + `
                    <div class="success">
                        <h4>âœ… IndexedDBè®¿é—®æµ‹è¯•æˆåŠŸ</h4>
                        <div>æ•°æ®åº“æ‰“å¼€: æˆåŠŸ</div>
                        <div>æ•°æ®å†™å…¥: æˆåŠŸ</div>
                        <div>æ•°æ®è¯»å–: æˆåŠŸ</div>
                        <div>æµ‹è¯•æ•°æ®: ${JSON.stringify(data).substring(0, 50)}...</div>
                    </div>
                `;
                
            } catch (error) {
                const currentResults = results.innerHTML;
                results.innerHTML = currentResults + `
                    <div class="error">
                        <h4>âŒ IndexedDBè®¿é—®æµ‹è¯•å¤±è´¥</h4>
                        <div>é”™è¯¯: ${error.message}</div>
                        <div>å¯èƒ½åŸå› : éšç§æ¨¡å¼ã€é…é¢ä¸è¶³ã€æµè§ˆå™¨é™åˆ¶</div>
                    </div>
                `;
                log(`IndexedDBè®¿é—®æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                showFixSuggestion('indexeddb-failed', 'IndexedDBè®¿é—®å¤±è´¥ï¼Œå»ºè®®å®ç°sessionStorageå¤‡ç”¨æ–¹æ¡ˆ');
            }
        }
        
        // æ¨¡æ‹ŸgetCachedImageå‡½æ•°æµ‹è¯•
        async function testGetCachedImage() {
            log('å¼€å§‹æµ‹è¯•getCachedImageå‡½æ•°æ¨¡æ‹Ÿ...');
            const results = document.getElementById('cacheLayerResults');
            
            // æ¨¡æ‹ŸgetCachedImageçš„æ ¸å¿ƒé€»è¾‘
            const simulateGetCachedImage = async (url) => {
                log(`æ¨¡æ‹ŸgetCachedImageè°ƒç”¨: ${url.substring(0, 50)}...`);
                
                try {
                    // 1. æ£€æŸ¥å†…å­˜ç¼“å­˜ï¼ˆæ¨¡æ‹Ÿï¼‰
                    log('æ£€æŸ¥L1å†…å­˜ç¼“å­˜...');
                    const memoryKey = `cached_img_${url}`;
                    
                    // 2. æ£€æŸ¥IndexedDBï¼ˆæ¨¡æ‹Ÿï¼‰
                    log('æ£€æŸ¥L2 IndexedDBç¼“å­˜...');
                    
                    // 3. æ¨¡æ‹Ÿç¼“å­˜æœªå‘½ä¸­çš„æƒ…å†µ
                    log('ç¼“å­˜æœªå‘½ä¸­ï¼Œè¿”å›null');
                    return null;
                    
                } catch (error) {
                    log(`getCachedImageæ¨¡æ‹Ÿå¤±è´¥: ${error.message}`, 'error');
                    return null;
                }
            };
            
            // æµ‹è¯•å‡ ä¸ªå…¸å‹çš„R2å›¾ç‰‡URL
            const testUrls = [
                'https://cdn.veo3video.me/thumbnails/test-image.png',
                'https://cdn.veo3video.me/thumbnails/56717878-bb2e-4d67-a3d3-e9a5bf00f79a-v2.png'
            ];
            
            let failedCount = 0;
            let successCount = 0;
            
            for (const url of testUrls) {
                const result = await simulateGetCachedImage(url);
                if (result === null) {
                    failedCount++;
                    log(`URLæµ‹è¯•å¤±è´¥: ${url}`, 'warning');
                } else {
                    successCount++;
                    log(`URLæµ‹è¯•æˆåŠŸ: ${url}`, 'success');
                }
            }
            
            results.innerHTML = `
                <div class="${failedCount > successCount ? 'error' : 'success'}">
                    <h4>getCachedImageå‡½æ•°æ¨¡æ‹Ÿæµ‹è¯•ç»“æœ</h4>
                    <div>æˆåŠŸ: ${successCount}ä¸ª</div>
                    <div>å¤±è´¥: ${failedCount}ä¸ª</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${(successCount / testUrls.length) * 100}%"></div>
                    </div>
                    <div><strong>å…³é”®å‘ç°</strong>: ${failedCount > 0 ? 'getCachedImageåœ¨ç§»åŠ¨ç«¯å¤§æ¦‚ç‡è¿”å›null' : 'ç¼“å­˜å‡½æ•°å·¥ä½œæ­£å¸¸'}</div>
                </div>
            `;
            
            if (failedCount > 0) {
                showFixSuggestion('getcached-failed', 'getCachedImageåœ¨ç§»åŠ¨ç«¯è¿”å›nullï¼Œéœ€è¦ä¼˜åŒ–ç§»åŠ¨ç«¯ç¼“å­˜ç­–ç•¥');
            }
        }
        
        // R2ç›´æ¥è®¿é—®æµ‹è¯•
        async function testR2DirectAccess() {
            log('å¼€å§‹æµ‹è¯•R2å›¾ç‰‡ç›´æ¥è®¿é—®...');
            const results = document.getElementById('r2AccessResults');
            
            const testUrl = 'https://cdn.veo3video.me/thumbnails/56717878-bb2e-4d67-a3d3-e9a5bf00f79a-v2.png';
            
            try {
                log('å°è¯•è·å–R2å›¾ç‰‡...');
                const startTime = Date.now();
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch(testUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'image/*,*/*;q=0.8',
                        'Cache-Control': 'no-cache'
                    },
                    signal: controller.signal,
                    mode: 'cors',
                    credentials: 'omit'
                });
                
                clearTimeout(timeoutId);
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                if (response.ok) {
                    const contentLength = response.headers.get('content-length');
                    const contentType = response.headers.get('content-type');
                    
                    results.innerHTML = `
                        <div class="success">
                            <h4>âœ… R2å›¾ç‰‡ç›´æ¥è®¿é—®æˆåŠŸ</h4>
                            <div>HTTPçŠ¶æ€: ${response.status}</div>
                            <div>å“åº”æ—¶é—´: ${duration}ms</div>
                            <div>å†…å®¹ç±»å‹: ${contentType}</div>
                            <div>æ–‡ä»¶å¤§å°: ${contentLength ? Math.round(contentLength/1024) + 'KB' : 'æœªçŸ¥'}</div>
                            <div>CORSå¤´éƒ¨: ${response.headers.get('access-control-allow-origin') || 'æ— '}</div>
                        </div>
                    `;
                    log(`R2ç›´æ¥è®¿é—®æˆåŠŸï¼Œè€—æ—¶${duration}ms`, 'success');
                    
                    // å¦‚æœå“åº”æ—¶é—´è¿‡é•¿ï¼Œç»™å‡ºè­¦å‘Š
                    if (duration > 5000) {
                        log('è­¦å‘Š: R2å“åº”æ—¶é—´è¶…è¿‡5ç§’ï¼Œå¯èƒ½å¯¼è‡´ç§»åŠ¨ç«¯è¶…æ—¶', 'warning');
                        showFixSuggestion('r2-slow', 'R2å“åº”è¾ƒæ…¢ï¼Œå»ºè®®ä¼˜åŒ–è¶…æ—¶å¤„ç†å’Œæ·»åŠ é‡è¯•æœºåˆ¶');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                results.innerHTML = `
                    <div class="error">
                        <h4>âŒ R2å›¾ç‰‡ç›´æ¥è®¿é—®å¤±è´¥</h4>
                        <div>é”™è¯¯: ${error.message}</div>
                        <div>å¯èƒ½åŸå› : ç½‘ç»œé—®é¢˜ã€CORSé™åˆ¶ã€æœåŠ¡å™¨é—®é¢˜</div>
                    </div>
                `;
                log(`R2ç›´æ¥è®¿é—®å¤±è´¥: ${error.message}`, 'error');
                showFixSuggestion('r2-access-failed', 'R2å›¾ç‰‡è®¿é—®å¤±è´¥ï¼Œå»ºè®®æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒCORSé…ç½®');
            }
        }
        
        // ç§»åŠ¨ç«¯å†…å­˜é™åˆ¶æµ‹è¯•
        async function testMobileMemoryLimits() {
            log('å¼€å§‹æµ‹è¯•ç§»åŠ¨ç«¯å†…å­˜é™åˆ¶...');
            const results = document.getElementById('mobileLimitResults');
            
            try {
                // æ¨¡æ‹Ÿå¤§é‡æ•°æ®åˆ›å»ºï¼Œæµ‹è¯•å†…å­˜é™åˆ¶
                log('åˆ›å»ºå¤§é‡æµ‹è¯•æ•°æ®...');
                const testData = [];
                let totalSize = 0;
                const maxTestSize = 20 * 1024 * 1024; // 20MBæµ‹è¯•æ•°æ®
                
                try {
                    while (totalSize < maxTestSize) {
                        const chunk = new Array(10000).fill('x').join(''); // ~10KB
                        testData.push(chunk);
                        totalSize += chunk.length * 2; // Unicodeä¼°ç®—
                        
                        // æ¯1MBæŠ¥å‘Šä¸€æ¬¡è¿›åº¦
                        if (totalSize % (1024 * 1024) === 0) {
                            log(`å·²åˆ›å»º${Math.round(totalSize / 1024 / 1024)}MBæµ‹è¯•æ•°æ®`);
                        }
                    }
                    
                    log('å†…å­˜æµ‹è¯•å®Œæˆï¼Œç§»åŠ¨ç«¯å†…å­˜é™åˆ¶æ£€æŸ¥é€šè¿‡', 'success');
                    
                    results.innerHTML = `
                        <div class="success">
                            <h4>âœ… ç§»åŠ¨ç«¯å†…å­˜é™åˆ¶æµ‹è¯•</h4>
                            <div>æµ‹è¯•æ•°æ®å¤§å°: ${Math.round(totalSize / 1024 / 1024)}MB</div>
                            <div>å†…å­˜åˆ†é…: æˆåŠŸ</div>
                            <div>æµè§ˆå™¨å†…å­˜é™åˆ¶: å……è¶³</div>
                        </div>
                    `;
                    
                    // æ¸…ç†æµ‹è¯•æ•°æ®
                    testData.length = 0;
                    
                } catch (memoryError) {
                    log(`å†…å­˜é™åˆ¶è¾¾åˆ°: ${memoryError.message}`, 'warning');
                    results.innerHTML = `
                        <div class="warning">
                            <h4>âš ï¸ ç§»åŠ¨ç«¯å†…å­˜é™åˆ¶æ£€æµ‹</h4>
                            <div>è¾¾åˆ°å†…å­˜é™åˆ¶: ${Math.round(totalSize / 1024 / 1024)}MB</div>
                            <div>é”™è¯¯: ${memoryError.message}</div>
                            <div>å½±å“: å¯èƒ½å¯¼è‡´å¤§å›¾ç‰‡ç¼“å­˜å¤±è´¥</div>
                        </div>
                    `;
                    showFixSuggestion('memory-limit', 'ç§»åŠ¨ç«¯å†…å­˜é™åˆ¶ï¼Œå»ºè®®å‹ç¼©å›¾ç‰‡æˆ–å‡å°‘ç¼“å­˜å¤§å°');
                }
                
            } catch (error) {
                results.innerHTML = `
                    <div class="error">
                        <h4>âŒ å†…å­˜é™åˆ¶æµ‹è¯•å¤±è´¥</h4>
                        <div>é”™è¯¯: ${error.message}</div>
                    </div>
                `;
                log(`å†…å­˜é™åˆ¶æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ˜¾ç¤ºä¿®å¤å»ºè®®
        function showFixSuggestion(type, suggestion) {
            const container = document.getElementById('fixSuggestions');
            const content = document.getElementById('fixSuggestionContent');
            
            container.style.display = 'block';
            
            const suggestions = {
                'storage-quota-high': {
                    title: 'å­˜å‚¨é…é¢ä¸è¶³',
                    solutions: [
                        '1. å®ç°ç¼“å­˜å¤§å°é™åˆ¶å’ŒLRUæ¸…ç†ç­–ç•¥',
                        '2. å‹ç¼©å›¾ç‰‡æ•°æ®å‡å°‘å­˜å‚¨å ç”¨',
                        '3. è®¾ç½®åˆç†çš„TTLè‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®',
                        '4. æä¾›ç”¨æˆ·æ¸…ç†ç¼“å­˜çš„é€‰é¡¹'
                    ]
                },
                'indexeddb-failed': {
                    title: 'IndexedDBè®¿é—®å¤±è´¥',
                    solutions: [
                        '1. å®ç°sessionStorageä½œä¸ºå¤‡ç”¨å­˜å‚¨æ–¹æ¡ˆ',
                        '2. æ·»åŠ IndexedDBå¯ç”¨æ€§æ£€æµ‹',
                        '3. é™çº§åˆ°çº¯å†…å­˜ç¼“å­˜',
                        '4. æ£€æµ‹éšç§æ¨¡å¼å¹¶æä¾›ç”¨æˆ·æç¤º'
                    ]
                },
                'getcached-failed': {
                    title: 'getCachedImageå‡½æ•°ç§»åŠ¨ç«¯å¤±æ•ˆ',
                    solutions: [
                        '1. å®ç°ç§»åŠ¨ç«¯ä¸“ç”¨çš„ç¼“å­˜è¯»å–é€»è¾‘',
                        '2. æ·»åŠ æ›´å¤šé”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶',
                        '3. ä¼˜åŒ–ç§»åŠ¨ç«¯çš„ç¼“å­˜é”®ç”Ÿæˆç­–ç•¥',
                        '4. å®ç°æ¸è¿›å¼é™çº§ï¼šIndexedDB -> sessionStorage -> ç›´æ¥URL'
                    ]
                },
                'r2-access-failed': {
                    title: 'R2å›¾ç‰‡è®¿é—®é—®é¢˜',
                    solutions: [
                        '1. å®ç°ç§»åŠ¨ç«¯ç½‘ç»œé‡è¯•æœºåˆ¶',
                        '2. æ·»åŠ CORSä»£ç†æˆ–ä¼˜åŒ–CORSé…ç½®',
                        '3. å®ç°ç½‘ç»œçŠ¶æ€æ£€æµ‹å’Œç¦»çº¿ç¼“å­˜',
                        '4. è®¾ç½®ç§»åŠ¨ç«¯ä¸“ç”¨çš„è¶…æ—¶æ—¶é—´'
                    ]
                },
                'memory-limit': {
                    title: 'ç§»åŠ¨ç«¯å†…å­˜é™åˆ¶',
                    solutions: [
                        '1. å®ç°å›¾ç‰‡å‹ç¼©å’Œè´¨é‡è°ƒèŠ‚',
                        '2. å‡å°‘ç§»åŠ¨ç«¯ç¼“å­˜æ•°é‡å’Œå¤§å°é™åˆ¶',
                        '3. å®ç°æ‡’åŠ è½½å’ŒæŒ‰éœ€æ¸…ç†',
                        '4. ä¼˜åŒ–æ•°æ®ç»“æ„å‡å°‘å†…å­˜å ç”¨'
                    ]
                }
            };
            
            const config = suggestions[type] || {
                title: 'é€šç”¨é—®é¢˜',
                solutions: [suggestion]
            };
            
            const currentContent = content.innerHTML;
            content.innerHTML = currentContent + `
                <div class="warning" style="margin: 10px 0;">
                    <h4>ğŸ”§ ${config.title}</h4>
                    ${config.solutions.map(s => `<div>â€¢ ${s}</div>`).join('')}
                </div>
            `;
        }
        
        // å¯¼å‡ºè¯Šæ–­æŠ¥å‘Š
        function exportDiagnosticReport() {
            log('ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š...');
            
            const report = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                viewport: `${window.innerWidth}x${window.innerHeight}`,
                devicePixelRatio: window.devicePixelRatio,
                online: navigator.onLine,
                diagnosticLog: document.getElementById('consoleOutput').textContent,
                conclusions: [
                    'æ‰‹æœºç«¯ç¼“å­˜å¤±æ•ˆçš„ä¸»è¦åŸå› å¯èƒ½åŒ…æ‹¬ï¼š',
                    '1. IndexedDBåœ¨ç§»åŠ¨ç«¯çš„è®¿é—®é™åˆ¶æˆ–é…é¢é—®é¢˜',
                    '2. ç§»åŠ¨ç«¯ä¸¥æ ¼çš„å†…å­˜é™åˆ¶å¯¼è‡´ç¼“å­˜è¢«é¢‘ç¹æ¸…ç†',
                    '3. ç½‘ç»œç¯å¢ƒå¯¼è‡´R2å›¾ç‰‡è·å–è¶…æ—¶æˆ–å¤±è´¥',
                    '4. getCachedImageå‡½æ•°åœ¨ç§»åŠ¨ç«¯ç¯å¢ƒä¸‹çš„ç‰¹æ®Šè¡Œä¸º',
                    '5. ç§»åŠ¨æµè§ˆå™¨çš„åå°é™åˆ¶å’Œèµ„æºå›æ”¶æœºåˆ¶'
                ]
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mobile-cache-diagnostic-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('è¯Šæ–­æŠ¥å‘Šå·²å¯¼å‡º', 'success');
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿›è¡Œç¯å¢ƒæ£€æµ‹
        window.addEventListener('load', () => {
            log('ç§»åŠ¨ç«¯ç¼“å­˜è¯Šæ–­å·¥å…·å¯åŠ¨');
            detectEnvironment();
        });
        
        // å…¶ä»–å ä½å‡½æ•°
        function testMemoryCache() {
            log('å†…å­˜ç¼“å­˜æµ‹è¯• - å¼€å‘ä¸­...');
        }
        
        function testIndexedDBCache() {
            log('IndexedDBç¼“å­˜æµ‹è¯• - å¼€å‘ä¸­...');
        }
        
        function testUnifiedCache() {
            log('ç»Ÿä¸€ç¼“å­˜æµ‹è¯• - å¼€å‘ä¸­...');
        }
        
        function testR2FetchWithTimeout() {
            log('R2è¶…æ—¶è·å–æµ‹è¯• - å¼€å‘ä¸­...');
        }
        
        function testCORSHeaders() {
            log('CORSå¤´éƒ¨æµ‹è¯• - å¼€å‘ä¸­...');
        }
        
        function testNetworkConnectivity() {
            log('ç½‘ç»œè¿æ¥æ€§æµ‹è¯• - å¼€å‘ä¸­...');
        }
        
        function testBrowserSpecificIssues() {
            log('æµè§ˆå™¨ç‰¹å®šé—®é¢˜æµ‹è¯• - å¼€å‘ä¸­...');
        }
        
        function testNetworkThrottling() {
            log('ç½‘ç»œèŠ‚æµæµ‹è¯• - å¼€å‘ä¸­...');
        }
        
        function testBackgroundTabLimitations() {
            log('åå°æ ‡ç­¾é™åˆ¶æµ‹è¯• - å¼€å‘ä¸­...');
        }
    </script>
</body>
</html>
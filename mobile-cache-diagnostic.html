<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📱 移动端缓存失效深度诊断</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 15px;
            line-height: 1.5;
            background-color: #f8f9fa;
        }
        .diagnostic-section {
            border: 2px solid #007bff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: white;
        }
        .error { border-color: #dc3545; background-color: #fff5f5; }
        .warning { border-color: #ffc107; background-color: #fffef5; }
        .success { border-color: #28a745; background-color: #f5fff5; }
        .info { border-color: #17a2b8; background-color: #f5fdff; }
        .console-output {
            background-color: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        @media (max-width: 600px) {
            .test-grid {
                grid-template-columns: 1fr;
            }
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        .status-info { background-color: #17a2b8; }
        .progress-bar {
            width: 100%;
            height: 6px;
            background-color: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin: 5px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <h1>📱 移动端缓存失效深度诊断工具</h1>
    <p><strong>目标</strong>: 深度分析手机端"✗ 无缓存"问题的根本原因</p>
    
    <!-- 环境检测 -->
    <div class="diagnostic-section info">
        <h3>📋 环境检测</h3>
        <div id="environmentInfo">检测中...</div>
    </div>
    
    <!-- 存储配额检测 -->
    <div class="diagnostic-section">
        <h3>💾 存储配额检测</h3>
        <div class="test-grid">
            <button onclick="checkStorageQuota()">检测存储配额</button>
            <button onclick="testIndexedDBAccess()">测试IndexedDB访问</button>
        </div>
        <div id="storageQuotaResults">点击测试按钮开始检测...</div>
    </div>
    
    <!-- 缓存层测试 -->
    <div class="diagnostic-section">
        <h3>🗂️ 多级缓存层测试</h3>
        <div class="test-grid">
            <button onclick="testMemoryCache()">测试内存缓存</button>
            <button onclick="testIndexedDBCache()">测试IndexedDB缓存</button>
            <button onclick="testUnifiedCache()">测试统一缓存</button>
            <button onclick="testGetCachedImage()">测试getCachedImage函数</button>
        </div>
        <div id="cacheLayerResults">点击测试按钮开始检测...</div>
    </div>
    
    <!-- R2图片访问测试 -->
    <div class="diagnostic-section">
        <h3>🌐 R2图片访问测试</h3>
        <div class="test-grid">
            <button onclick="testR2DirectAccess()">测试R2直接访问</button>
            <button onclick="testR2FetchWithTimeout()">测试R2超时获取</button>
            <button onclick="testCORSHeaders()">测试CORS头部</button>
            <button onclick="testNetworkConnectivity()">测试网络连接性</button>
        </div>
        <div id="r2AccessResults">点击测试按钮开始检测...</div>
    </div>
    
    <!-- 移动端特殊限制测试 -->
    <div class="diagnostic-section">
        <h3>📱 移动端特殊限制测试</h3>
        <div class="test-grid">
            <button onclick="testMobileMemoryLimits()">测试移动端内存限制</button>
            <button onclick="testBrowserSpecificIssues()">测试浏览器特定问题</button>
            <button onclick="testNetworkThrottling()">测试网络节流</button>
            <button onclick="testBackgroundTabLimitations()">测试后台标签限制</button>
        </div>
        <div id="mobileLimitResults">点击测试按钮开始检测...</div>
    </div>
    
    <!-- 实时控制台输出 -->
    <div class="diagnostic-section">
        <h3>📄 实时诊断日志</h3>
        <button onclick="clearConsole()">清空日志</button>
        <button onclick="exportDiagnosticReport()">导出诊断报告</button>
        <div id="consoleOutput" class="console-output">准备开始诊断...</div>
    </div>
    
    <!-- 修复建议 -->
    <div class="diagnostic-section" id="fixSuggestions" style="display: none;">
        <h3>🔧 修复建议</h3>
        <div id="fixSuggestionContent"></div>
    </div>

    <script>
        // 全局日志函数
        function log(message, type = 'info') {
            const console = document.getElementById('consoleOutput');
            const timestamp = new Date().toLocaleTimeString();
            const emoji = {
                info: '📝',
                success: '✅',
                warning: '⚠️',
                error: '❌',
                debug: '🐛'
            }[type] || '📝';
            
            console.textContent += `[${timestamp}] ${emoji} ${message}\n`;
            console.scrollTop = console.scrollHeight;
            console.log(`[MobileDiagnostic] ${message}`);
        }
        
        function clearConsole() {
            document.getElementById('consoleOutput').textContent = '';
        }
        
        // 环境检测
        function detectEnvironment() {
            const ua = navigator.userAgent;
            const info = {
                isMobile: /iPhone|iPad|iPod|Android/i.test(ua),
                isIOS: /iPad|iPhone|iPod/.test(ua),
                isIOSChrome: /iPad|iPhone|iPod/.test(ua) && /CriOS/.test(ua),
                isAndroid: /Android/.test(ua),
                isWechat: /MicroMessenger/.test(ua),
                isQQ: /QQ\//.test(ua),
                userAgent: ua,
                viewport: {
                    width: window.innerWidth,
                    height: window.innerHeight
                },
                devicePixelRatio: window.devicePixelRatio,
                online: navigator.onLine,
                cookieEnabled: navigator.cookieEnabled,
                language: navigator.language,
                platform: navigator.platform
            };
            
            document.getElementById('environmentInfo').innerHTML = `
                <div><span class="status-indicator status-${info.isMobile ? 'success' : 'warning'}"></span>移动设备: ${info.isMobile ? '是' : '否'}</div>
                <div><span class="status-indicator status-${info.isIOS ? 'info' : 'secondary'}"></span>iOS: ${info.isIOS ? '是' : '否'}</div>
                <div><span class="status-indicator status-${info.isIOSChrome ? 'warning' : 'secondary'}"></span>iOS Chrome: ${info.isIOSChrome ? '是' : '否'}</div>
                <div><span class="status-indicator status-${info.isAndroid ? 'info' : 'secondary'}"></span>Android: ${info.isAndroid ? '是' : '否'}</div>
                <div><span class="status-indicator status-${info.isWechat ? 'warning' : 'secondary'}"></span>微信浏览器: ${info.isWechat ? '是' : '否'}</div>
                <div><span class="status-indicator status-${info.online ? 'success' : 'error'}"></span>网络连接: ${info.online ? '在线' : '离线'}</div>
                <div>视窗大小: ${info.viewport.width}x${info.viewport.height}</div>
                <div>设备像素比: ${info.devicePixelRatio}</div>
                <div>用户代理: ${info.userAgent.substring(0, 80)}...</div>
            `;
            
            log(`环境检测完成 - 移动端: ${info.isMobile}, iOS: ${info.isIOS}, 在线: ${info.online}`);
            return info;
        }
        
        // 存储配额检测
        async function checkStorageQuota() {
            log('开始检测存储配额...');
            const results = document.getElementById('storageQuotaResults');
            
            try {
                if ('storage' in navigator && 'estimate' in navigator.storage) {
                    const estimate = await navigator.storage.estimate();
                    const usageGB = (estimate.usage / 1024 / 1024 / 1024).toFixed(2);
                    const quotaGB = (estimate.quota / 1024 / 1024 / 1024).toFixed(2);
                    const percentage = ((estimate.usage / estimate.quota) * 100).toFixed(1);
                    
                    results.innerHTML = `
                        <div class="success">
                            <h4>✅ 存储配额检测成功</h4>
                            <div>已使用: ${usageGB}GB</div>
                            <div>总配额: ${quotaGB}GB</div>
                            <div>使用率: ${percentage}%</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                    
                    log(`存储配额检测成功 - 使用率: ${percentage}%`);
                    
                    // 检查是否接近配额限制
                    if (parseFloat(percentage) > 90) {
                        log('警告: 存储配额使用率超过90%，可能导致缓存失败', 'warning');
                        showFixSuggestion('storage-quota-high', '存储配额不足，建议清理浏览器数据或增加配额');
                    }
                } else {
                    results.innerHTML = `
                        <div class="error">
                            <h4>❌ 不支持存储配额API</h4>
                            <div>当前浏览器不支持 navigator.storage.estimate()</div>
                        </div>
                    `;
                    log('存储配额API不支持', 'error');
                }
            } catch (error) {
                results.innerHTML = `
                    <div class="error">
                        <h4>❌ 存储配额检测失败</h4>
                        <div>错误: ${error.message}</div>
                    </div>
                `;
                log(`存储配额检测失败: ${error.message}`, 'error');
            }
        }
        
        // IndexedDB访问测试
        async function testIndexedDBAccess() {
            log('开始测试IndexedDB访问...');
            const results = document.getElementById('storageQuotaResults');
            
            try {
                // 尝试打开数据库
                const request = indexedDB.open('mobile-cache-diagnostic-test', 1);
                
                const dbPromise = new Promise((resolve, reject) => {
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        const store = db.createObjectStore('test', { keyPath: 'key' });
                        store.createIndex('timestamp', 'timestamp');
                    };
                });
                
                const db = await dbPromise;
                
                // 测试写入操作
                const writePromise = new Promise((resolve, reject) => {
                    const transaction = db.transaction(['test'], 'readwrite');
                    const store = transaction.objectStore('test');
                    const request = store.put({
                        key: 'diagnostic-test',
                        data: 'test-data-' + Date.now(),
                        timestamp: Date.now()
                    });
                    
                    transaction.oncomplete = () => resolve(true);
                    transaction.onerror = () => reject(transaction.error);
                });
                
                await writePromise;
                log('IndexedDB写入测试成功', 'success');
                
                // 测试读取操作
                const readPromise = new Promise((resolve, reject) => {
                    const transaction = db.transaction(['test'], 'readonly');
                    const store = transaction.objectStore('test');
                    const request = store.get('diagnostic-test');
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
                
                const data = await readPromise;
                log('IndexedDB读取测试成功', 'success');
                
                // 清理测试数据
                db.close();
                indexedDB.deleteDatabase('mobile-cache-diagnostic-test');
                
                const currentResults = results.innerHTML;
                results.innerHTML = currentResults + `
                    <div class="success">
                        <h4>✅ IndexedDB访问测试成功</h4>
                        <div>数据库打开: 成功</div>
                        <div>数据写入: 成功</div>
                        <div>数据读取: 成功</div>
                        <div>测试数据: ${JSON.stringify(data).substring(0, 50)}...</div>
                    </div>
                `;
                
            } catch (error) {
                const currentResults = results.innerHTML;
                results.innerHTML = currentResults + `
                    <div class="error">
                        <h4>❌ IndexedDB访问测试失败</h4>
                        <div>错误: ${error.message}</div>
                        <div>可能原因: 隐私模式、配额不足、浏览器限制</div>
                    </div>
                `;
                log(`IndexedDB访问测试失败: ${error.message}`, 'error');
                showFixSuggestion('indexeddb-failed', 'IndexedDB访问失败，建议实现sessionStorage备用方案');
            }
        }
        
        // 模拟getCachedImage函数测试
        async function testGetCachedImage() {
            log('开始测试getCachedImage函数模拟...');
            const results = document.getElementById('cacheLayerResults');
            
            // 模拟getCachedImage的核心逻辑
            const simulateGetCachedImage = async (url) => {
                log(`模拟getCachedImage调用: ${url.substring(0, 50)}...`);
                
                try {
                    // 1. 检查内存缓存（模拟）
                    log('检查L1内存缓存...');
                    const memoryKey = `cached_img_${url}`;
                    
                    // 2. 检查IndexedDB（模拟）
                    log('检查L2 IndexedDB缓存...');
                    
                    // 3. 模拟缓存未命中的情况
                    log('缓存未命中，返回null');
                    return null;
                    
                } catch (error) {
                    log(`getCachedImage模拟失败: ${error.message}`, 'error');
                    return null;
                }
            };
            
            // 测试几个典型的R2图片URL
            const testUrls = [
                'https://cdn.veo3video.me/thumbnails/test-image.png',
                'https://cdn.veo3video.me/thumbnails/56717878-bb2e-4d67-a3d3-e9a5bf00f79a-v2.png'
            ];
            
            let failedCount = 0;
            let successCount = 0;
            
            for (const url of testUrls) {
                const result = await simulateGetCachedImage(url);
                if (result === null) {
                    failedCount++;
                    log(`URL测试失败: ${url}`, 'warning');
                } else {
                    successCount++;
                    log(`URL测试成功: ${url}`, 'success');
                }
            }
            
            results.innerHTML = `
                <div class="${failedCount > successCount ? 'error' : 'success'}">
                    <h4>getCachedImage函数模拟测试结果</h4>
                    <div>成功: ${successCount}个</div>
                    <div>失败: ${failedCount}个</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${(successCount / testUrls.length) * 100}%"></div>
                    </div>
                    <div><strong>关键发现</strong>: ${failedCount > 0 ? 'getCachedImage在移动端大概率返回null' : '缓存函数工作正常'}</div>
                </div>
            `;
            
            if (failedCount > 0) {
                showFixSuggestion('getcached-failed', 'getCachedImage在移动端返回null，需要优化移动端缓存策略');
            }
        }
        
        // R2直接访问测试
        async function testR2DirectAccess() {
            log('开始测试R2图片直接访问...');
            const results = document.getElementById('r2AccessResults');
            
            const testUrl = 'https://cdn.veo3video.me/thumbnails/56717878-bb2e-4d67-a3d3-e9a5bf00f79a-v2.png';
            
            try {
                log('尝试获取R2图片...');
                const startTime = Date.now();
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch(testUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'image/*,*/*;q=0.8',
                        'Cache-Control': 'no-cache'
                    },
                    signal: controller.signal,
                    mode: 'cors',
                    credentials: 'omit'
                });
                
                clearTimeout(timeoutId);
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                if (response.ok) {
                    const contentLength = response.headers.get('content-length');
                    const contentType = response.headers.get('content-type');
                    
                    results.innerHTML = `
                        <div class="success">
                            <h4>✅ R2图片直接访问成功</h4>
                            <div>HTTP状态: ${response.status}</div>
                            <div>响应时间: ${duration}ms</div>
                            <div>内容类型: ${contentType}</div>
                            <div>文件大小: ${contentLength ? Math.round(contentLength/1024) + 'KB' : '未知'}</div>
                            <div>CORS头部: ${response.headers.get('access-control-allow-origin') || '无'}</div>
                        </div>
                    `;
                    log(`R2直接访问成功，耗时${duration}ms`, 'success');
                    
                    // 如果响应时间过长，给出警告
                    if (duration > 5000) {
                        log('警告: R2响应时间超过5秒，可能导致移动端超时', 'warning');
                        showFixSuggestion('r2-slow', 'R2响应较慢，建议优化超时处理和添加重试机制');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                results.innerHTML = `
                    <div class="error">
                        <h4>❌ R2图片直接访问失败</h4>
                        <div>错误: ${error.message}</div>
                        <div>可能原因: 网络问题、CORS限制、服务器问题</div>
                    </div>
                `;
                log(`R2直接访问失败: ${error.message}`, 'error');
                showFixSuggestion('r2-access-failed', 'R2图片访问失败，建议检查网络连接和CORS配置');
            }
        }
        
        // 移动端内存限制测试
        async function testMobileMemoryLimits() {
            log('开始测试移动端内存限制...');
            const results = document.getElementById('mobileLimitResults');
            
            try {
                // 模拟大量数据创建，测试内存限制
                log('创建大量测试数据...');
                const testData = [];
                let totalSize = 0;
                const maxTestSize = 20 * 1024 * 1024; // 20MB测试数据
                
                try {
                    while (totalSize < maxTestSize) {
                        const chunk = new Array(10000).fill('x').join(''); // ~10KB
                        testData.push(chunk);
                        totalSize += chunk.length * 2; // Unicode估算
                        
                        // 每1MB报告一次进度
                        if (totalSize % (1024 * 1024) === 0) {
                            log(`已创建${Math.round(totalSize / 1024 / 1024)}MB测试数据`);
                        }
                    }
                    
                    log('内存测试完成，移动端内存限制检查通过', 'success');
                    
                    results.innerHTML = `
                        <div class="success">
                            <h4>✅ 移动端内存限制测试</h4>
                            <div>测试数据大小: ${Math.round(totalSize / 1024 / 1024)}MB</div>
                            <div>内存分配: 成功</div>
                            <div>浏览器内存限制: 充足</div>
                        </div>
                    `;
                    
                    // 清理测试数据
                    testData.length = 0;
                    
                } catch (memoryError) {
                    log(`内存限制达到: ${memoryError.message}`, 'warning');
                    results.innerHTML = `
                        <div class="warning">
                            <h4>⚠️ 移动端内存限制检测</h4>
                            <div>达到内存限制: ${Math.round(totalSize / 1024 / 1024)}MB</div>
                            <div>错误: ${memoryError.message}</div>
                            <div>影响: 可能导致大图片缓存失败</div>
                        </div>
                    `;
                    showFixSuggestion('memory-limit', '移动端内存限制，建议压缩图片或减少缓存大小');
                }
                
            } catch (error) {
                results.innerHTML = `
                    <div class="error">
                        <h4>❌ 内存限制测试失败</h4>
                        <div>错误: ${error.message}</div>
                    </div>
                `;
                log(`内存限制测试失败: ${error.message}`, 'error');
            }
        }
        
        // 显示修复建议
        function showFixSuggestion(type, suggestion) {
            const container = document.getElementById('fixSuggestions');
            const content = document.getElementById('fixSuggestionContent');
            
            container.style.display = 'block';
            
            const suggestions = {
                'storage-quota-high': {
                    title: '存储配额不足',
                    solutions: [
                        '1. 实现缓存大小限制和LRU清理策略',
                        '2. 压缩图片数据减少存储占用',
                        '3. 设置合理的TTL自动清理过期数据',
                        '4. 提供用户清理缓存的选项'
                    ]
                },
                'indexeddb-failed': {
                    title: 'IndexedDB访问失败',
                    solutions: [
                        '1. 实现sessionStorage作为备用存储方案',
                        '2. 添加IndexedDB可用性检测',
                        '3. 降级到纯内存缓存',
                        '4. 检测隐私模式并提供用户提示'
                    ]
                },
                'getcached-failed': {
                    title: 'getCachedImage函数移动端失效',
                    solutions: [
                        '1. 实现移动端专用的缓存读取逻辑',
                        '2. 添加更多错误处理和重试机制',
                        '3. 优化移动端的缓存键生成策略',
                        '4. 实现渐进式降级：IndexedDB -> sessionStorage -> 直接URL'
                    ]
                },
                'r2-access-failed': {
                    title: 'R2图片访问问题',
                    solutions: [
                        '1. 实现移动端网络重试机制',
                        '2. 添加CORS代理或优化CORS配置',
                        '3. 实现网络状态检测和离线缓存',
                        '4. 设置移动端专用的超时时间'
                    ]
                },
                'memory-limit': {
                    title: '移动端内存限制',
                    solutions: [
                        '1. 实现图片压缩和质量调节',
                        '2. 减少移动端缓存数量和大小限制',
                        '3. 实现懒加载和按需清理',
                        '4. 优化数据结构减少内存占用'
                    ]
                }
            };
            
            const config = suggestions[type] || {
                title: '通用问题',
                solutions: [suggestion]
            };
            
            const currentContent = content.innerHTML;
            content.innerHTML = currentContent + `
                <div class="warning" style="margin: 10px 0;">
                    <h4>🔧 ${config.title}</h4>
                    ${config.solutions.map(s => `<div>• ${s}</div>`).join('')}
                </div>
            `;
        }
        
        // 导出诊断报告
        function exportDiagnosticReport() {
            log('生成诊断报告...');
            
            const report = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                viewport: `${window.innerWidth}x${window.innerHeight}`,
                devicePixelRatio: window.devicePixelRatio,
                online: navigator.onLine,
                diagnosticLog: document.getElementById('consoleOutput').textContent,
                conclusions: [
                    '手机端缓存失效的主要原因可能包括：',
                    '1. IndexedDB在移动端的访问限制或配额问题',
                    '2. 移动端严格的内存限制导致缓存被频繁清理',
                    '3. 网络环境导致R2图片获取超时或失败',
                    '4. getCachedImage函数在移动端环境下的特殊行为',
                    '5. 移动浏览器的后台限制和资源回收机制'
                ]
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mobile-cache-diagnostic-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('诊断报告已导出', 'success');
        }
        
        // 页面加载时自动进行环境检测
        window.addEventListener('load', () => {
            log('移动端缓存诊断工具启动');
            detectEnvironment();
        });
        
        // 其他占位函数
        function testMemoryCache() {
            log('内存缓存测试 - 开发中...');
        }
        
        function testIndexedDBCache() {
            log('IndexedDB缓存测试 - 开发中...');
        }
        
        function testUnifiedCache() {
            log('统一缓存测试 - 开发中...');
        }
        
        function testR2FetchWithTimeout() {
            log('R2超时获取测试 - 开发中...');
        }
        
        function testCORSHeaders() {
            log('CORS头部测试 - 开发中...');
        }
        
        function testNetworkConnectivity() {
            log('网络连接性测试 - 开发中...');
        }
        
        function testBrowserSpecificIssues() {
            log('浏览器特定问题测试 - 开发中...');
        }
        
        function testNetworkThrottling() {
            log('网络节流测试 - 开发中...');
        }
        
        function testBackgroundTabLimitations() {
            log('后台标签限制测试 - 开发中...');
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>测试标题解析 - Title Parsing Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-case {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-case h3 {
      margin-top: 0;
      color: #333;
    }
    .input {
      background: #f9f9f9;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-family: monospace;
      font-size: 12px;
      word-break: break-all;
    }
    .output {
      background: #e8f5e9;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-weight: bold;
      color: #2e7d32;
    }
    .error {
      background: #ffebee;
      color: #c62828;
    }
    .lang-selector {
      margin: 10px 0;
    }
    .lang-selector select {
      padding: 5px 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h1>🧪 标题解析测试 - Title Parsing Test</h1>

  <div class="test-case">
    <h3>测试案例 1: 多语言JSON对象（正常情况）</h3>
    <div class="input" id="input1"></div>
    <div class="lang-selector">
      语言 / Language:
      <select id="lang1" onchange="runTest1()">
        <option value="zh">中文 (zh)</option>
        <option value="en">English (en)</option>
        <option value="ja">日本語 (ja)</option>
        <option value="ko">한국어 (ko)</option>
      </select>
    </div>
    <div class="output" id="output1"></div>
  </div>

  <div class="test-case">
    <h3>测试案例 2: 损坏的JSON对象（问题场景）</h3>
    <div class="input" id="input2"></div>
    <div class="lang-selector">
      语言 / Language:
      <select id="lang2" onchange="runTest2()">
        <option value="zh">中文 (zh)</option>
        <option value="en">English (en)</option>
        <option value="ja">日本語 (ja)</option>
      </select>
    </div>
    <div class="output" id="output2"></div>
  </div>

  <div class="test-case">
    <h3>测试案例 3: 普通字符串标题</h3>
    <div class="input" id="input3"></div>
    <div class="lang-selector">
      语言 / Language:
      <select id="lang3" onchange="runTest3()">
        <option value="zh">中文 (zh)</option>
        <option value="en">English (en)</option>
      </select>
    </div>
    <div class="output" id="output3"></div>
  </div>

  <script type="module">
    // 从项目中复制的 parseTitle 函数
    function parseTitle(title, currentLocale = 'en', fallbackText = 'Untitled Video') {
      if (!title) {
        return fallbackText
      }

      // 如果是普通字符串且不包含JSON标记，直接返回
      if (typeof title === 'string' && !title.includes('{') && !title.includes('"')) {
        return title.trim()
      }

      try {
        const parsed = typeof title === 'string' ? JSON.parse(title) : title

        if (typeof parsed === 'object' && parsed !== null) {
          if (parsed[currentLocale]) {
            return parsed[currentLocale].trim()
          }

          const fallbackLanguages = ['en', 'zh', 'ja', 'ko', 'es']
          for (const lang of fallbackLanguages) {
            if (parsed[lang]) {
              return parsed[lang].trim()
            }
          }

          const firstAvailable = Object.values(parsed).find(val => val && val.trim())
          if (firstAvailable) {
            return firstAvailable.trim()
          }
        }
      } catch (error) {
        console.warn('Failed to parse title JSON:', error)

        // 如果看起来像损坏的JSON（包含 JSON 片段），尝试提取有用信息
        if (title.includes('{') && title.includes('"')) {
          // 尝试提取 JSON 部分
          const jsonMatch = title.match(/\{[^}]+\}/)
          if (jsonMatch) {
            try {
              // 尝试解析提取的 JSON 部分
              const parsed = JSON.parse(jsonMatch[0])
              if (typeof parsed === 'object' && parsed !== null) {
                // 优先返回当前语言
                if (parsed[currentLocale]) {
                  return parsed[currentLocale].trim()
                }
                // 回退到英语或中文
                const fallbackLanguages = ['en', 'zh', 'ja', 'ko', 'es']
                for (const lang of fallbackLanguages) {
                  if (parsed[lang]) {
                    return parsed[lang].trim()
                  }
                }
                // 返回第一个可用值
                const firstAvailable = Object.values(parsed).find(val => val && typeof val === 'string' && val.trim())
                if (firstAvailable && typeof firstAvailable === 'string') {
                  return firstAvailable.trim()
                }
              }
            } catch {
              // JSON 部分也解析失败，继续下面的处理
            }
          }

          // 如果提取 JSON 失败，尝试通过正则提取引号中的值
          const matches = title.match(/"([^"]+)"/g)
          if (matches && matches.length > 0) {
            // 跳过语言代码键名（如 "en", "zh"），取第一个实际的值
            const values = matches
              .map(m => m.replace(/"/g, ''))
              .filter(val =>
                val.length > 3 &&
                !['en', 'zh', 'ja', 'ko', 'es', 'fr', 'de', 'ar'].includes(val)
              )

            if (values.length > 0) {
              return values[0].trim()
            }
          }
        }

        // 最后的回退：清理 JSON 字符并返回
        const cleaned = title
          .replace(/\{[^}]*\}/g, '') // 移除所有 JSON 对象
          .replace(/[{}"\[\]]/g, '') // 移除 JSON 字符
          .replace(/[a-z]{2}:/gi, '') // 移除语言代码
          .trim()

        return cleaned || fallbackText
      }

      return fallbackText
    }

    // 测试数据
    const testCases = {
      case1: {
        "en": "Surveillance Animal Trampoline",
        "zh": "监控动物蹦床",
        "ja": "監視動物トランポリン",
        "ko": "감시 동물 트램폴린"
      },
      case2: '有趣的{"en":"Surveillance Animal Trampoline","zh":"监控动物蹦床"}',
      case3: '精彩的AI视频内容'
    }

    // 测试案例 1
    window.runTest1 = function() {
      const input = JSON.stringify(testCases.case1, null, 2)
      const lang = document.getElementById('lang1').value
      const result = parseTitle(JSON.stringify(testCases.case1), lang)

      document.getElementById('input1').textContent = input
      document.getElementById('output1').textContent = `解析结果: ${result}`
    }

    // 测试案例 2
    window.runTest2 = function() {
      const input = testCases.case2
      const lang = document.getElementById('lang2').value
      const result = parseTitle(input, lang)

      document.getElementById('input2').textContent = input
      document.getElementById('output2').textContent = `解析结果: ${result}`
      document.getElementById('output2').className = result.includes('{') ? 'output error' : 'output'
    }

    // 测试案例 3
    window.runTest3 = function() {
      const input = testCases.case3
      const lang = document.getElementById('lang3').value
      const result = parseTitle(input, lang)

      document.getElementById('input3').textContent = input
      document.getElementById('output3').textContent = `解析结果: ${result}`
    }

    // 初始化所有测试
    runTest1()
    runTest2()
    runTest3()
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æµ‹è¯•æ ‡é¢˜è§£æ - Title Parsing Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-case {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-case h3 {
      margin-top: 0;
      color: #333;
    }
    .input {
      background: #f9f9f9;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-family: monospace;
      font-size: 12px;
      word-break: break-all;
    }
    .output {
      background: #e8f5e9;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-weight: bold;
      color: #2e7d32;
    }
    .error {
      background: #ffebee;
      color: #c62828;
    }
    .lang-selector {
      margin: 10px 0;
    }
    .lang-selector select {
      padding: 5px 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h1>ğŸ§ª æ ‡é¢˜è§£ææµ‹è¯• - Title Parsing Test</h1>

  <div class="test-case">
    <h3>æµ‹è¯•æ¡ˆä¾‹ 1: å¤šè¯­è¨€JSONå¯¹è±¡ï¼ˆæ­£å¸¸æƒ…å†µï¼‰</h3>
    <div class="input" id="input1"></div>
    <div class="lang-selector">
      è¯­è¨€ / Language:
      <select id="lang1" onchange="runTest1()">
        <option value="zh">ä¸­æ–‡ (zh)</option>
        <option value="en">English (en)</option>
        <option value="ja">æ—¥æœ¬èª (ja)</option>
        <option value="ko">í•œêµ­ì–´ (ko)</option>
      </select>
    </div>
    <div class="output" id="output1"></div>
  </div>

  <div class="test-case">
    <h3>æµ‹è¯•æ¡ˆä¾‹ 2: æŸåçš„JSONå¯¹è±¡ï¼ˆé—®é¢˜åœºæ™¯ï¼‰</h3>
    <div class="input" id="input2"></div>
    <div class="lang-selector">
      è¯­è¨€ / Language:
      <select id="lang2" onchange="runTest2()">
        <option value="zh">ä¸­æ–‡ (zh)</option>
        <option value="en">English (en)</option>
        <option value="ja">æ—¥æœ¬èª (ja)</option>
      </select>
    </div>
    <div class="output" id="output2"></div>
  </div>

  <div class="test-case">
    <h3>æµ‹è¯•æ¡ˆä¾‹ 3: æ™®é€šå­—ç¬¦ä¸²æ ‡é¢˜</h3>
    <div class="input" id="input3"></div>
    <div class="lang-selector">
      è¯­è¨€ / Language:
      <select id="lang3" onchange="runTest3()">
        <option value="zh">ä¸­æ–‡ (zh)</option>
        <option value="en">English (en)</option>
      </select>
    </div>
    <div class="output" id="output3"></div>
  </div>

  <script type="module">
    // ä»é¡¹ç›®ä¸­å¤åˆ¶çš„ parseTitle å‡½æ•°
    function parseTitle(title, currentLocale = 'en', fallbackText = 'Untitled Video') {
      if (!title) {
        return fallbackText
      }

      // å¦‚æœæ˜¯æ™®é€šå­—ç¬¦ä¸²ä¸”ä¸åŒ…å«JSONæ ‡è®°ï¼Œç›´æ¥è¿”å›
      if (typeof title === 'string' && !title.includes('{') && !title.includes('"')) {
        return title.trim()
      }

      try {
        const parsed = typeof title === 'string' ? JSON.parse(title) : title

        if (typeof parsed === 'object' && parsed !== null) {
          if (parsed[currentLocale]) {
            return parsed[currentLocale].trim()
          }

          const fallbackLanguages = ['en', 'zh', 'ja', 'ko', 'es']
          for (const lang of fallbackLanguages) {
            if (parsed[lang]) {
              return parsed[lang].trim()
            }
          }

          const firstAvailable = Object.values(parsed).find(val => val && val.trim())
          if (firstAvailable) {
            return firstAvailable.trim()
          }
        }
      } catch (error) {
        console.warn('Failed to parse title JSON:', error)

        // å¦‚æœçœ‹èµ·æ¥åƒæŸåçš„JSONï¼ˆåŒ…å« JSON ç‰‡æ®µï¼‰ï¼Œå°è¯•æå–æœ‰ç”¨ä¿¡æ¯
        if (title.includes('{') && title.includes('"')) {
          // å°è¯•æå– JSON éƒ¨åˆ†
          const jsonMatch = title.match(/\{[^}]+\}/)
          if (jsonMatch) {
            try {
              // å°è¯•è§£ææå–çš„ JSON éƒ¨åˆ†
              const parsed = JSON.parse(jsonMatch[0])
              if (typeof parsed === 'object' && parsed !== null) {
                // ä¼˜å…ˆè¿”å›å½“å‰è¯­è¨€
                if (parsed[currentLocale]) {
                  return parsed[currentLocale].trim()
                }
                // å›é€€åˆ°è‹±è¯­æˆ–ä¸­æ–‡
                const fallbackLanguages = ['en', 'zh', 'ja', 'ko', 'es']
                for (const lang of fallbackLanguages) {
                  if (parsed[lang]) {
                    return parsed[lang].trim()
                  }
                }
                // è¿”å›ç¬¬ä¸€ä¸ªå¯ç”¨å€¼
                const firstAvailable = Object.values(parsed).find(val => val && typeof val === 'string' && val.trim())
                if (firstAvailable && typeof firstAvailable === 'string') {
                  return firstAvailable.trim()
                }
              }
            } catch {
              // JSON éƒ¨åˆ†ä¹Ÿè§£æå¤±è´¥ï¼Œç»§ç»­ä¸‹é¢çš„å¤„ç†
            }
          }

          // å¦‚æœæå– JSON å¤±è´¥ï¼Œå°è¯•é€šè¿‡æ­£åˆ™æå–å¼•å·ä¸­çš„å€¼
          const matches = title.match(/"([^"]+)"/g)
          if (matches && matches.length > 0) {
            // è·³è¿‡è¯­è¨€ä»£ç é”®åï¼ˆå¦‚ "en", "zh"ï¼‰ï¼Œå–ç¬¬ä¸€ä¸ªå®é™…çš„å€¼
            const values = matches
              .map(m => m.replace(/"/g, ''))
              .filter(val =>
                val.length > 3 &&
                !['en', 'zh', 'ja', 'ko', 'es', 'fr', 'de', 'ar'].includes(val)
              )

            if (values.length > 0) {
              return values[0].trim()
            }
          }
        }

        // æœ€åçš„å›é€€ï¼šæ¸…ç† JSON å­—ç¬¦å¹¶è¿”å›
        const cleaned = title
          .replace(/\{[^}]*\}/g, '') // ç§»é™¤æ‰€æœ‰ JSON å¯¹è±¡
          .replace(/[{}"\[\]]/g, '') // ç§»é™¤ JSON å­—ç¬¦
          .replace(/[a-z]{2}:/gi, '') // ç§»é™¤è¯­è¨€ä»£ç 
          .trim()

        return cleaned || fallbackText
      }

      return fallbackText
    }

    // æµ‹è¯•æ•°æ®
    const testCases = {
      case1: {
        "en": "Surveillance Animal Trampoline",
        "zh": "ç›‘æ§åŠ¨ç‰©è¹¦åºŠ",
        "ja": "ç›£è¦–å‹•ç‰©ãƒˆãƒ©ãƒ³ãƒãƒªãƒ³",
        "ko": "ê°ì‹œ ë™ë¬¼ íŠ¸ë¨í´ë¦°"
      },
      case2: 'æœ‰è¶£çš„{"en":"Surveillance Animal Trampoline","zh":"ç›‘æ§åŠ¨ç‰©è¹¦åºŠ"}',
      case3: 'ç²¾å½©çš„AIè§†é¢‘å†…å®¹'
    }

    // æµ‹è¯•æ¡ˆä¾‹ 1
    window.runTest1 = function() {
      const input = JSON.stringify(testCases.case1, null, 2)
      const lang = document.getElementById('lang1').value
      const result = parseTitle(JSON.stringify(testCases.case1), lang)

      document.getElementById('input1').textContent = input
      document.getElementById('output1').textContent = `è§£æç»“æœ: ${result}`
    }

    // æµ‹è¯•æ¡ˆä¾‹ 2
    window.runTest2 = function() {
      const input = testCases.case2
      const lang = document.getElementById('lang2').value
      const result = parseTitle(input, lang)

      document.getElementById('input2').textContent = input
      document.getElementById('output2').textContent = `è§£æç»“æœ: ${result}`
      document.getElementById('output2').className = result.includes('{') ? 'output error' : 'output'
    }

    // æµ‹è¯•æ¡ˆä¾‹ 3
    window.runTest3 = function() {
      const input = testCases.case3
      const lang = document.getElementById('lang3').value
      const result = parseTitle(input, lang)

      document.getElementById('input3').textContent = input
      document.getElementById('output3').textContent = `è§£æç»“æœ: ${result}`
    }

    // åˆå§‹åŒ–æ‰€æœ‰æµ‹è¯•
    runTest1()
    runTest2()
    runTest3()
  </script>
</body>
</html>

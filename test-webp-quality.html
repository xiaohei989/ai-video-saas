<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebP质量测试 - 640x360 质量0.9</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .quality-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .quality-item {
            border: 1px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }
        .quality-item img {
            width: 100%;
            height: auto;
            display: block;
        }
        .quality-info {
            padding: 15px;
            background: #f8f9fa;
        }
        .size-info {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }
        .format-info {
            color: #28a745;
            font-size: 0.9em;
        }
        #testResults {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .stats-table th, .stats-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        .stats-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🖼️ WebP质量测试：640x360 质量0.9</h1>
        
        <div class="test-section">
            <h2>📊 测试说明</h2>
            <p>本测试将生成不同质量和格式的640x360缩略图，比较文件大小和视觉质量：</p>
            <ul>
                <li><strong>WebP 质量0.9</strong> - 目前系统使用的配置</li>
                <li><strong>WebP 质量0.8</strong> - 对比参考</li>
                <li><strong>JPEG 质量0.9</strong> - 对比参考</li>
                <li><strong>JPEG 质量0.8</strong> - 对比参考</li>
            </ul>
        </div>

        <div class="test-section">
            <h2>🎬 视频源</h2>
            <video id="sourceVideo" controls muted style="width: 100%; max-width: 640px;">
                <source src="https://cdn.veo3video.me/videos/fd2ee467-3d17-4ac4-aff4-dc3ecfce398a.mp4" type="video/mp4">
                您的浏览器不支持视频播放
            </video>
            <p><small>测试视频：来自实际用户视频</small></p>
        </div>

        <div class="test-section">
            <button onclick="startQualityTest()">🚀 开始质量测试</button>
            <div id="testResults"></div>
        </div>

        <div class="test-section">
            <h2>📈 质量对比结果</h2>
            <div class="quality-comparison" id="qualityComparison">
                <!-- 动态生成的质量对比图片 -->
            </div>
        </div>

        <div class="test-section">
            <h2>📊 文件大小统计</h2>
            <table class="stats-table" id="statsTable">
                <thead>
                    <tr>
                        <th>格式</th>
                        <th>质量</th>
                        <th>文件大小</th>
                        <th>Base64长度</th>
                        <th>压缩比</th>
                        <th>视觉质量评估</th>
                    </tr>
                </thead>
                <tbody id="statsBody">
                    <!-- 动态生成 -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let testResults = [];

        async function startQualityTest() {
            const video = document.getElementById('sourceVideo');
            const resultsDiv = document.getElementById('testResults');
            const comparisonDiv = document.getElementById('qualityComparison');
            const statsBody = document.getElementById('statsBody');
            
            resultsDiv.innerHTML = '<p>🔄 正在进行质量测试...</p>';
            
            try {
                // 等待视频加载
                await new Promise((resolve) => {
                    if (video.readyState >= 2) {
                        resolve();
                    } else {
                        video.addEventListener('loadedmetadata', resolve, { once: true });
                        video.load();
                    }
                });

                // 跳转到0.1秒处获取有效画面
                video.currentTime = 0.1;
                await new Promise(resolve => {
                    video.addEventListener('seeked', resolve, { once: true });
                });

                // 测试配置
                const testConfigs = [
                    { format: 'webp', quality: 0.9, name: 'WebP 0.9 (系统配置)' },
                    { format: 'webp', quality: 0.8, name: 'WebP 0.8' },
                    { format: 'jpeg', quality: 0.9, name: 'JPEG 0.9' },
                    { format: 'jpeg', quality: 0.8, name: 'JPEG 0.8' }
                ];

                testResults = [];
                comparisonDiv.innerHTML = '';
                statsBody.innerHTML = '';

                for (const config of testConfigs) {
                    const result = await generateThumbnail(video, config);
                    testResults.push(result);
                    
                    // 创建对比展示
                    createQualityItem(result, comparisonDiv);
                    
                    // 更新统计表格
                    addStatsRow(result, statsBody);
                }

                // 显示总结
                showTestSummary();

            } catch (error) {
                resultsDiv.innerHTML = `<p style="color: red;">❌ 测试失败: ${error.message}</p>`;
                console.error('测试失败:', error);
            }
        }

        async function generateThumbnail(video, config) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // 设置目标尺寸：640x360
            canvas.width = 640;
            canvas.height = 360;
            
            // 绘制视频帧
            ctx.drawImage(video, 0, 0, 640, 360);
            
            // 生成不同格式和质量的缩略图
            const dataUrl = await new Promise((resolve, reject) => {
                if (config.format === 'webp') {
                    canvas.toBlob((blob) => {
                        if (blob) {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(blob);
                        } else {
                            reject(new Error('WebP生成失败'));
                        }
                    }, 'image/webp', config.quality);
                } else {
                    const url = canvas.toDataURL(`image/${config.format}`, config.quality);
                    resolve(url);
                }
            });

            // 计算文件信息
            const base64Data = dataUrl.split(',')[1];
            const fileSizeBytes = Math.round(base64Data.length * 0.75);
            const fileSizeKB = (fileSizeBytes / 1024).toFixed(2);

            return {
                name: config.name,
                format: config.format,
                quality: config.quality,
                dataUrl,
                base64Length: base64Data.length,
                fileSizeBytes,
                fileSizeKB: parseFloat(fileSizeKB),
                compressionRatio: ((640 * 360 * 3 - fileSizeBytes) / (640 * 360 * 3) * 100).toFixed(1)
            };
        }

        function createQualityItem(result, container) {
            const item = document.createElement('div');
            item.className = 'quality-item';
            
            const img = document.createElement('img');
            img.src = result.dataUrl;
            img.alt = result.name;
            
            const info = document.createElement('div');
            info.className = 'quality-info';
            
            info.innerHTML = `
                <div class="size-info">${result.fileSizeKB} KB</div>
                <div class="format-info">${result.name}</div>
                <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                    压缩比: ${result.compressionRatio}%<br>
                    Base64长度: ${result.base64Length.toLocaleString()}
                </div>
            `;
            
            item.appendChild(img);
            item.appendChild(info);
            container.appendChild(item);
        }

        function addStatsRow(result, tbody) {
            const row = document.createElement('tr');
            
            // 视觉质量评估
            let qualityAssessment = '';
            if (result.format === 'webp' && result.quality >= 0.9) {
                qualityAssessment = '🌟 优秀';
            } else if (result.format === 'webp' && result.quality >= 0.8) {
                qualityAssessment = '✅ 很好';
            } else if (result.format === 'jpeg' && result.quality >= 0.9) {
                qualityAssessment = '👍 良好';
            } else {
                qualityAssessment = '⚠️ 一般';
            }
            
            row.innerHTML = `
                <td>${result.format.toUpperCase()}</td>
                <td>${result.quality}</td>
                <td><strong>${result.fileSizeKB} KB</strong></td>
                <td>${result.base64Length.toLocaleString()}</td>
                <td>${result.compressionRatio}%</td>
                <td>${qualityAssessment}</td>
            `;
            
            tbody.appendChild(row);
        }

        function showTestSummary() {
            const resultsDiv = document.getElementById('testResults');
            
            // 找到系统配置的结果
            const systemConfig = testResults.find(r => r.format === 'webp' && r.quality === 0.9);
            const bestJpeg = testResults.find(r => r.format === 'jpeg' && r.quality === 0.9);
            
            if (systemConfig) {
                const savings = bestJpeg ? ((bestJpeg.fileSizeKB - systemConfig.fileSizeKB) / bestJpeg.fileSizeKB * 100).toFixed(1) : 0;
                
                resultsDiv.innerHTML = `
                    <h3>🎯 系统配置分析结果</h3>
                    <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; padding: 15px;">
                        <p><strong>当前配置 (WebP 640x360 质量0.9):</strong></p>
                        <ul>
                            <li>📏 分辨率: 640x360 (高清)</li>
                            <li>📦 文件大小: <strong>${systemConfig.fileSizeKB} KB</strong></li>
                            <li>🎨 格式: WebP (现代浏览器优化)</li>
                            <li>⚡ 压缩比: ${systemConfig.compressionRatio}%</li>
                            ${bestJpeg ? `<li>💾 相比JPEG节省: ${savings}% 空间</li>` : ''}
                        </ul>
                        <p><strong>质量评估:</strong> 🌟 优秀 - 高质量、小文件、快加载</p>
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px; font-size: 0.9em;">
                        💡 <strong>建议:</strong> 当前配置已经是最佳平衡点，既保证了视觉质量，又控制了文件大小。
                    </div>
                `;
            }
        }

        // 页面加载时自动开始测试
        window.addEventListener('load', () => {
            const video = document.getElementById('sourceVideo');
            // 给视频一些时间加载
            setTimeout(() => {
                startQualityTest();
            }, 1000);
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebPè´¨é‡æµ‹è¯• - 640x360 è´¨é‡0.9</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .quality-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .quality-item {
            border: 1px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }
        .quality-item img {
            width: 100%;
            height: auto;
            display: block;
        }
        .quality-info {
            padding: 15px;
            background: #f8f9fa;
        }
        .size-info {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }
        .format-info {
            color: #28a745;
            font-size: 0.9em;
        }
        #testResults {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .stats-table th, .stats-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        .stats-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ–¼ï¸ WebPè´¨é‡æµ‹è¯•ï¼š640x360 è´¨é‡0.9</h1>
        
        <div class="test-section">
            <h2>ğŸ“Š æµ‹è¯•è¯´æ˜</h2>
            <p>æœ¬æµ‹è¯•å°†ç”Ÿæˆä¸åŒè´¨é‡å’Œæ ¼å¼çš„640x360ç¼©ç•¥å›¾ï¼Œæ¯”è¾ƒæ–‡ä»¶å¤§å°å’Œè§†è§‰è´¨é‡ï¼š</p>
            <ul>
                <li><strong>WebP è´¨é‡0.9</strong> - ç›®å‰ç³»ç»Ÿä½¿ç”¨çš„é…ç½®</li>
                <li><strong>WebP è´¨é‡0.8</strong> - å¯¹æ¯”å‚è€ƒ</li>
                <li><strong>JPEG è´¨é‡0.9</strong> - å¯¹æ¯”å‚è€ƒ</li>
                <li><strong>JPEG è´¨é‡0.8</strong> - å¯¹æ¯”å‚è€ƒ</li>
            </ul>
        </div>

        <div class="test-section">
            <h2>ğŸ¬ è§†é¢‘æº</h2>
            <video id="sourceVideo" controls muted style="width: 100%; max-width: 640px;">
                <source src="https://cdn.veo3video.me/videos/fd2ee467-3d17-4ac4-aff4-dc3ecfce398a.mp4" type="video/mp4">
                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
            </video>
            <p><small>æµ‹è¯•è§†é¢‘ï¼šæ¥è‡ªå®é™…ç”¨æˆ·è§†é¢‘</small></p>
        </div>

        <div class="test-section">
            <button onclick="startQualityTest()">ğŸš€ å¼€å§‹è´¨é‡æµ‹è¯•</button>
            <div id="testResults"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ“ˆ è´¨é‡å¯¹æ¯”ç»“æœ</h2>
            <div class="quality-comparison" id="qualityComparison">
                <!-- åŠ¨æ€ç”Ÿæˆçš„è´¨é‡å¯¹æ¯”å›¾ç‰‡ -->
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ“Š æ–‡ä»¶å¤§å°ç»Ÿè®¡</h2>
            <table class="stats-table" id="statsTable">
                <thead>
                    <tr>
                        <th>æ ¼å¼</th>
                        <th>è´¨é‡</th>
                        <th>æ–‡ä»¶å¤§å°</th>
                        <th>Base64é•¿åº¦</th>
                        <th>å‹ç¼©æ¯”</th>
                        <th>è§†è§‰è´¨é‡è¯„ä¼°</th>
                    </tr>
                </thead>
                <tbody id="statsBody">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let testResults = [];

        async function startQualityTest() {
            const video = document.getElementById('sourceVideo');
            const resultsDiv = document.getElementById('testResults');
            const comparisonDiv = document.getElementById('qualityComparison');
            const statsBody = document.getElementById('statsBody');
            
            resultsDiv.innerHTML = '<p>ğŸ”„ æ­£åœ¨è¿›è¡Œè´¨é‡æµ‹è¯•...</p>';
            
            try {
                // ç­‰å¾…è§†é¢‘åŠ è½½
                await new Promise((resolve) => {
                    if (video.readyState >= 2) {
                        resolve();
                    } else {
                        video.addEventListener('loadedmetadata', resolve, { once: true });
                        video.load();
                    }
                });

                // è·³è½¬åˆ°0.1ç§’å¤„è·å–æœ‰æ•ˆç”»é¢
                video.currentTime = 0.1;
                await new Promise(resolve => {
                    video.addEventListener('seeked', resolve, { once: true });
                });

                // æµ‹è¯•é…ç½®
                const testConfigs = [
                    { format: 'webp', quality: 0.9, name: 'WebP 0.9 (ç³»ç»Ÿé…ç½®)' },
                    { format: 'webp', quality: 0.8, name: 'WebP 0.8' },
                    { format: 'jpeg', quality: 0.9, name: 'JPEG 0.9' },
                    { format: 'jpeg', quality: 0.8, name: 'JPEG 0.8' }
                ];

                testResults = [];
                comparisonDiv.innerHTML = '';
                statsBody.innerHTML = '';

                for (const config of testConfigs) {
                    const result = await generateThumbnail(video, config);
                    testResults.push(result);
                    
                    // åˆ›å»ºå¯¹æ¯”å±•ç¤º
                    createQualityItem(result, comparisonDiv);
                    
                    // æ›´æ–°ç»Ÿè®¡è¡¨æ ¼
                    addStatsRow(result, statsBody);
                }

                // æ˜¾ç¤ºæ€»ç»“
                showTestSummary();

            } catch (error) {
                resultsDiv.innerHTML = `<p style="color: red;">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</p>`;
                console.error('æµ‹è¯•å¤±è´¥:', error);
            }
        }

        async function generateThumbnail(video, config) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // è®¾ç½®ç›®æ ‡å°ºå¯¸ï¼š640x360
            canvas.width = 640;
            canvas.height = 360;
            
            // ç»˜åˆ¶è§†é¢‘å¸§
            ctx.drawImage(video, 0, 0, 640, 360);
            
            // ç”Ÿæˆä¸åŒæ ¼å¼å’Œè´¨é‡çš„ç¼©ç•¥å›¾
            const dataUrl = await new Promise((resolve, reject) => {
                if (config.format === 'webp') {
                    canvas.toBlob((blob) => {
                        if (blob) {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(blob);
                        } else {
                            reject(new Error('WebPç”Ÿæˆå¤±è´¥'));
                        }
                    }, 'image/webp', config.quality);
                } else {
                    const url = canvas.toDataURL(`image/${config.format}`, config.quality);
                    resolve(url);
                }
            });

            // è®¡ç®—æ–‡ä»¶ä¿¡æ¯
            const base64Data = dataUrl.split(',')[1];
            const fileSizeBytes = Math.round(base64Data.length * 0.75);
            const fileSizeKB = (fileSizeBytes / 1024).toFixed(2);

            return {
                name: config.name,
                format: config.format,
                quality: config.quality,
                dataUrl,
                base64Length: base64Data.length,
                fileSizeBytes,
                fileSizeKB: parseFloat(fileSizeKB),
                compressionRatio: ((640 * 360 * 3 - fileSizeBytes) / (640 * 360 * 3) * 100).toFixed(1)
            };
        }

        function createQualityItem(result, container) {
            const item = document.createElement('div');
            item.className = 'quality-item';
            
            const img = document.createElement('img');
            img.src = result.dataUrl;
            img.alt = result.name;
            
            const info = document.createElement('div');
            info.className = 'quality-info';
            
            info.innerHTML = `
                <div class="size-info">${result.fileSizeKB} KB</div>
                <div class="format-info">${result.name}</div>
                <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                    å‹ç¼©æ¯”: ${result.compressionRatio}%<br>
                    Base64é•¿åº¦: ${result.base64Length.toLocaleString()}
                </div>
            `;
            
            item.appendChild(img);
            item.appendChild(info);
            container.appendChild(item);
        }

        function addStatsRow(result, tbody) {
            const row = document.createElement('tr');
            
            // è§†è§‰è´¨é‡è¯„ä¼°
            let qualityAssessment = '';
            if (result.format === 'webp' && result.quality >= 0.9) {
                qualityAssessment = 'ğŸŒŸ ä¼˜ç§€';
            } else if (result.format === 'webp' && result.quality >= 0.8) {
                qualityAssessment = 'âœ… å¾ˆå¥½';
            } else if (result.format === 'jpeg' && result.quality >= 0.9) {
                qualityAssessment = 'ğŸ‘ è‰¯å¥½';
            } else {
                qualityAssessment = 'âš ï¸ ä¸€èˆ¬';
            }
            
            row.innerHTML = `
                <td>${result.format.toUpperCase()}</td>
                <td>${result.quality}</td>
                <td><strong>${result.fileSizeKB} KB</strong></td>
                <td>${result.base64Length.toLocaleString()}</td>
                <td>${result.compressionRatio}%</td>
                <td>${qualityAssessment}</td>
            `;
            
            tbody.appendChild(row);
        }

        function showTestSummary() {
            const resultsDiv = document.getElementById('testResults');
            
            // æ‰¾åˆ°ç³»ç»Ÿé…ç½®çš„ç»“æœ
            const systemConfig = testResults.find(r => r.format === 'webp' && r.quality === 0.9);
            const bestJpeg = testResults.find(r => r.format === 'jpeg' && r.quality === 0.9);
            
            if (systemConfig) {
                const savings = bestJpeg ? ((bestJpeg.fileSizeKB - systemConfig.fileSizeKB) / bestJpeg.fileSizeKB * 100).toFixed(1) : 0;
                
                resultsDiv.innerHTML = `
                    <h3>ğŸ¯ ç³»ç»Ÿé…ç½®åˆ†æç»“æœ</h3>
                    <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; padding: 15px;">
                        <p><strong>å½“å‰é…ç½® (WebP 640x360 è´¨é‡0.9):</strong></p>
                        <ul>
                            <li>ğŸ“ åˆ†è¾¨ç‡: 640x360 (é«˜æ¸…)</li>
                            <li>ğŸ“¦ æ–‡ä»¶å¤§å°: <strong>${systemConfig.fileSizeKB} KB</strong></li>
                            <li>ğŸ¨ æ ¼å¼: WebP (ç°ä»£æµè§ˆå™¨ä¼˜åŒ–)</li>
                            <li>âš¡ å‹ç¼©æ¯”: ${systemConfig.compressionRatio}%</li>
                            ${bestJpeg ? `<li>ğŸ’¾ ç›¸æ¯”JPEGèŠ‚çœ: ${savings}% ç©ºé—´</li>` : ''}
                        </ul>
                        <p><strong>è´¨é‡è¯„ä¼°:</strong> ğŸŒŸ ä¼˜ç§€ - é«˜è´¨é‡ã€å°æ–‡ä»¶ã€å¿«åŠ è½½</p>
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px; font-size: 0.9em;">
                        ğŸ’¡ <strong>å»ºè®®:</strong> å½“å‰é…ç½®å·²ç»æ˜¯æœ€ä½³å¹³è¡¡ç‚¹ï¼Œæ—¢ä¿è¯äº†è§†è§‰è´¨é‡ï¼Œåˆæ§åˆ¶äº†æ–‡ä»¶å¤§å°ã€‚
                    </div>
                `;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å¼€å§‹æµ‹è¯•
        window.addEventListener('load', () => {
            const video = document.getElementById('sourceVideo');
            // ç»™è§†é¢‘ä¸€äº›æ—¶é—´åŠ è½½
            setTimeout(() => {
                startQualityTest();
            }, 1000);
        });
    </script>
</body>
</html>
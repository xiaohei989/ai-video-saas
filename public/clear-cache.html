<!DOCTYPE html>
<html>
<head>
    <title>清除缓存</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>🧹 强制清除本地缓存</h1>
    <p>点击按钮清除所有IndexedDB、LocalStorage和其他缓存数据</p>
    
    <button onclick="clearAllCache()">立即清除缓存</button>
    
    <div id="log"></div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log')
            const p = document.createElement('p')
            p.className = type
            p.textContent = new Date().toLocaleTimeString() + ' - ' + message
            logDiv.appendChild(p)
            console.log(message)
        }

        async function clearAllCache() {
            log('🧹 开始强制清除所有缓存...', 'info')
            
            try {
                // 1. 清除IndexedDB
                const databases = ['UnifiedCache', 'ImageCache', 'TemplateCache', 'VideoCache', 'ai-video-cache', 'template-cache', 'idb-cache']
                
                for (const dbName of databases) {
                    try {
                        log(`正在删除数据库: ${dbName}`)
                        
                        const deleteRequest = indexedDB.deleteDatabase(dbName)
                        
                        await new Promise((resolve) => {
                            deleteRequest.onsuccess = () => {
                                log(`✅ 数据库 ${dbName} 删除成功`, 'success')
                                resolve()
                            }
                            
                            deleteRequest.onerror = () => {
                                log(`⚠️ 数据库 ${dbName} 删除失败或不存在`, 'warning')
                                resolve()
                            }
                            
                            deleteRequest.onblocked = () => {
                                log(`🔒 数据库 ${dbName} 删除被阻塞`, 'warning')
                                resolve()
                            }
                        })
                        
                        await new Promise(resolve => setTimeout(resolve, 100))
                    } catch (error) {
                        log(`删除数据库 ${dbName} 时出错: ${error.message}`, 'error')
                    }
                }

                // 2. 清除LocalStorage
                log('清除LocalStorage缓存...')
                const keysToRemove = []
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i)
                    if (key && (
                        key.startsWith('cached_img_') ||
                        key.startsWith('template_') ||
                        key.startsWith('video_') ||
                        key.startsWith('img_') ||
                        key.includes('cache') ||
                        key.includes('thumbnail')
                    )) {
                        keysToRemove.push(key)
                    }
                }
                
                keysToRemove.forEach(key => {
                    localStorage.removeItem(key)
                })
                
                log(`✅ 清除了 ${keysToRemove.length} 个LocalStorage键`, 'success')

                // 3. 清除SessionStorage
                log('清除SessionStorage缓存...')
                const sessionKeysToRemove = []
                
                for (let i = 0; i < sessionStorage.length; i++) {
                    const key = sessionStorage.key(i)
                    if (key && (
                        key.includes('cache') ||
                        key.includes('thumbnail') ||
                        key.includes('image')
                    )) {
                        sessionKeysToRemove.push(key)
                    }
                }
                
                sessionKeysToRemove.forEach(key => {
                    sessionStorage.removeItem(key)
                })
                
                log(`✅ 清除了 ${sessionKeysToRemove.length} 个SessionStorage键`, 'success')

                // 4. 清除Cache API
                if ('caches' in window) {
                    log('清除Cache API...')
                    const cacheNames = await caches.keys()
                    let deletedCaches = 0
                    
                    for (const cacheName of cacheNames) {
                        if (cacheName.includes('image') || cacheName.includes('template') || cacheName.includes('thumbnail')) {
                            await caches.delete(cacheName)
                            deletedCaches++
                        }
                    }
                    
                    log(`✅ 清除了 ${deletedCaches} 个Cache`, 'success')
                }

                log('🎉 所有缓存清除完成!', 'success')
                log('💡 建议刷新页面重新加载系统', 'info')
                
                // 自动刷新页面
                setTimeout(() => {
                    if (confirm('缓存清除完成！是否立即刷新页面？')) {
                        location.reload()
                    }
                }, 2000)

            } catch (error) {
                log(`❌ 缓存清除过程中出错: ${error.message}`, 'error')
            }
        }
    </script>
</body>
</html>
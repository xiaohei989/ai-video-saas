<!DOCTYPE html>
<html>
<head>
    <title>æ¸…é™¤ç¼“å­˜</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>ğŸ§¹ å¼ºåˆ¶æ¸…é™¤æœ¬åœ°ç¼“å­˜</h1>
    <p>ç‚¹å‡»æŒ‰é’®æ¸…é™¤æ‰€æœ‰IndexedDBã€LocalStorageå’Œå…¶ä»–ç¼“å­˜æ•°æ®</p>
    
    <button onclick="clearAllCache()">ç«‹å³æ¸…é™¤ç¼“å­˜</button>
    
    <div id="log"></div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log')
            const p = document.createElement('p')
            p.className = type
            p.textContent = new Date().toLocaleTimeString() + ' - ' + message
            logDiv.appendChild(p)
            console.log(message)
        }

        async function clearAllCache() {
            log('ğŸ§¹ å¼€å§‹å¼ºåˆ¶æ¸…é™¤æ‰€æœ‰ç¼“å­˜...', 'info')
            
            try {
                // 1. æ¸…é™¤IndexedDB
                const databases = ['UnifiedCache', 'ImageCache', 'TemplateCache', 'VideoCache', 'ai-video-cache', 'template-cache', 'idb-cache']
                
                for (const dbName of databases) {
                    try {
                        log(`æ­£åœ¨åˆ é™¤æ•°æ®åº“: ${dbName}`)
                        
                        const deleteRequest = indexedDB.deleteDatabase(dbName)
                        
                        await new Promise((resolve) => {
                            deleteRequest.onsuccess = () => {
                                log(`âœ… æ•°æ®åº“ ${dbName} åˆ é™¤æˆåŠŸ`, 'success')
                                resolve()
                            }
                            
                            deleteRequest.onerror = () => {
                                log(`âš ï¸ æ•°æ®åº“ ${dbName} åˆ é™¤å¤±è´¥æˆ–ä¸å­˜åœ¨`, 'warning')
                                resolve()
                            }
                            
                            deleteRequest.onblocked = () => {
                                log(`ğŸ”’ æ•°æ®åº“ ${dbName} åˆ é™¤è¢«é˜»å¡`, 'warning')
                                resolve()
                            }
                        })
                        
                        await new Promise(resolve => setTimeout(resolve, 100))
                    } catch (error) {
                        log(`åˆ é™¤æ•°æ®åº“ ${dbName} æ—¶å‡ºé”™: ${error.message}`, 'error')
                    }
                }

                // 2. æ¸…é™¤LocalStorage
                log('æ¸…é™¤LocalStorageç¼“å­˜...')
                const keysToRemove = []
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i)
                    if (key && (
                        key.startsWith('cached_img_') ||
                        key.startsWith('template_') ||
                        key.startsWith('video_') ||
                        key.startsWith('img_') ||
                        key.includes('cache') ||
                        key.includes('thumbnail')
                    )) {
                        keysToRemove.push(key)
                    }
                }
                
                keysToRemove.forEach(key => {
                    localStorage.removeItem(key)
                })
                
                log(`âœ… æ¸…é™¤äº† ${keysToRemove.length} ä¸ªLocalStorageé”®`, 'success')

                // 3. æ¸…é™¤SessionStorage
                log('æ¸…é™¤SessionStorageç¼“å­˜...')
                const sessionKeysToRemove = []
                
                for (let i = 0; i < sessionStorage.length; i++) {
                    const key = sessionStorage.key(i)
                    if (key && (
                        key.includes('cache') ||
                        key.includes('thumbnail') ||
                        key.includes('image')
                    )) {
                        sessionKeysToRemove.push(key)
                    }
                }
                
                sessionKeysToRemove.forEach(key => {
                    sessionStorage.removeItem(key)
                })
                
                log(`âœ… æ¸…é™¤äº† ${sessionKeysToRemove.length} ä¸ªSessionStorageé”®`, 'success')

                // 4. æ¸…é™¤Cache API
                if ('caches' in window) {
                    log('æ¸…é™¤Cache API...')
                    const cacheNames = await caches.keys()
                    let deletedCaches = 0
                    
                    for (const cacheName of cacheNames) {
                        if (cacheName.includes('image') || cacheName.includes('template') || cacheName.includes('thumbnail')) {
                            await caches.delete(cacheName)
                            deletedCaches++
                        }
                    }
                    
                    log(`âœ… æ¸…é™¤äº† ${deletedCaches} ä¸ªCache`, 'success')
                }

                log('ğŸ‰ æ‰€æœ‰ç¼“å­˜æ¸…é™¤å®Œæˆ!', 'success')
                log('ğŸ’¡ å»ºè®®åˆ·æ–°é¡µé¢é‡æ–°åŠ è½½ç³»ç»Ÿ', 'info')
                
                // è‡ªåŠ¨åˆ·æ–°é¡µé¢
                setTimeout(() => {
                    if (confirm('ç¼“å­˜æ¸…é™¤å®Œæˆï¼æ˜¯å¦ç«‹å³åˆ·æ–°é¡µé¢ï¼Ÿ')) {
                        location.reload()
                    }
                }, 2000)

            } catch (error) {
                log(`âŒ ç¼“å­˜æ¸…é™¤è¿‡ç¨‹ä¸­å‡ºé”™: ${error.message}`, 'error')
            }
        }
    </script>
</body>
</html>
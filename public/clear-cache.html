<!DOCTYPE html>
<html>
<head>
    <title>清除缓存</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>🧹 强制清除本地缓存</h1>
    <p>点击按钮清除所有IndexedDB、LocalStorage和其他缓存数据</p>
    
    <div style="margin: 20px 0;">
        <button onclick="clearAllCache()">🗑️ 立即清除所有缓存</button>
        <button onclick="clearNewImageCache()" style="margin-left: 10px; background: #dc3545;">🔥 强力清理图片缓存</button>
        <button onclick="clearSpecificCache()" style="margin-left: 10px; background: #28a745;">🎯 精准清理应用缓存</button>
    </div>
    
    <div id="log"></div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log')
            const p = document.createElement('p')
            p.className = type
            p.textContent = new Date().toLocaleTimeString() + ' - ' + message
            logDiv.appendChild(p)
            console.log(message)
        }

        async function clearAllCache() {
            log('🧹 开始强制清除所有缓存...', 'info')
            
            try {
                // 1. 清除IndexedDB
                const databases = [
                    'ai-video-unified-cache', // 🎯 新的统一缓存数据库！
                    'ai-video-saas-cache',    // 🗑️ 旧数据库（如果存在）
                    'UnifiedCache', 
                    'ImageCache', 
                    'TemplateCache', 
                    'VideoCache', 
                    'ai-video-cache', 
                    'template-cache', 
                    'idb-cache'
                ]
                
                for (const dbName of databases) {
                    try {
                        log(`正在删除数据库: ${dbName}`)
                        
                        const deleteRequest = indexedDB.deleteDatabase(dbName)
                        
                        await new Promise((resolve) => {
                            deleteRequest.onsuccess = () => {
                                log(`✅ 数据库 ${dbName} 删除成功`, 'success')
                                resolve()
                            }
                            
                            deleteRequest.onerror = () => {
                                log(`⚠️ 数据库 ${dbName} 删除失败或不存在`, 'warning')
                                resolve()
                            }
                            
                            deleteRequest.onblocked = () => {
                                log(`🔒 数据库 ${dbName} 删除被阻塞`, 'warning')
                                resolve()
                            }
                        })
                        
                        await new Promise(resolve => setTimeout(resolve, 100))
                    } catch (error) {
                        log(`删除数据库 ${dbName} 时出错: ${error.message}`, 'error')
                    }
                }

                // 2. 清除LocalStorage
                log('清除LocalStorage缓存...')
                const keysToRemove = []
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i)
                    if (key && (
                        key.startsWith('cached_img_') ||
                        key.startsWith('template_') ||
                        key.startsWith('video_') ||
                        key.startsWith('img_') ||
                        key.includes('cache') ||
                        key.includes('thumbnail')
                    )) {
                        keysToRemove.push(key)
                    }
                }
                
                keysToRemove.forEach(key => {
                    localStorage.removeItem(key)
                })
                
                log(`✅ 清除了 ${keysToRemove.length} 个LocalStorage键`, 'success')

                // 3. 清除SessionStorage
                log('清除SessionStorage缓存...')
                const sessionKeysToRemove = []
                
                for (let i = 0; i < sessionStorage.length; i++) {
                    const key = sessionStorage.key(i)
                    if (key && (
                        key.includes('cache') ||
                        key.includes('thumbnail') ||
                        key.includes('image')
                    )) {
                        sessionKeysToRemove.push(key)
                    }
                }
                
                sessionKeysToRemove.forEach(key => {
                    sessionStorage.removeItem(key)
                })
                
                log(`✅ 清除了 ${sessionKeysToRemove.length} 个SessionStorage键`, 'success')

                // 4. 清除Cache API
                if ('caches' in window) {
                    log('清除Cache API...')
                    const cacheNames = await caches.keys()
                    let deletedCaches = 0
                    
                    for (const cacheName of cacheNames) {
                        if (cacheName.includes('image') || cacheName.includes('template') || cacheName.includes('thumbnail')) {
                            await caches.delete(cacheName)
                            deletedCaches++
                        }
                    }
                    
                    log(`✅ 清除了 ${deletedCaches} 个Cache`, 'success')
                }

                log('🎉 所有缓存清除完成!', 'success')
                log('💡 建议刷新页面重新加载系统', 'info')
                
                // 自动刷新页面
                setTimeout(() => {
                    if (confirm('缓存清除完成！是否立即刷新页面？')) {
                        location.reload()
                    }
                }, 2000)

            } catch (error) {
                log(`❌ 缓存清除过程中出错: ${error.message}`, 'error')
            }
        }

        async function clearNewImageCache() {
            log('🔥 开始强力清理NewImageCache缓存...', 'info')
            
            try {
                let clearedCount = 0
                
                // 清理所有可能的IndexedDB数据库（包含真正的缓存数据库）
                const targetDatabases = [
                    'ai-video-unified-cache',  // 🎯 新的统一缓存数据库！
                    'ai-video-saas-cache',     // 🗑️ 旧数据库（如果存在）
                    'unified-cache-v1',
                    'unified-cache', 
                    'image-cache',
                    'template-cache',
                    'thumbnail-cache',
                    'newImageCache',
                    'keyval-store'
                ]
                
                log('🎯 专门清理NewImageCache相关数据库...', 'info')
                
                for (const dbName of targetDatabases) {
                    try {
                        await new Promise((resolve, reject) => {
                            const deleteReq = indexedDB.deleteDatabase(dbName)
                            deleteReq.onerror = () => reject(deleteReq.error)
                            deleteReq.onsuccess = () => resolve()
                            deleteReq.onblocked = () => setTimeout(resolve, 1000)
                            setTimeout(() => reject(new Error('timeout')), 5000)
                        })
                        
                        log(`✅ 已删除: ${dbName}`, 'success')
                        clearedCount++
                    } catch (error) {
                        log(`⚠️ 清理: ${dbName} (${error.message})`, 'warning')
                    }
                }
                
                // 清理localStorage中的图片缓存相关项
                log('🧹 清理localStorage中的图片缓存...', 'info')
                const keys = Object.keys(localStorage)
                let localStorageCleared = 0
                
                keys.forEach(key => {
                    if (key.includes('img_') || 
                        key.includes('image') || 
                        key.includes('thumbnail') || 
                        key.includes('template') ||
                        key.includes('cache')) {
                        localStorage.removeItem(key)
                        localStorageCleared++
                    }
                })
                
                log(`✅ 清理localStorage项: ${localStorageCleared}个`, 'success')
                
                // 清理sessionStorage
                sessionStorage.clear()
                log('✅ 清理sessionStorage', 'success')
                
                // 强制垃圾回收（如果支持）
                if (window.gc) {
                    window.gc()
                    log('✅ 执行垃圾回收', 'success')
                }
                
                log('🎉 NewImageCache强力清理完成！', 'success')
                log(`📊 清理统计：IndexedDB数据库 ${clearedCount}个，localStorage项 ${localStorageCleared}个`, 'info')
                log('💡 建议刷新页面或重启浏览器以确保完全清理', 'info')
                
                // 延迟提示刷新
                setTimeout(() => {
                    if (confirm('NewImageCache清理完成！建议刷新页面确保完全清理，是否立即刷新？')) {
                        location.reload()
                    }
                }, 1500)
                
            } catch (error) {
                log(`❌ NewImageCache清理过程出错: ${error.message}`, 'error')
            }
        }

        async function clearSpecificCache() {
            log('🎯 开始精准清理应用缓存...', 'info')
            
            try {
                // 目标应用缓存数据库
                const appDatabases = [
                    'ai-video-unified-cache', // 🎯 新的统一缓存数据库！
                    'ai-video-saas-cache',    // 🗑️ 旧数据库（如果存在）
                    'template-cache',
                    'thumbnail-cache', 
                    'video-cache',
                    'image-cache',
                    'ai-video-saas',
                    'supabase-cache',
                    'webp-cache'
                ]

                let clearedCount = 0
                let errors = []

                for (const dbName of appDatabases) {
                    try {
                        await new Promise((resolve, reject) => {
                            const deleteReq = indexedDB.deleteDatabase(dbName)
                            deleteReq.onerror = () => reject(deleteReq.error)
                            deleteReq.onsuccess = () => resolve()
                            deleteReq.onblocked = () => setTimeout(resolve, 1000)
                            setTimeout(() => reject(new Error('timeout')), 3000)
                        })
                        
                        clearedCount++
                        log(`✅ 已清理: ${dbName}`, 'success')
                    } catch (error) {
                        if (!error.message.includes('not found') && !error.message.includes('timeout')) {
                            errors.push(`${dbName}: ${error.message}`)
                            log(`⚠️ 清理失败: ${dbName} - ${error.message}`, 'warning')
                        }
                    }
                }

                // 清理特定的localStorage项
                log('🔍 清理应用相关localStorage项...', 'info')
                const storageKeys = Object.keys(localStorage)
                const targetKeys = storageKeys.filter(key => 
                    key.includes('template') || 
                    key.includes('thumbnail') || 
                    key.includes('cache') || 
                    key.includes('supabase')
                )

                for (const key of targetKeys) {
                    try {
                        localStorage.removeItem(key)
                        log(`✅ 已清理localStorage: ${key}`, 'success')
                    } catch (error) {
                        errors.push(`localStorage.${key}: ${error.message}`)
                        log(`⚠️ localStorage清理失败: ${key}`, 'warning')
                    }
                }

                log('🎉 精准应用缓存清理完成！', 'success')
                log(`📊 清理统计：数据库 ${clearedCount}个，localStorage项 ${targetKeys.length}个`, 'info')
                
                if (errors.length > 0) {
                    log(`⚠️ 部分清理失败：${errors.length}个项目`, 'warning')
                    errors.forEach(err => log(`  - ${err}`, 'warning'))
                }
                
                log('💡 精准清理完成，应用缓存已更新', 'info')

            } catch (error) {
                log(`❌ 精准清理过程出错: ${error.message}`, 'error')
            }
        }
    </script>
</body>
</html>
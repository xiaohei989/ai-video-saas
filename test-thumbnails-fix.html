<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¼©ç•¥å›¾ä¿®å¤éªŒè¯</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-result {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-result.success {
            border-left: 4px solid #22c55e;
        }
        .test-result.error {
            border-left: 4px solid #ef4444;
        }
        .test-result.warning {
            border-left: 4px solid #f59e0b;
        }
        .console-log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .thumbnail-test {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        .thumbnail-test img {
            width: 150px;
            height: 85px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ç¼©ç•¥å›¾ä¿®å¤éªŒè¯</h1>
        <p>æµ‹è¯•ç¼©ç•¥å›¾ä¼˜åŒ–ä¿®å¤æ˜¯å¦æˆåŠŸ</p>

        <div id="results"></div>

        <div class="test-result">
            <h3>ğŸ“‹ æ§åˆ¶å°æ—¥å¿—</h3>
            <div id="console-logs" class="console-log">ç­‰å¾…æ—¥å¿—è¾“å‡º...</div>
        </div>
    </div>

    <script>
        const results = document.getElementById('results');
        const consoleLogs = document.getElementById('console-logs');
        const logs = [];

        // æ‹¦æˆªæ§åˆ¶å°æ—¥å¿—
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;

        function addLog(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            logs.push(`[${timestamp}] [${type.toUpperCase()}] ${message}`);
            updateConsoleDisplay();
        }

        function updateConsoleDisplay() {
            consoleLogs.innerHTML = logs.slice(-20).join('<br>'); // åªæ˜¾ç¤ºæœ€è¿‘20æ¡æ—¥å¿—
            consoleLogs.scrollTop = consoleLogs.scrollHeight;
        }

        console.log = function(...args) {
            addLog('log', args.join(' '));
            originalLog.apply(console, args);
        };

        console.warn = function(...args) {
            addLog('warn', args.join(' '));
            originalWarn.apply(console, args);
        };

        console.error = function(...args) {
            addLog('error', args.join(' '));
            originalError.apply(console, args);
        };

        // æµ‹è¯•ç»“æœæ·»åŠ å‡½æ•°
        function addResult(title, status, message, details) {
            const result = document.createElement('div');
            result.className = `test-result ${status}`;
            result.innerHTML = `
                <h3>${title}</h3>
                <p>${message}</p>
                ${details ? `<div class="console-log">${details}</div>` : ''}
            `;
            results.appendChild(result);
        }

        // æµ‹è¯•1: ç¼©ç•¥å›¾æ–‡ä»¶å¯è®¿é—®æ€§
        async function testThumbnailAccess() {
            const testThumbnails = [
                '/templates/thumbnails/animal-skateboarding-street-thumbnail.jpg',
                '/templates/thumbnails/art-coffee-machine-thumbnail.jpg',
                '/templates/thumbnails/asmr-surreal-toast-spread-thumbnail.jpg'
            ];

            let successCount = 0;
            const details = [];

            for (const thumbnail of testThumbnails) {
                try {
                    const response = await fetch(thumbnail, { method: 'HEAD' });
                    if (response.ok) {
                        successCount++;
                        details.push(`âœ… ${thumbnail} - OK`);
                    } else {
                        details.push(`âŒ ${thumbnail} - ${response.status}`);
                    }
                } catch (error) {
                    details.push(`âŒ ${thumbnail} - é”™è¯¯: ${error.message}`);
                }
            }

            const status = successCount === testThumbnails.length ? 'success' : 'warning';
            addResult(
                'ğŸ“ ç¼©ç•¥å›¾æ–‡ä»¶å¯è®¿é—®æ€§æµ‹è¯•', 
                status,
                `${successCount}/${testThumbnails.length} ä¸ªç¼©ç•¥å›¾æ–‡ä»¶å¯è®¿é—®`,
                details.join('<br>')
            );
        }

        // æµ‹è¯•2: æ¨¡æ‹ŸLazyVideoPlayerç¼©ç•¥å›¾æœåŠ¡è°ƒç”¨
        async function testThumbnailGenerator() {
            // æ¨¡æ‹Ÿç¼©ç•¥å›¾ç”Ÿæˆå™¨æœåŠ¡çš„é€»è¾‘
            function generateThumbnailPath(videoSrc) {
                const videoName = videoSrc.split('/').pop()?.replace('.mp4', '') || 'video';
                return {
                    normal: `/templates/thumbnails/${videoName}-thumbnail.jpg`,
                    blur: `/templates/thumbnails/${videoName}-thumbnail-blur.jpg`
                };
            }

            async function checkThumbnailExists(thumbnailPath) {
                try {
                    const response = await fetch(thumbnailPath, { method: 'HEAD' });
                    return response.ok;
                } catch {
                    return false;
                }
            }

            async function getBestThumbnail(videoSrc, fallbackImage) {
                console.log(`[ThumbnailGenerator] æ£€æŸ¥ç¼©ç•¥å›¾è·¯å¾„:`, generateThumbnailPath(videoSrc));
                
                const thumbnailPaths = generateThumbnailPath(videoSrc);
                const normalExists = await checkThumbnailExists(thumbnailPaths.normal);
                const blurExists = await checkThumbnailExists(thumbnailPaths.blur);
                
                console.log(`[ThumbnailGenerator] ç¼©ç•¥å›¾å­˜åœ¨çŠ¶æ€: normal=${normalExists}, blur=${blurExists}`);
                
                if (normalExists && blurExists) {
                    console.log(`[ThumbnailGenerator] âœ… ä½¿ç”¨ç”Ÿæˆçš„ç¼©ç•¥å›¾: ${thumbnailPaths.normal}`);
                    return thumbnailPaths;
                }
                
                const fallback = fallbackImage || '/logo.png';
                console.log(`[ThumbnailGenerator] âš ï¸ ç¼©ç•¥å›¾ä¸å­˜åœ¨ï¼Œä½¿ç”¨fallback: ${fallback}`);
                return {
                    normal: fallback,
                    blur: fallback
                };
            }

            // æµ‹è¯•å‡ ä¸ªæ¨¡æ¿
            const testVideos = [
                '/templates/videos/animal-skateboarding-street.mp4',
                '/templates/videos/art-coffee-machine.mp4',
                '/templates/videos/asmr-surreal-toast-spread.mp4'
            ];

            let successCount = 0;
            for (const video of testVideos) {
                const result = await getBestThumbnail(video);
                if (result.normal.includes('templates/thumbnails')) {
                    successCount++;
                }
            }

            const status = successCount === testVideos.length ? 'success' : 'warning';
            addResult(
                'ğŸ–¼ï¸ ç¼©ç•¥å›¾ç”Ÿæˆå™¨æœåŠ¡æµ‹è¯•',
                status,
                `${successCount}/${testVideos.length} ä¸ªè§†é¢‘æˆåŠŸè·å–åˆ°ç¼©ç•¥å›¾`,
                'æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—äº†è§£è¯¦ç»†è¿‡ç¨‹'
            );
        }

        // æµ‹è¯•3: æ˜¾ç¤ºå®é™…çš„ç¼©ç•¥å›¾
        function testThumbnailDisplay() {
            const thumbnails = [
                '/templates/thumbnails/animal-skateboarding-street-thumbnail.jpg',
                '/templates/thumbnails/art-coffee-machine-thumbnail.jpg',
                '/templates/thumbnails/asmr-surreal-toast-spread-thumbnail.jpg'
            ];

            let thumbnailHtml = '<div class="thumbnail-test">';
            thumbnails.forEach(thumb => {
                thumbnailHtml += `<img src="${thumb}" alt="ç¼©ç•¥å›¾æµ‹è¯•" onload="this.style.border='2px solid #22c55e'" onerror="this.style.border='2px solid #ef4444'">`;
            });
            thumbnailHtml += '</div>';

            addResult(
                'ğŸ¨ ç¼©ç•¥å›¾æ˜¾ç¤ºæµ‹è¯•',
                'success',
                'ç»¿è‰²è¾¹æ¡†è¡¨ç¤ºåŠ è½½æˆåŠŸï¼Œçº¢è‰²è¾¹æ¡†è¡¨ç¤ºåŠ è½½å¤±è´¥',
                thumbnailHtml
            );
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runTests() {
            console.log('ğŸ§ª å¼€å§‹ç¼©ç•¥å›¾ä¿®å¤éªŒè¯æµ‹è¯•...');
            
            await testThumbnailAccess();
            await testThumbnailGenerator();
            testThumbnailDisplay();
            
            console.log('âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆ');
        }

        // é¡µé¢åŠ è½½å®Œæˆåè¿è¡Œæµ‹è¯•
        document.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>
</html>
# ç¼©ç•¥å›¾ç”Ÿæˆä¿®å¤ - æœ€ç»ˆæ–¹æ¡ˆ

**åˆ›å»ºæ—¶é—´:** 2025-10-15
**é—®é¢˜:** ç¼©ç•¥å›¾ç­‰å¾…R2è¿ç§»å®Œæˆï¼Œä½†R2è¿ç§»å¡åœ¨pendingï¼Œå¯¼è‡´ç¼©ç•¥å›¾æ°¸è¿œä¸ç”Ÿæˆ

---

## ğŸ¯ è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒä¿®æ”¹

1. **ç¼©ç•¥å›¾ä¸å†ç­‰å¾…R2è¿ç§»**
   - å½“è§†é¢‘ status='completed' æ—¶ç«‹å³ç”Ÿæˆç¼©ç•¥å›¾
   - ä¸éœ€è¦ç­‰å¾… migration_status='completed'

2. **æ·»åŠ pendingè¶…æ—¶æœºåˆ¶**
   - æ£€æµ‹å¡åœ¨ pending/downloading/uploading è¶…è¿‡10åˆ†é’Ÿçš„è§†é¢‘
   - è‡ªåŠ¨æ ‡è®°ä¸º failedï¼Œç”±è‡ªåŠ¨é‡è¯•ç³»ç»Ÿæ¥ç®¡

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤ï¼ˆ3æ­¥éª¤ï¼Œ5åˆ†é’Ÿï¼‰

### æ­¥éª¤1: æ‰§è¡Œæ•°æ®åº“è¿ç§»

åœ¨ **Supabase SQL Editor** ä¸­æ‰§è¡Œï¼š

å¤åˆ¶å¹¶ç²˜è´´æ–‡ä»¶å†…å®¹ï¼š`supabase/migrations/029_fix_thumbnail_before_migration.sql`

ç‚¹å‡» **Run**

**é¢„æœŸè¾“å‡ºï¼š**
```
âœ… ç¼©ç•¥å›¾è§¦å‘å™¨å·²ä¿®å¤ï¼
âœ… æ–°é€»è¾‘: è§†é¢‘å®Œæˆæ—¶ç«‹å³ç”Ÿæˆç¼©ç•¥å›¾
âœ… ä¸å†ç­‰å¾… R2 è¿ç§»å®Œæˆ
âœ… Pending è¶…æ—¶æœºåˆ¶å·²æ·»åŠ ï¼ˆ10åˆ†é’Ÿï¼‰

ğŸ”§ ç«‹å³ä¿®å¤ç»“æœ:
{"success":true,"fixedCount":15,...}
```

### æ­¥éª¤2: ç«‹å³ä¸ºpendingè§†é¢‘ç”Ÿæˆç¼©ç•¥å›¾

åœ¨ç»ˆç«¯æ‰§è¡Œï¼š

```bash
node scripts/fix-pending-thumbnails.js
```

**é¢„æœŸè¾“å‡ºï¼š**
```
ğŸ”§ å¼€å§‹ä¸ºpendingè§†é¢‘ç”Ÿæˆç¼©ç•¥å›¾

ğŸ“Š æ‰¾åˆ° 15 ä¸ªpendingè§†é¢‘

ğŸ”„ å¤„ç†: Tiny Baby Owl on Your Finger
   âœ… æˆåŠŸ

...

âœ… ç¼©ç•¥å›¾ç”Ÿæˆå·²è§¦å‘ï¼è¯·ç­‰å¾…1-2åˆ†é’Ÿåæ£€æŸ¥ç»“æœ
```

### æ­¥éª¤3: éªŒè¯ä¿®å¤æ•ˆæœ

ç­‰å¾…1-2åˆ†é’Ÿåï¼Œæ£€æŸ¥Owlè§†é¢‘æ˜¯å¦æœ‰ç¼©ç•¥å›¾ï¼š

```bash
node scripts/check-owl-thumbnail-status.js
```

**é¢„æœŸçœ‹åˆ°ï¼š**
```
ğŸ–¼ï¸ ç¼©ç•¥å›¾çŠ¶æ€:
  thumbnail_url: https://cdn.veo3video.me/... âœ…
  thumbnail_generation_status: completed âœ…
```

---

## ğŸ“Š ç›‘æ§å‘½ä»¤

### æŸ¥çœ‹å¡ä½çš„è§†é¢‘

```sql
SELECT * FROM stuck_videos;
```

### æ‰‹åŠ¨ä¿®å¤è¶…æ—¶è§†é¢‘

```sql
SELECT fix_stuck_pending_migrations();
```

### æŸ¥çœ‹è¿ç§»å¥åº·çŠ¶å†µ

```sql
SELECT * FROM migration_health;
```

---

## ğŸ¯ ä¿®å¤å‰ vs ä¿®å¤å

### ä¿®å¤å‰ï¼ˆæ—§é€»è¾‘ï¼‰

1. è§†é¢‘ç”Ÿæˆå®Œæˆ â†’ status='completed'
2. è§¦å‘R2è¿ç§» â†’ migration_status='pending'
3. **ç­‰å¾…R2è¿ç§»å®Œæˆ** â†’ migration_status='completed'
4. **ç„¶å**æ‰ç”Ÿæˆç¼©ç•¥å›¾

**é—®é¢˜ï¼š** å¦‚æœR2è¿ç§»å¡ä½ï¼Œç¼©ç•¥å›¾æ°¸è¿œä¸ç”Ÿæˆ

### ä¿®å¤åï¼ˆæ–°é€»è¾‘ï¼‰

1. è§†é¢‘ç”Ÿæˆå®Œæˆ â†’ status='completed'
2. **ç«‹å³ç”Ÿæˆç¼©ç•¥å›¾**ï¼ˆä¸ç­‰å¾…è¿ç§»ï¼‰
3. åŒæ—¶è§¦å‘R2è¿ç§»ï¼ˆåå°è¿›è¡Œï¼‰
4. å¦‚æœè¿ç§»å¡ä½è¶…è¿‡10åˆ†é’Ÿ â†’ è‡ªåŠ¨æ ‡è®°failed â†’ è‡ªåŠ¨é‡è¯•

**ä¼˜åŠ¿ï¼š**
- âœ… ç¼©ç•¥å›¾ç«‹å³ç”Ÿæˆï¼Œç”¨æˆ·ä½“éªŒæ›´å¥½
- âœ… R2è¿ç§»å¤±è´¥ä¸å½±å“ç¼©ç•¥å›¾
- âœ… è‡ªåŠ¨æ£€æµ‹å¹¶ä¿®å¤å¡ä½çš„è¿ç§»

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### æ–°è§¦å‘å™¨é€»è¾‘

```sql
-- ä¸»è¦è§¦å‘æ¡ä»¶
IF NEW.status = 'completed'
   AND NEW.video_url IS NOT NULL
   AND (thumbnailä¸ºç©ºæˆ–ä¸ºé»˜è®¤å›¾) THEN
  -- ç«‹å³è§¦å‘ç¼©ç•¥å›¾ç”Ÿæˆ
END IF;
```

### Pendingè¶…æ—¶æœºåˆ¶

```sql
-- æ£€æµ‹è¶…æ—¶ï¼ˆ10åˆ†é’Ÿï¼‰
WHERE migration_status IN ('pending', 'downloading', 'uploading')
  AND å¡ä½æ—¶é•¿ > 10åˆ†é’Ÿ

-- è‡ªåŠ¨ä¿®å¤
UPDATE SET migration_status = 'failed'
-- ç„¶åç”± auto_retry_failed_migrations() æ¥ç®¡
```

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### ç«‹å³æ•ˆæœï¼ˆ5åˆ†é’Ÿå†…ï¼‰

- 15ä¸ªpendingè§†é¢‘å°†ç”Ÿæˆç¼©ç•¥å›¾
- Owlè§†é¢‘ç»ˆäºæœ‰ç¼©ç•¥å›¾äº†

### é•¿æœŸæ•ˆæœ

- æ‰€æœ‰æ–°è§†é¢‘å®Œæˆæ—¶ç«‹å³ç”Ÿæˆç¼©ç•¥å›¾
- R2è¿ç§»åœ¨åå°è¿›è¡Œï¼Œä¸é˜»å¡ç”¨æˆ·ä½“éªŒ
- å¡ä½çš„è¿ç§»è‡ªåŠ¨æ£€æµ‹å¹¶é‡è¯•

---

## ğŸ› æ•…éšœæ’æŸ¥

### Q1: Migration 029 æ‰§è¡Œå¤±è´¥ï¼Ÿ

**æ£€æŸ¥ï¼š**
```sql
-- ç¡®è®¤ system_config è¡¨å­˜åœ¨
SELECT * FROM system_config WHERE key IN ('supabase_url', 'service_role_key');
```

### Q2: ç¼©ç•¥å›¾ä»ç„¶æ²¡ç”Ÿæˆï¼Ÿ

**æ‰‹åŠ¨è§¦å‘ï¼š**
```bash
node scripts/fix-pending-thumbnails.js
```

**æ£€æŸ¥Edge Functionæ—¥å¿—ï¼š**
```bash
npx supabase functions logs auto-generate-thumbnail --tail
```

### Q3: R2è¿ç§»ä¸ºä»€ä¹ˆä¸€ç›´å¤±è´¥ï¼Ÿ

**å¯èƒ½åŸå› ï¼š**
1. Edge Functionè¶…æ—¶ï¼ˆå½“å‰3åˆ†é’Ÿï¼‰
2. ç½‘ç»œé—®é¢˜ï¼ˆé˜¿é‡Œäº‘OSS â†’ R2ï¼‰
3. R2é…ç½®é—®é¢˜

**è§£å†³ï¼š** R2è¿ç§»å¤±è´¥ä¸å½±å“ç¼©ç•¥å›¾å’Œç”¨æˆ·ä½¿ç”¨ï¼Œå¯ä»¥ç¨åè°ƒæŸ¥

---

## âœ… æˆåŠŸæŒ‡æ ‡

### 5åˆ†é’Ÿåæ£€æŸ¥

```sql
-- æŸ¥çœ‹æœ€æ–°10ä¸ªè§†é¢‘çš„ç¼©ç•¥å›¾æƒ…å†µ
SELECT
  title,
  status,
  migration_status,
  thumbnail_url IS NOT NULL as has_thumbnail,
  created_at
FROM videos
WHERE status = 'completed'
ORDER BY created_at DESC
LIMIT 10;
```

**ç›®æ ‡ï¼š**
- âœ… æ‰€æœ‰ status='completed' çš„è§†é¢‘éƒ½æœ‰ç¼©ç•¥å›¾
- âœ… å³ä½¿ migration_status='pending' æˆ– 'failed'

---

## ğŸ‰ å®Œæˆï¼

ç°åœ¨ç³»ç»Ÿä¼šï¼š
1. âœ… è§†é¢‘å®Œæˆæ—¶ç«‹å³ç”Ÿæˆç¼©ç•¥å›¾
2. âœ… ä¸ç­‰å¾…R2è¿ç§»
3. âœ… è‡ªåŠ¨æ£€æµ‹å¹¶ä¿®å¤å¡ä½çš„è¿ç§»ï¼ˆ10åˆ†é’Ÿè¶…æ—¶ï¼‰
4. âœ… æ™ºèƒ½é‡è¯•å¤±è´¥çš„è¿ç§»ï¼ˆ2/5/10åˆ†é’Ÿé—´éš”ï¼‰

**ç”¨æˆ·ä½“éªŒæå‡ï¼š**
- ç¼©ç•¥å›¾ç«‹å³å¯è§
- R2è¿ç§»åœ¨åå°é™é»˜è¿›è¡Œ
- å³ä½¿è¿ç§»å¤±è´¥ï¼Œä¹Ÿä¸å½±å“ä½¿ç”¨

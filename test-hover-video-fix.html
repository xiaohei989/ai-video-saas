<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¼ æ ‡æ‚¬åœè§†é¢‘æ’­æ”¾æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .title {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .video-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        .video-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .video-wrapper {
            position: relative;
            aspect-ratio: 16/9;
            background: #000;
            overflow: hidden;
        }
        .test-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
        }
        .video-info {
            padding: 15px;
        }
        .video-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        .video-description {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }
        .debug-info {
            background: #2a2a2a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .status-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .playing { background: rgba(34, 197, 94, 0.9) !important; }
        .loading { background: rgba(249, 115, 22, 0.9) !important; }
        .error { background: rgba(239, 68, 68, 0.9) !important; }
        
        .controls {
            text-align: center;
            margin-bottom: 20px;
        }
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 0 5px;
            font-weight: 500;
        }
        .btn:hover {
            background: #2563eb;
        }
        .btn.danger {
            background: #ef4444;
        }
        .btn.danger:hover {
            background: #dc2626;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">ğŸ¬ é¼ æ ‡æ‚¬åœè§†é¢‘æ’­æ”¾æµ‹è¯•</h1>
        
        <div class="controls">
            <button class="btn" onclick="clearDebugLog()">æ¸…é™¤è°ƒè¯•æ—¥å¿—</button>
            <button class="btn danger" onclick="stopAllVideos()">åœæ­¢æ‰€æœ‰è§†é¢‘</button>
        </div>

        <div class="video-grid">
            <!-- æµ‹è¯•è§†é¢‘ 1 -->
            <div class="video-card">
                <div class="video-wrapper">
                    <video 
                        class="test-video" 
                        data-video-id="test-1"
                        data-title="åŠ¨ç‰©æ»‘æ¿è¡—å¤´è¡¨æ¼”"
                        poster="public/templates/thumbnails/animal-skateboarding-street-thumbnail.jpg"
                        muted
                        playsInline
                        preload="metadata">
                        <source src="public/templates/videos/animal-skateboarding-street.mp4" type="video/mp4">
                    </video>
                    <div class="status-indicator" id="status-test-1">ç­‰å¾…ä¸­</div>
                </div>
                <div class="video-info">
                    <div class="video-title">åŠ¨ç‰©æ»‘æ¿è¡—å¤´è¡¨æ¼”</div>
                    <div class="video-description">å¯çˆ±çš„åŠ¨ç‰©ä»¬åœ¨è¡—å¤´è¿›è¡Œæ»‘æ¿è¡¨æ¼”ï¼Œå……æ»¡è¶£å‘³æ€§å’Œåˆ›æ„çš„è§†é¢‘å†…å®¹ã€‚</div>
                </div>
            </div>

            <!-- æµ‹è¯•è§†é¢‘ 2 -->
            <div class="video-card">
                <div class="video-wrapper">
                    <video 
                        class="test-video" 
                        data-video-id="test-2"
                        data-title="è‰ºæœ¯å’–å•¡æœºåˆ¶ä½œ"
                        poster="/templates/thumbnails/art-coffee-machine-thumbnail.jpg"
                        muted
                        playsInline
                        preload="metadata">
                        <source src="/templates/videos/art-coffee-machine.mp4" type="video/mp4">
                    </video>
                    <div class="status-indicator" id="status-test-2">ç­‰å¾…ä¸­</div>
                </div>
                <div class="video-info">
                    <div class="video-title">è‰ºæœ¯å’–å•¡æœºåˆ¶ä½œ</div>
                    <div class="video-description">å±•ç¤ºç²¾ç¾çš„å’–å•¡è‰ºæœ¯åˆ¶ä½œè¿‡ç¨‹ï¼Œä»ç ”ç£¨åˆ°æ‹‰èŠ±çš„å®Œæ•´æµç¨‹ã€‚</div>
                </div>
            </div>

            <!-- æµ‹è¯•è§†é¢‘ 3 -->
            <div class="video-card">
                <div class="video-wrapper">
                    <video 
                        class="test-video" 
                        data-video-id="test-3"
                        data-title="ASMR è¶…ç°å®åœŸå¸æ¶‚æŠ¹"
                        poster="/templates/thumbnails/asmr-surreal-toast-spread-thumbnail.jpg"
                        muted
                        playsInline
                        preload="metadata">
                        <source src="/templates/videos/asmr-surreal-toast-spread.mp4" type="video/mp4">
                    </video>
                    <div class="status-indicator" id="status-test-3">ç­‰å¾…ä¸­</div>
                </div>
                <div class="video-info">
                    <div class="video-title">ASMR è¶…ç°å®åœŸå¸æ¶‚æŠ¹</div>
                    <div class="video-description">æ”¾æ¾çš„ASMRè§†é¢‘ï¼Œå±•ç¤ºè¶…ç°å®çš„åœŸå¸æ¶‚æŠ¹è¿‡ç¨‹ï¼Œå¸¦æ¥èˆ’ç¼“çš„æ„Ÿå®˜ä½“éªŒã€‚</div>
                </div>
            </div>
        </div>

        <div class="debug-info" id="debugLog">
è°ƒè¯•æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º...
é¼ æ ‡æ‚¬åœåœ¨è§†é¢‘ä¸Šæµ‹è¯•æ’­æ”¾åŠŸèƒ½
è§‚å¯ŸMedia Fragmentsä¿®å¤æ•ˆæœ
        </div>
    </div>

    <script>
        // è°ƒè¯•æ—¥å¿—ç®¡ç†
        let debugMessages = [];
        
        function addDebugMessage(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugMessages.push(`[${timestamp}] ${message}`);
            updateDebugLog();
        }
        
        function updateDebugLog() {
            const logElement = document.getElementById('debugLog');
            logElement.textContent = debugMessages.slice(-20).join('\n'); // åªæ˜¾ç¤ºæœ€è¿‘20æ¡
        }
        
        function clearDebugLog() {
            debugMessages = [];
            updateDebugLog();
        }

        // è§†é¢‘çŠ¶æ€ç®¡ç†
        const videoStates = new Map();
        let currentPlayingVideo = null;

        // æ¨¡æ‹Ÿ Media Fragments ä¼˜åŒ–
        function getOptimizedVideoUrl(originalSrc, isForHoverPreview = false) {
            const url = new URL(originalSrc, window.location.origin);
            
            if (isForHoverPreview) {
                // æ‚¬åœé¢„è§ˆï¼šæ’­æ”¾å®Œæ•´è§†é¢‘ï¼Œåªè®¾ç½®å¼€å§‹æ—¶é—´é¿å¼€é»‘å±
                url.hash = 't=0.1';
                addDebugMessage(`ğŸ¬ ä½¿ç”¨æ‚¬åœé¢„è§ˆæ¨¡å¼ï¼ˆå®Œæ•´è§†é¢‘ï¼‰: ${url.pathname}#t=0.1`);
            } else {
                // æ™®é€šæ¨¡å¼ï¼šä½¿ç”¨çŸ­ç‰‡æ®µè¿›è¡Œå¿«é€Ÿé¢„åŠ è½½
                url.hash = 't=0.1,0.3';
                addDebugMessage(`ğŸ“± ä½¿ç”¨æ™®é€šé¢„è§ˆæ¨¡å¼: ${url.pathname}#t=0.1,0.3`);
            }
            
            return url.toString();
        }

        // æ›´æ–°è§†é¢‘çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateVideoStatus(videoId, status, extraInfo = '') {
            const statusElement = document.getElementById(`status-${videoId}`);
            if (statusElement) {
                statusElement.textContent = status + (extraInfo ? ` ${extraInfo}` : '');
                statusElement.className = 'status-indicator';
                
                if (status.includes('æ’­æ”¾')) {
                    statusElement.classList.add('playing');
                } else if (status.includes('åŠ è½½')) {
                    statusElement.classList.add('loading');
                } else if (status.includes('é”™è¯¯')) {
                    statusElement.classList.add('error');
                }
            }
        }

        // åœæ­¢æ‰€æœ‰è§†é¢‘
        function stopAllVideos() {
            document.querySelectorAll('.test-video').forEach(video => {
                if (!video.paused) {
                    video.pause();
                    video.currentTime = 0;
                    const videoId = video.dataset.videoId;
                    updateVideoStatus(videoId, 'å·²åœæ­¢');
                    addDebugMessage(`â¹ï¸ æ‰‹åŠ¨åœæ­¢è§†é¢‘: ${videoId}`);
                }
            });
            currentPlayingVideo = null;
        }

        // åˆå§‹åŒ–è§†é¢‘äº‹ä»¶ç›‘å¬
        function initializeVideo(video) {
            const videoId = video.dataset.videoId;
            const videoTitle = video.dataset.title;
            
            addDebugMessage(`ğŸ”§ åˆå§‹åŒ–è§†é¢‘: ${videoId} - ${videoTitle}`);
            
            // è§†é¢‘äº‹ä»¶ç›‘å¬
            video.addEventListener('loadstart', () => {
                addDebugMessage(`ğŸ“¡ å¼€å§‹åŠ è½½: ${videoId}`);
                updateVideoStatus(videoId, 'å¼€å§‹åŠ è½½');
            });
            
            video.addEventListener('loadedmetadata', () => {
                addDebugMessage(`ğŸ“Š å…ƒæ•°æ®åŠ è½½å®Œæˆ: ${videoId} (æ—¶é•¿: ${video.duration.toFixed(1)}s)`);
                updateVideoStatus(videoId, 'å…ƒæ•°æ®å°±ç»ª', `${video.duration.toFixed(1)}s`);
            });
            
            video.addEventListener('canplay', () => {
                addDebugMessage(`âœ… å¯ä»¥æ’­æ”¾: ${videoId}`);
                updateVideoStatus(videoId, 'å‡†å¤‡æ’­æ”¾');
            });
            
            video.addEventListener('play', () => {
                addDebugMessage(`â–¶ï¸ å¼€å§‹æ’­æ”¾: ${videoId}`);
                updateVideoStatus(videoId, 'æ­£åœ¨æ’­æ”¾');
                currentPlayingVideo = video;
            });
            
            video.addEventListener('pause', () => {
                addDebugMessage(`â¸ï¸ æš‚åœæ’­æ”¾: ${videoId}`);
                updateVideoStatus(videoId, 'å·²æš‚åœ');
                if (currentPlayingVideo === video) {
                    currentPlayingVideo = null;
                }
            });
            
            video.addEventListener('ended', () => {
                addDebugMessage(`ğŸ æ’­æ”¾ç»“æŸ: ${videoId} (å½“å‰æ—¶é—´: ${video.currentTime.toFixed(1)}s)`);
                updateVideoStatus(videoId, 'æ’­æ”¾ç»“æŸ');
                video.currentTime = 0; // é‡ç½®åˆ°å¼€å§‹
                if (currentPlayingVideo === video) {
                    currentPlayingVideo = null;
                }
            });
            
            video.addEventListener('error', (e) => {
                addDebugMessage(`âŒ æ’­æ”¾é”™è¯¯: ${videoId} - ${e.message || 'æœªçŸ¥é”™è¯¯'}`);
                updateVideoStatus(videoId, 'æ’­æ”¾é”™è¯¯');
            });
            
            video.addEventListener('timeupdate', () => {
                if (!video.paused) {
                    updateVideoStatus(videoId, 'æ­£åœ¨æ’­æ”¾', `${video.currentTime.toFixed(1)}s/${video.duration.toFixed(1)}s`);
                }
            });

            // é¼ æ ‡æ‚¬åœäº‹ä»¶
            let hoverTimeout = null;
            
            video.parentElement.addEventListener('mouseenter', () => {
                addDebugMessage(`ğŸ–±ï¸ é¼ æ ‡æ‚¬åœå¼€å§‹: ${videoId}`);
                
                // 200ms å»¶è¿Ÿï¼Œæ¨¡æ‹ŸçœŸå®çš„æ‚¬åœè¡Œä¸º
                hoverTimeout = setTimeout(() => {
                    if (currentPlayingVideo && currentPlayingVideo !== video) {
                        addDebugMessage(`â¹ï¸ åœæ­¢å…¶ä»–è§†é¢‘: ${currentPlayingVideo.dataset.videoId}`);
                        currentPlayingVideo.pause();
                        currentPlayingVideo.currentTime = 0;
                    }
                    
                    // ğŸš€ å…³é”®ä¿®å¤ï¼šåˆ‡æ¢åˆ°æ‚¬åœé¢„è§ˆæ¨¡å¼çš„URL
                    const originalSrc = video.querySelector('source').src;
                    const hoverSrc = getOptimizedVideoUrl(originalSrc, true);
                    
                    if (video.src !== hoverSrc) {
                        addDebugMessage(`ğŸ”„ åˆ‡æ¢åˆ°æ‚¬åœé¢„è§ˆæ¨¡å¼: ${videoId}`);
                        video.src = hoverSrc;
                        video.load();
                        
                        // ç­‰å¾…è§†é¢‘åŠ è½½åæ’­æ”¾
                        video.addEventListener('canplay', function playOnCanPlay() {
                            video.removeEventListener('canplay', playOnCanPlay);
                            video.play().catch(err => {
                                addDebugMessage(`âŒ æ’­æ”¾å¤±è´¥: ${videoId} - ${err.message}`);
                            });
                        });
                    } else {
                        video.play().catch(err => {
                            addDebugMessage(`âŒ æ’­æ”¾å¤±è´¥: ${videoId} - ${err.message}`);
                        });
                    }
                }, 200);
            });
            
            video.parentElement.addEventListener('mouseleave', () => {
                addDebugMessage(`ğŸ–±ï¸ é¼ æ ‡ç¦»å¼€: ${videoId}`);
                
                if (hoverTimeout) {
                    clearTimeout(hoverTimeout);
                    hoverTimeout = null;
                }
                
                if (!video.paused) {
                    video.pause();
                    video.currentTime = 0;
                }
                
                // ğŸš€ æ¢å¤åˆ°æ™®é€šé¢„è§ˆæ¨¡å¼
                const originalSrc = video.querySelector('source').src;
                const normalSrc = getOptimizedVideoUrl(originalSrc, false);
                
                if (video.src !== normalSrc) {
                    addDebugMessage(`ğŸ”„ æ¢å¤åˆ°æ™®é€šé¢„è§ˆæ¨¡å¼: ${videoId}`);
                    video.src = normalSrc;
                    video.load();
                }
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ‰€æœ‰è§†é¢‘
        document.addEventListener('DOMContentLoaded', () => {
            addDebugMessage('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–è§†é¢‘æ’­æ”¾å™¨');
            
            document.querySelectorAll('.test-video').forEach(initializeVideo);
            
            addDebugMessage('âœ… æ‰€æœ‰è§†é¢‘æ’­æ”¾å™¨åˆå§‹åŒ–å®Œæˆ');
            addDebugMessage('');
            addDebugMessage('ğŸ“‹ æµ‹è¯•è¯´æ˜:');
            addDebugMessage('1. é¼ æ ‡æ‚¬åœåœ¨è§†é¢‘ä¸Šåº”è¯¥å¼€å§‹æ’­æ”¾');
            addDebugMessage('2. æ’­æ”¾åº”è¯¥æ˜¯å®Œæ•´è§†é¢‘è€Œä¸æ˜¯0.2ç§’ç‰‡æ®µ');
            addDebugMessage('3. é¼ æ ‡ç¦»å¼€æ—¶è§†é¢‘åº”è¯¥åœæ­¢å¹¶é‡ç½®');
            addDebugMessage('4. è§‚å¯Ÿè°ƒè¯•æ—¥å¿—ä¸­çš„URLç‰‡æ®µå˜åŒ–');
            addDebugMessage('');
        });
    </script>
</body>
</html>
/**
 * å¢å¼ºç‰ˆè§†é¢‘å¡ç‰‡ç»„ä»¶
 * 
 * ç‰¹æ€§ï¼š
 * 1. æ™ºèƒ½ç¼©ç•¥å›¾æ˜¾ç¤º
 * 2. æ‚¬æµ®æ—¶æ‡’åŠ è½½è§†é¢‘é¢„è§ˆ
 * 3. ç½‘ç»œè‡ªé€‚åº”åŠ è½½ç­–ç•¥
 * 4. æµç•…çš„äº¤äº’åŠ¨ç”»
 * 5. é”™è¯¯å›é€€æœºåˆ¶
 */

import React, { useState, useEffect, useCallback, useRef } from 'react'
import { Card, CardContent } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { 
  Play, 
  Download, 
  Share2, 
  Eye, 
  Clock, 
  Gem,
  CheckCircle,
  XCircle,
  Loader2,
  Pause,
  Volume2,
  VolumeX
} from 'lucide-react'
import { cn } from '@/utils/cn'
import { useTranslation } from 'react-i18next'
import { thumbnailCacheService } from '@/services/ThumbnailCacheService'
import { videoPreloadManager } from '@/services/VideoPreloadManager'
import type { Database } from '@/lib/supabase'

type VideoRecord = Database['public']['Tables']['videos']['Row']

interface EnhancedVideoCardProps {
  video: VideoRecord
  onPlay?: () => void
  onDownload?: () => void
  onShare?: () => void
  onSelect?: () => void
  className?: string
  enableHoverPreview?: boolean
  preloadDelay?: number
  showStats?: boolean
  compact?: boolean
}

export default function EnhancedVideoCard({
  video,
  onPlay,
  onDownload,
  onShare,
  onSelect,
  className,
  enableHoverPreview = true,
  preloadDelay = 500,
  showStats = true,
  compact = false
}: EnhancedVideoCardProps) {
  // ğŸš¨ å¼ºåˆ¶æµ‹è¯•æ—¥å¿— - è¿™ä¸ªæ—¥å¿—æ— è®ºä»€ä¹ˆæƒ…å†µéƒ½åº”è¯¥å‡ºç°
  console.log(`ğŸš¨ [FORCE-LOG] EnhancedVideoCardæ¸²æŸ“å¼€å§‹`, {
    videoId: video.id,
    videoTitle: video.title,
    videoStatus: video.status,
    hasThumbnail: !!video.thumbnail_url,
    timestamp: new Date().toISOString()
  })
  
  const { t } = useTranslation()
  const cardRef = useRef<HTMLDivElement>(null)
  const videoRef = useRef<HTMLVideoElement | null>(null)
  
  // çŠ¶æ€ç®¡ç†
  const [isHovering, setIsHovering] = useState(false)
  const [thumbnailState, setThumbnailState] = useState<{
    loading: boolean
    normal?: string
    blur?: string
    error?: string
  }>(() => {
    // æ™ºèƒ½åˆå§‹åŒ–ï¼šå¦‚æœæœ‰ç°æˆçš„ç¼©ç•¥å›¾ï¼Œç›´æ¥è®¾ç½®ä¸ºå¯ç”¨çŠ¶æ€
    if (video.thumbnail_url) {
      console.log(`ğŸ–¼ï¸ [${video.id}] åˆå§‹åŒ–ï¼šç›´æ¥ä½¿ç”¨æ•°æ®åº“ç¼©ç•¥å›¾`, {
        thumbnail_url: video.thumbnail_url,
        blur_url: video.thumbnail_blur_url,
        video_status: video.status
      })
      return {
        loading: false,
        normal: video.thumbnail_url,
        blur: video.thumbnail_blur_url || video.thumbnail_url
      }
    }
    // åªæœ‰åœ¨æ²¡æœ‰ç¼©ç•¥å›¾æ—¶æ‰æ˜¾ç¤ºloadingçŠ¶æ€
    console.log(`â³ [${video.id}] åˆå§‹åŒ–ï¼šæ— ç¼©ç•¥å›¾ï¼Œæ˜¾ç¤ºloadingçŠ¶æ€`, {
      video_status: video.status,
      has_video_url: !!video.video_url
    })
    return { loading: true }
  })
  const [previewState, setPreviewState] = useState<{
    loading: boolean
    loaded: boolean
    playing: boolean
    error?: string
  }>({ loading: false, loaded: false, playing: false })
  const [isMuted, setIsMuted] = useState(true)

  // åˆå§‹åŒ–ç¼©ç•¥å›¾ï¼ˆæ™ºèƒ½æ£€æµ‹æ˜¯å¦éœ€è¦ç«‹å³ç”Ÿæˆï¼‰
  useEffect(() => {
    initializeThumbnail()
  }, [video.id, video.video_url, video.thumbnail_url, video.status])

  // ç›‘å¬è§†é¢‘çŠ¶æ€å˜åŒ–ï¼Œå½“çŠ¶æ€å˜ä¸ºcompletedæ—¶ç«‹å³å°è¯•ç”Ÿæˆç¼©ç•¥å›¾
  useEffect(() => {
    if (video.status === 'completed' && video.video_url && !thumbnailState.normal) {
      console.log(`[EnhancedVideoCard] è§†é¢‘åˆšå®Œæˆï¼Œè§¦å‘ç¼©ç•¥å›¾æ£€æŸ¥: ${video.id}`)
      // å»¶è¿Ÿä¸€å°æ®µæ—¶é—´ï¼Œç¡®ä¿ç¼©ç•¥å›¾ç”ŸæˆæœåŠ¡å·²ç»å¤„ç†
      setTimeout(() => {
        initializeThumbnail()
      }, 1000)
    }
  }, [video.status, video.video_url])

  // ç›‘å¬çœŸå®ç¼©ç•¥å›¾æå–å®Œæˆäº‹ä»¶
  useEffect(() => {
    const handleThumbnailReady = (event: CustomEvent) => {
      if (event.detail.videoId === video.id) {
        console.log(`[EnhancedVideoCard] æ”¶åˆ°çœŸå®ç¼©ç•¥å›¾: ${video.id}`)
        setThumbnailState({
          loading: false,
          normal: event.detail.thumbnails.normal,
          blur: event.detail.thumbnails.blur
        })
      }
    }

    const handleThumbnailExtracted = (event: CustomEvent) => {
      if (event.detail.videoId === video.id) {
        console.log(`[EnhancedVideoCard] æ”¶åˆ°æå–çš„ç¼©ç•¥å›¾: ${video.id}`)
        setThumbnailState({
          loading: false,
          normal: event.detail.thumbnails.normal,
          blur: event.detail.thumbnails.blur
        })
      }
    }

    window.addEventListener('thumbnailReady', handleThumbnailReady as EventListener)
    window.addEventListener('thumbnailExtracted', handleThumbnailExtracted as EventListener)

    return () => {
      window.removeEventListener('thumbnailReady', handleThumbnailReady as EventListener)
      window.removeEventListener('thumbnailExtracted', handleThumbnailExtracted as EventListener)
    }
  }, [video.id])

  /**
   * åˆå§‹åŒ–ç¼©ç•¥å›¾ï¼ˆæ™ºèƒ½æ£€æŸ¥ï¼Œé¿å…ä¸å¿…è¦çš„loadingçŠ¶æ€ï¼‰
   */
  const initializeThumbnail = async () => {
    const startTime = performance.now()
    try {
      // å¦‚æœå·²ç»æœ‰ç¼©ç•¥å›¾æ˜¾ç¤ºï¼Œå…ˆå¯åŠ¨åå°ä¼˜åŒ–ä»»åŠ¡ï¼Œä¸æ‰“æ–­å½“å‰æ˜¾ç¤º
      if (video.thumbnail_url) {
        console.log(`ğŸš€ [${video.id}] initializeThumbnail: å·²æœ‰æ•°æ®åº“ç¼©ç•¥å›¾ï¼Œå¯åŠ¨åå°ä¼˜åŒ–`, {
          current_thumbnail: video.thumbnail_url,
          execution_time: 0
        })
        // åå°å¼‚æ­¥æ£€æŸ¥æ˜¯å¦æœ‰æ›´å¥½çš„çœŸå®ç¼©ç•¥å›¾
        optimizeThumbnailInBackground()
        return
      }

      // åªæœ‰åœ¨æ²¡æœ‰ç¼©ç•¥å›¾æ—¶æ‰æ˜¾ç¤ºloadingçŠ¶æ€
      console.log(`â³ [${video.id}] è®¾ç½®loadingçŠ¶æ€ï¼Œå¼€å§‹ç¼©ç•¥å›¾æ£€æŸ¥æµç¨‹`)
      setThumbnailState(prev => ({ ...prev, loading: true }))

      // 1. ä¼˜å…ˆæ£€æŸ¥æœ¬åœ°ç¼“å­˜çš„çœŸå®ç¼©ç•¥å›¾
      if (video.status === 'completed' && video.video_url) {
        console.log(`ğŸ” [${video.id}] æ£€æŸ¥æœ¬åœ°ç¼“å­˜çš„çœŸå®ç¼©ç•¥å›¾...`)
        const realThumbnail = await thumbnailCacheService.getRealThumbnailFirst(video.id, video.video_url)
        if (realThumbnail) {
          const elapsedTime = performance.now() - startTime
          console.log(`âœ… [${video.id}] æ‰¾åˆ°æœ¬åœ°çœŸå®ç¼©ç•¥å›¾`, {
            execution_time: `${elapsedTime.toFixed(2)}ms`,
            thumbnail_size: realThumbnail.normal.length
          })
          setThumbnailState({
            loading: false,
            normal: realThumbnail.normal,
            blur: realThumbnail.blur
          })
          return
        }

        // 2. å¦‚æœæ²¡æœ‰çœŸå®ç¼©ç•¥å›¾ï¼Œå°è¯•ç”Ÿæˆä¸€ä¸ª
        console.log(`ğŸ¬ [${video.id}] æœ¬åœ°æ— ç¼“å­˜ï¼Œå¼€å§‹å®æ—¶ç”ŸæˆçœŸå®ç¼©ç•¥å›¾...`)
        try {
          const generatedThumbnail = await thumbnailCacheService.extractAndCacheRealThumbnail(video.id, video.video_url)
          if (generatedThumbnail) {
            const elapsedTime = performance.now() - startTime
            console.log(`âœ… [${video.id}] å®æ—¶ç”ŸæˆçœŸå®ç¼©ç•¥å›¾æˆåŠŸ`, {
              execution_time: `${elapsedTime.toFixed(2)}ms`,
              thumbnail_size: generatedThumbnail.normal.length
            })
            setThumbnailState({
              loading: false,
              normal: generatedThumbnail.normal,
              blur: generatedThumbnail.blur
            })
            return
          }
        } catch (extractError) {
          const elapsedTime = performance.now() - startTime
          console.warn(`âŒ [${video.id}] å®æ—¶ç”ŸæˆçœŸå®ç¼©ç•¥å›¾å¤±è´¥`, {
            execution_time: `${elapsedTime.toFixed(2)}ms`,
            error: extractError
          })
          // ç»§ç»­æ‰§è¡Œåç»­é€»è¾‘
        }
      }

      // 3. æœ€åä½¿ç”¨çŠ¶æ€å ä½å›¾ï¼ˆéå®ŒæˆçŠ¶æ€çš„è§†é¢‘ï¼‰
      if (video.status !== 'completed') {
        console.log(`[EnhancedVideoCard] è§†é¢‘æœªå®Œæˆï¼Œæ˜¾ç¤ºçŠ¶æ€å ä½å›¾: ${video.id}`)
        setThumbnailState({ loading: false })
      } else {
        // å®Œæˆçš„è§†é¢‘å¦‚æœåˆ°è¿™é‡Œï¼Œè¯´æ˜æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥äº†
        console.warn(`[EnhancedVideoCard] å®Œæˆçš„è§†é¢‘æ— æ³•ç”Ÿæˆç¼©ç•¥å›¾: ${video.id}`)
        setThumbnailState({
          loading: false,
          error: 'æ— æ³•ç”Ÿæˆç¼©ç•¥å›¾'
        })
      }
    } catch (error) {
      console.error(`[EnhancedVideoCard] ç¼©ç•¥å›¾åˆå§‹åŒ–å¤±è´¥:`, error)
      setThumbnailState({
        loading: false,
        error: error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'
      })
    }
  }

  /**
   * åå°å¼‚æ­¥ä¼˜åŒ–ç¼©ç•¥å›¾ï¼ˆä¸å½±å“å½“å‰æ˜¾ç¤ºï¼‰
   */
  const optimizeThumbnailInBackground = async () => {
    const startTime = performance.now()
    try {
      if (video.status !== 'completed' || !video.video_url) {
        console.log(`â­ï¸ [${video.id}] åå°ä¼˜åŒ–è·³è¿‡ï¼šè§†é¢‘æœªå®Œæˆæˆ–æ— è§†é¢‘URL`)
        return
      }

      console.log(`ğŸ”„ [${video.id}] å¼€å§‹åå°ç¼©ç•¥å›¾ä¼˜åŒ–æ£€æŸ¥...`)
      
      // æ£€æŸ¥æ˜¯å¦å·²æœ‰çœŸå®ç¼©ç•¥å›¾
      const realThumbnail = await thumbnailCacheService.getRealThumbnailFirst(video.id, video.video_url)
      if (realThumbnail) {
        const elapsedTime = performance.now() - startTime
        // é™é»˜æ›´æ–°ä¸ºæ›´å¥½çš„çœŸå®ç¼©ç•¥å›¾
        console.log(`ğŸ”„âœ… [${video.id}] åå°æ‰¾åˆ°æ›´å¥½çš„çœŸå®ç¼©ç•¥å›¾ï¼Œé™é»˜æ›´æ–°`, {
          execution_time: `${elapsedTime.toFixed(2)}ms`,
          new_thumbnail_size: realThumbnail.normal.length
        })
        setThumbnailState(prev => ({
          ...prev,
          normal: realThumbnail.normal,
          blur: realThumbnail.blur
        }))
        return
      }

      // å¦‚æœæ²¡æœ‰çœŸå®ç¼©ç•¥å›¾ï¼Œåå°é™é»˜ç”Ÿæˆ
      console.log(`ğŸ”„ğŸ¬ [${video.id}] åå°å¼€å§‹é™é»˜ç”ŸæˆçœŸå®ç¼©ç•¥å›¾...`)
      const generatedThumbnail = await thumbnailCacheService.extractAndCacheRealThumbnail(video.id, video.video_url)
      if (generatedThumbnail) {
        const elapsedTime = performance.now() - startTime
        console.log(`ğŸ”„âœ… [${video.id}] åå°ç”ŸæˆçœŸå®ç¼©ç•¥å›¾æˆåŠŸï¼Œé™é»˜æ›´æ–°`, {
          execution_time: `${elapsedTime.toFixed(2)}ms`,
          new_thumbnail_size: generatedThumbnail.normal.length
        })
        setThumbnailState(prev => ({
          ...prev,
          normal: generatedThumbnail.normal,
          blur: generatedThumbnail.blur
        }))
      }
    } catch (error) {
      const elapsedTime = performance.now() - startTime
      console.warn(`ğŸ”„âŒ [${video.id}] åå°ç¼©ç•¥å›¾ä¼˜åŒ–å¤±è´¥`, {
        execution_time: `${elapsedTime.toFixed(2)}ms`,
        error: error
      })
      // åå°ä»»åŠ¡å¤±è´¥ä¸å½±å“ç”¨æˆ·ä½“éªŒï¼Œåªè®°å½•æ—¥å¿—
    }
  }

  /**
   * å¤„ç†é¼ æ ‡æ‚¬æµ®
   */
  const handleMouseEnter = useCallback(() => {
    setIsHovering(true)

    // å¦‚æœå¯ç”¨æ‚¬æµ®é¢„è§ˆä¸”è§†é¢‘å¯æ’­æ”¾
    if (enableHoverPreview && video.status === 'completed' && video.video_url) {
      setPreviewState(prev => ({ ...prev, loading: true }))
      
      // å¼€å§‹é¢„åŠ è½½
      videoPreloadManager.startPreload(video.id, video.video_url, {
        delay: preloadDelay,
        priority: 'medium',
        preloadStrategy: 'partial'
      })

      // å»¶è¿Ÿæ£€æŸ¥é¢„åŠ è½½ç»“æœ
      setTimeout(() => {
        const preloadedVideo = videoPreloadManager.getPreloadedVideo(video.id)
        if (preloadedVideo && isHovering) {
          videoRef.current = preloadedVideo
          setPreviewState({
            loading: false,
            loaded: true,
            playing: true
          })
          
          // å¼€å§‹æ’­æ”¾é¢„è§ˆ
          preloadedVideo.currentTime = 0
          preloadedVideo.muted = true
          preloadedVideo.loop = true
          preloadedVideo.play().catch(console.error)
        } else {
          setPreviewState(prev => ({ ...prev, loading: false }))
        }
      }, preloadDelay + 100)
    }
  }, [enableHoverPreview, video.id, video.video_url, video.status, preloadDelay, isHovering])

  /**
   * å¤„ç†é¼ æ ‡ç¦»å¼€
   */
  const handleMouseLeave = useCallback(() => {
    setIsHovering(false)
    
    // å–æ¶ˆé¢„åŠ è½½
    videoPreloadManager.cancelPreload(video.id)
    
    // åœæ­¢é¢„è§ˆæ’­æ”¾
    if (videoRef.current) {
      videoRef.current.pause()
      videoRef.current.currentTime = 0
    }
    
    setPreviewState({
      loading: false,
      loaded: false,
      playing: false
    })
  }, [video.id])

  /**
   * å¤„ç†æ’­æ”¾æŒ‰é’®ç‚¹å‡»
   */
  const handlePlayClick = useCallback((e: React.MouseEvent) => {
    e.stopPropagation()
    onPlay?.()
  }, [onPlay])

  /**
   * å¤„ç†éŸ³é¢‘åˆ‡æ¢
   */
  const handleVolumeToggle = useCallback((e: React.MouseEvent) => {
    e.stopPropagation()
    if (videoRef.current) {
      const newMuted = !isMuted
      videoRef.current.muted = newMuted
      setIsMuted(newMuted)
    }
  }, [isMuted])

  /**
   * è·å–çŠ¶æ€å›¾æ ‡
   */
  const getStatusIcon = () => {
    switch (video.status) {
      case 'completed':
        return <CheckCircle className="h-4 w-4 text-green-500" />
      case 'failed':
        return <XCircle className="h-4 w-4 text-red-500" />
      case 'processing':
        return <Loader2 className="h-4 w-4 text-blue-500 animate-spin" />
      default:
        return <Clock className="h-4 w-4 text-yellow-500" />
    }
  }

  /**
   * è·å–çŠ¶æ€æ–‡æœ¬
   */
  const getStatusText = () => {
    switch (video.status) {
      case 'completed':
        return t('video.status.completed')
      case 'failed':
        return t('video.status.failed')
      case 'processing':
        return t('video.status.processing')
      default:
        return t('video.status.pending')
    }
  }

  /**
   * æ ¼å¼åŒ–æ—¶é—´
   */
  const formatDate = (dateString: string) => {
    return new Intl.DateTimeFormat('zh-CN', {
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    }).format(new Date(dateString))
  }

  /**
   * æ ¼å¼åŒ–æŒç»­æ—¶é—´
   */
  const formatDuration = (seconds?: number) => {
    if (!seconds) return 'N/A'
    const mins = Math.floor(seconds / 60)
    const secs = Math.floor(seconds % 60)
    return `${mins}:${secs.toString().padStart(2, '0')}`
  }

  /**
   * æ¸²æŸ“ç¼©ç•¥å›¾/é¢„è§ˆåŒºåŸŸ
   */
  const renderMediaArea = () => {
    const aspectRatio = compact ? 'aspect-video' : 'aspect-video'
    
    // è®°å½•æ¸²æŸ“çŠ¶æ€
    console.log(`ğŸ¨ [${video.id}] æ¸²æŸ“åª’ä½“åŒºåŸŸ`, {
      has_normal: !!thumbnailState.normal,
      has_blur: !!thumbnailState.blur,
      is_loading: thumbnailState.loading,
      is_playing: previewState.playing,
      has_error: !!thumbnailState.error
    })
    
    return (
      <div className={cn("relative bg-muted overflow-hidden", aspectRatio)}>
        {/* ç¼©ç•¥å›¾å±‚ */}
        {thumbnailState.normal && !previewState.playing && (
          <img
            src={thumbnailState.normal}
            alt={video.title || 'Video thumbnail'}
            className="absolute inset-0 w-full h-full object-cover transition-opacity duration-300"
            onLoad={() => {
              console.log(`ğŸ–¼ï¸âœ… [${video.id}] ç¼©ç•¥å›¾åŠ è½½æˆåŠŸ`)
            }}
            onError={(e) => {
              console.warn(`ğŸ–¼ï¸âŒ [${video.id}] ç¼©ç•¥å›¾åŠ è½½å¤±è´¥ï¼Œå°è¯•fallback`, {
                failed_src: (e.target as HTMLImageElement).src,
                has_blur_fallback: !!thumbnailState.blur
              })
              // å›é€€åˆ°æ¨¡ç³Šç‰ˆæœ¬æˆ–é»˜è®¤å ä½ç¬¦
              const target = e.target as HTMLImageElement
              if (thumbnailState.blur && target.src !== thumbnailState.blur) {
                target.src = thumbnailState.blur
              }
            }}
          />
        )}

        {/* æ¨¡ç³Šå ä½ç¬¦ */}
        {thumbnailState.blur && thumbnailState.loading && (
          <img
            src={thumbnailState.blur}
            alt="Thumbnail placeholder"
            className="absolute inset-0 w-full h-full object-cover blur-md opacity-50"
          />
        )}

        {/* è§†é¢‘é¢„è§ˆå±‚ */}
        {previewState.loaded && videoRef.current && (
          <div className="absolute inset-0">
            {/* è¿™é‡Œæˆ‘ä»¬ä¼šåœ¨DOMä¸­æ’å…¥é¢„åŠ è½½çš„videoå…ƒç´  */}
            <div 
              ref={(el) => {
                if (el && videoRef.current && !el.contains(videoRef.current)) {
                  videoRef.current.className = "w-full h-full object-cover"
                  el.appendChild(videoRef.current)
                }
              }}
              className="w-full h-full"
            />
          </div>
        )}

        {/* æ™ºèƒ½å ä½ç¬¦ï¼ˆä»…ç”¨äºéå®ŒæˆçŠ¶æ€æˆ–é”™è¯¯æƒ…å†µï¼‰ */}
        {!thumbnailState.normal && !thumbnailState.loading && (
          <div className="absolute inset-0 flex items-center justify-center bg-gradient-to-br from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20">
            {thumbnailState.error ? (
              <div className="text-center p-4">
                <XCircle className="h-8 w-8 text-red-400 mx-auto mb-2" />
                <div className="text-xs text-red-500 break-words max-w-[200px]">
                  {thumbnailState.error}
                </div>
              </div>
            ) : video.status === 'completed' ? (
              // å·²å®Œæˆçš„è§†é¢‘æ˜¾ç¤º"æ­£åœ¨ç”Ÿæˆç¼©ç•¥å›¾"
              <div className="text-center p-4">
                <Loader2 className="h-8 w-8 text-blue-400 mx-auto mb-2 animate-spin" />
                <div className="text-xs text-blue-600 dark:text-blue-400">
                  æ­£åœ¨ç”Ÿæˆç¼©ç•¥å›¾...
                </div>
              </div>
            ) : (
              // å…¶ä»–çŠ¶æ€æ˜¾ç¤ºæ’­æ”¾å›¾æ ‡
              <Play className="h-12 w-12 text-muted-foreground" />
            )}
          </div>
        )}

        {/* åŠ è½½çŠ¶æ€è¦†ç›–å±‚ï¼ˆä»…åœ¨ç¡®å®éœ€è¦ç­‰å¾…ä¸”æ²¡æœ‰å¯æ˜¾ç¤ºç¼©ç•¥å›¾æ—¶ï¼‰ */}
        {thumbnailState.loading && video.status === 'completed' && !thumbnailState.normal && (
          <div className="absolute inset-0 flex items-center justify-center bg-black/30">
            <div className="text-center">
              <Loader2 className="h-8 w-8 text-white animate-spin mx-auto mb-2" />
              <div className="text-xs text-white opacity-90">
                ç”Ÿæˆç¼©ç•¥å›¾...
              </div>
            </div>
          </div>
        )}

        {/* è§†é¢‘é¢„è§ˆåŠ è½½çŠ¶æ€ */}
        {previewState.loading && (
          <div className="absolute inset-0 flex items-center justify-center bg-black/20">
            <Loader2 className="h-6 w-6 text-white animate-spin" />
          </div>
        )}

        {/* äº¤äº’æ§åˆ¶å±‚ */}
        <div className="absolute inset-0 flex items-center justify-center bg-black/0 hover:bg-black/30 transition-colors group">
          {/* æ’­æ”¾æŒ‰é’® */}
          {video.status === 'completed' && (
            <Button
              variant="secondary"
              size="lg"
              className={cn(
                "w-16 h-16 rounded-full bg-black/70 hover:bg-black/90 border-0 transition-all duration-200",
                "opacity-0 group-hover:opacity-100 hover:scale-110",
                previewState.playing && "opacity-0"
              )}
              onClick={handlePlayClick}
            >
              <Play className="h-8 w-8 text-white ml-1" />
            </Button>
          )}

          {/* è§†é¢‘æ§åˆ¶æŒ‰é’® */}
          {previewState.playing && (
            <div className="absolute bottom-2 right-2 flex gap-1">
              <Button
                variant="secondary"
                size="sm"
                className="h-8 w-8 rounded-full bg-black/70 hover:bg-black/90 border-0 p-0"
                onClick={handleVolumeToggle}
              >
                {isMuted ? (
                  <VolumeX className="h-3 w-3 text-white" />
                ) : (
                  <Volume2 className="h-3 w-3 text-white" />
                )}
              </Button>
            </div>
          )}
        </div>

        {/* çŠ¶æ€æ ‡è¯† */}
        <div className="absolute top-2 left-2">
          <Badge variant="secondary" className="bg-black/70 text-white border-0">
            {getStatusIcon()}
            <span className="ml-1 text-xs">{getStatusText()}</span>
          </Badge>
        </div>

        {/* æ—¶é•¿æ ‡è¯† */}
        {video.duration && (
          <div className="absolute bottom-2 left-2">
            <Badge variant="secondary" className="bg-black/70 text-white border-0 text-xs">
              {formatDuration(video.duration)}
            </Badge>
          </div>
        )}
      </div>
    )
  }

  return (
    <Card 
      ref={cardRef}
      className={cn(
        "overflow-hidden cursor-pointer transition-all duration-200",
        "hover:shadow-lg hover:scale-[1.02]",
        isHovering && "ring-2 ring-primary/20",
        className
      )}
      onClick={onSelect}
      onMouseEnter={handleMouseEnter}
      onMouseLeave={handleMouseLeave}
    >
      {/* åª’ä½“åŒºåŸŸ */}
      {renderMediaArea()}

      {/* å¡ç‰‡å†…å®¹ */}
      <CardContent className={cn("p-4", compact && "p-3")}>
        <div className="space-y-2">
          {/* æ ‡é¢˜å’Œæè¿° */}
          <div>
            <h3 className={cn(
              "font-semibold leading-tight line-clamp-2",
              compact ? "text-sm" : "text-base"
            )}>
              {video.title || `è§†é¢‘ ${formatDate(video.created_at)}`}
            </h3>
            {video.description && !compact && (
              <p className="text-sm text-muted-foreground line-clamp-2 mt-1">
                {video.description}
              </p>
            )}
          </div>

          {/* ç»Ÿè®¡ä¿¡æ¯ */}
          {showStats && (
            <div className="flex items-center gap-4 text-xs text-muted-foreground">
              <div className="flex items-center gap-1">
                <Eye className="h-3 w-3" />
                <span>{video.view_count || 0}</span>
              </div>
              <div className="flex items-center gap-1">
                <Download className="h-3 w-3" />
                <span>{video.download_count || 0}</span>
              </div>
              <div className="flex items-center gap-1">
                <Gem className="h-3 w-3" />
                <span>{video.credits_used}</span>
              </div>
            </div>
          )}

          {/* æ“ä½œæŒ‰é’® */}
          <div className="flex items-center justify-between pt-2">
            <div className="text-xs text-muted-foreground">
              {formatDate(video.created_at)}
            </div>
            
            <div className="flex items-center gap-1">
              {video.status === 'completed' && onDownload && (
                <Button
                  variant="ghost"
                  size="sm"
                  className="h-8 w-8 p-0"
                  onClick={(e) => {
                    e.stopPropagation()
                    onDownload()
                  }}
                >
                  <Download className="h-3 w-3" />
                </Button>
              )}
              
              {video.status === 'completed' && onShare && (
                <Button
                  variant="ghost"
                  size="sm"
                  className="h-8 w-8 p-0"
                  onClick={(e) => {
                    e.stopPropagation()
                    onShare()
                  }}
                >
                  <Share2 className="h-3 w-3" />
                </Button>
              )}
            </div>
          </div>
        </div>
      </CardContent>
    </Card>
  )
}
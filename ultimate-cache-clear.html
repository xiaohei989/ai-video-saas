<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔥 终极缓存清理工具</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }
        h1 {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .subtitle {
            text-align: center;
            opacity: 0.9;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        .warning {
            background: rgba(255, 152, 0, 0.2);
            border: 2px solid rgba(255, 152, 0, 0.5);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .clear-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border: none;
            color: white;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .clear-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        .nuclear-btn {
            background: linear-gradient(45deg, #c0392b, #e74c3c);
            font-size: 18px;
            padding: 25px;
        }
        .status {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid;
        }
        .success { border-left-color: #2ecc71; }
        .error { border-left-color: #e74c3c; }
        .info { border-left-color: #3498db; }
        .warning-status { border-left-color: #f39c12; }
        
        .progress-bar {
            background: rgba(255, 255, 255, 0.2);
            height: 8px;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-fill {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔥 终极缓存清理工具</h1>
        <p class="subtitle">彻底清除所有低质量缓存，确保只保留高质量图片</p>
        
        <div class="warning">
            <h3>⚠️ 重要提醒</h3>
            <p>此工具将彻底清除所有本地缓存数据，包括图片、模板、用户数据等。</p>
            <p>清理后系统将重新获取高质量内容，首次加载可能稍慢。</p>
        </div>

        <div class="stats-grid" id="currentStats">
            <div class="stat-card">
                <div class="stat-number" id="dbCount">-</div>
                <div>数据库数量</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="storageUsed">-</div>
                <div>存储占用</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="cacheItems">-</div>
                <div>缓存项目</div>
            </div>
        </div>

        <div class="button-grid">
            <button class="clear-btn" onclick="clearLowQualityCache()">
                🗑️ 清理低质量缓存<br>
                <small>只删除 <20KB 的低质量图片缓存</small>
            </button>
            
            <button class="clear-btn" onclick="clearImageCache()">
                🖼️ 清理图片缓存<br>
                <small>清理所有图片相关缓存</small>
            </button>
            
            <button class="clear-btn" onclick="clearIndexedDBCache()">
                💾 清理IndexedDB<br>
                <small>清理所有IndexedDB数据库</small>
            </button>
            
            <button class="clear-btn" onclick="clearBrowserCache()">
                🌐 清理浏览器缓存<br>
                <small>清理localStorage + sessionStorage</small>
            </button>
            
            <button class="clear-btn nuclear-btn" onclick="nuclearClean()">
                ☢️ 核弹级清理<br>
                <small>清理一切可能的缓存数据</small>
            </button>
        </div>

        <div class="progress-bar" id="progressContainer" style="display: none;">
            <div class="progress-fill" id="progressBar" style="width: 0%"></div>
        </div>

        <div id="results"></div>
    </div>

    <script>
        let totalDatabases = 0;
        let currentProgress = 0;

        // 页面加载时获取当前状态
        window.addEventListener('load', () => {
            updateCurrentStats();
        });

        async function updateCurrentStats() {
            try {
                const stats = await getCacheStats();
                document.getElementById('dbCount').textContent = stats.databases;
                document.getElementById('storageUsed').textContent = stats.storage;
                document.getElementById('cacheItems').textContent = stats.items;
            } catch (error) {
                console.error('获取统计失败:', error);
            }
        }

        async function getCacheStats() {
            const databases = await indexedDB.databases();
            const dbCount = databases.length;
            
            let storageUsed = '未知';
            let cacheItems = 0;
            
            try {
                if ('storage' in navigator && 'estimate' in navigator.storage) {
                    const estimate = await navigator.storage.estimate();
                    storageUsed = (estimate.usage / 1024 / 1024).toFixed(1) + 'MB';
                }
                
                // 估算localStorage项目数
                cacheItems = Object.keys(localStorage).length;
            } catch (e) {
                console.warn('获取存储统计失败:', e);
            }
            
            return {
                databases: dbCount,
                storage: storageUsed,
                items: cacheItems
            };
        }

        function showProgress() {
            document.getElementById('progressContainer').style.display = 'block';
            updateProgress(0);
        }

        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }

        function updateProgress(percentage) {
            document.getElementById('progressBar').style.width = percentage + '%';
        }

        function logResult(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
            resultsDiv.appendChild(statusDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        async function clearLowQualityCache() {
            logResult('🔍 开始智能清理低质量缓存...', 'info');
            showProgress();

            let cleanedCount = 0;
            let totalChecked = 0;

            try {
                // 1. 清理localStorage中的低质量Base64图片
                logResult('📊 分析localStorage中的图片缓存...', 'info');
                updateProgress(20);

                const keys = Object.keys(localStorage);
                for (const key of keys) {
                    if (key.includes('img_') || key.includes('cache') || key.includes('thumb')) {
                        try {
                            const data = localStorage.getItem(key);
                            if (data && data.startsWith('data:image')) {
                                const base64Part = data.split(',')[1];
                                if (base64Part) {
                                    const sizeKB = (base64Part.length * 0.75 / 1024);
                                    totalChecked++;
                                    
                                    if (sizeKB < 20) { // 低于20KB认为是低质量
                                        localStorage.removeItem(key);
                                        cleanedCount++;
                                        logResult(`🗑️ 删除低质量缓存: ${key.substring(0, 50)}... (${sizeKB.toFixed(2)}KB)`, 'success');
                                    }
                                }
                            }
                        } catch (e) {
                            console.warn('处理键失败:', key, e);
                        }
                    }
                }

                updateProgress(60);

                // 2. 清理IndexedDB中的低质量缓存
                logResult('💾 清理IndexedDB中的低质量缓存...', 'info');
                
                const databases = await indexedDB.databases();
                for (const db of databases) {
                    if (db.name && (db.name.includes('cache') || db.name.includes('image'))) {
                        try {
                            await deleteDatabase(db.name);
                            logResult(`✅ 清理数据库: ${db.name}`, 'success');
                            cleanedCount++;
                        } catch (error) {
                            logResult(`⚠️ 清理数据库失败: ${db.name} - ${error.message}`, 'warning-status');
                        }
                    }
                }

                updateProgress(100);

                logResult(`🎉 低质量缓存清理完成！`, 'success');
                logResult(`📊 统计: 检查了${totalChecked}个项目，清理了${cleanedCount}个低质量缓存`, 'info');
                
            } catch (error) {
                logResult(`❌ 清理过程中出错: ${error.message}`, 'error');
            } finally {
                hideProgress();
                await updateCurrentStats();
            }
        }

        async function clearImageCache() {
            logResult('🖼️ 开始清理所有图片缓存...', 'info');
            showProgress();

            let cleanedCount = 0;

            try {
                // 清理localStorage图片缓存
                updateProgress(25);
                const keys = Object.keys(localStorage);
                for (const key of keys) {
                    if (key.includes('img_') || key.includes('image') || key.includes('thumb') || key.includes('template')) {
                        localStorage.removeItem(key);
                        cleanedCount++;
                    }
                }
                logResult(`🗑️ 清理localStorage图片缓存: ${cleanedCount}个`, 'success');

                updateProgress(50);

                // 清理相关数据库
                const imageDatabases = [
                    'ai-video-saas-cache',
                    'image-cache',
                    'template-cache',
                    'thumbnail-cache',
                    'unified-cache',
                    'unified-cache-v1'
                ];

                let dbCleaned = 0;
                for (const dbName of imageDatabases) {
                    try {
                        await deleteDatabase(dbName);
                        dbCleaned++;
                        logResult(`✅ 清理图片数据库: ${dbName}`, 'success');
                    } catch (error) {
                        logResult(`⚠️ 数据库不存在或已清理: ${dbName}`, 'info');
                    }
                }

                updateProgress(100);
                logResult(`🎉 图片缓存清理完成！清理了${cleanedCount}个存储项和${dbCleaned}个数据库`, 'success');

            } catch (error) {
                logResult(`❌ 清理图片缓存失败: ${error.message}`, 'error');
            } finally {
                hideProgress();
                await updateCurrentStats();
            }
        }

        async function clearIndexedDBCache() {
            logResult('💾 开始清理所有IndexedDB数据库...', 'info');
            showProgress();

            try {
                const databases = await indexedDB.databases();
                totalDatabases = databases.length;
                
                if (totalDatabases === 0) {
                    logResult('✅ 未发现IndexedDB数据库', 'info');
                    hideProgress();
                    return;
                }

                logResult(`🔍 发现 ${totalDatabases} 个数据库，开始清理...`, 'info');

                let cleaned = 0;
                for (let i = 0; i < databases.length; i++) {
                    const db = databases[i];
                    try {
                        await deleteDatabase(db.name);
                        cleaned++;
                        logResult(`✅ 已删除: ${db.name} (版本 ${db.version})`, 'success');
                    } catch (error) {
                        logResult(`❌ 删除失败: ${db.name} - ${error.message}`, 'error');
                    }
                    updateProgress(((i + 1) / totalDatabases) * 100);
                }

                logResult(`🎉 IndexedDB清理完成！成功清理 ${cleaned}/${totalDatabases} 个数据库`, 'success');

            } catch (error) {
                logResult(`❌ IndexedDB清理失败: ${error.message}`, 'error');
            } finally {
                hideProgress();
                await updateCurrentStats();
            }
        }

        async function clearBrowserCache() {
            logResult('🌐 开始清理浏览器存储缓存...', 'info');
            showProgress();

            try {
                // 清理localStorage
                updateProgress(25);
                const localStorageCount = Object.keys(localStorage).length;
                localStorage.clear();
                logResult(`✅ 清理localStorage: ${localStorageCount}个项目`, 'success');

                // 清理sessionStorage
                updateProgress(50);
                const sessionStorageCount = Object.keys(sessionStorage).length;
                sessionStorage.clear();
                logResult(`✅ 清理sessionStorage: ${sessionStorageCount}个项目`, 'success');

                // 清理Cache API (如果支持)
                updateProgress(75);
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    let deletedCaches = 0;
                    for (const cacheName of cacheNames) {
                        await caches.delete(cacheName);
                        deletedCaches++;
                    }
                    logResult(`✅ 清理Cache API: ${deletedCaches}个缓存`, 'success');
                }

                updateProgress(100);
                logResult('🎉 浏览器存储缓存清理完成！', 'success');

            } catch (error) {
                logResult(`❌ 浏览器缓存清理失败: ${error.message}`, 'error');
            } finally {
                hideProgress();
                await updateCurrentStats();
            }
        }

        async function nuclearClean() {
            const confirmed = confirm('⚠️ 核弹级清理将删除所有可能的缓存数据！\n这包括:\n- 所有IndexedDB数据库\n- 所有localStorage数据\n- 所有sessionStorage数据\n- 所有Cache API数据\n\n确定要继续吗？');
            
            if (!confirmed) return;

            logResult('☢️ 启动核弹级清理模式...', 'warning-status');
            showProgress();

            let totalCleaned = 0;

            try {
                // 步骤1: 清理所有IndexedDB
                logResult('🔥 第一波：清理所有IndexedDB数据库...', 'info');
                updateProgress(20);
                
                const databases = await indexedDB.databases();
                for (const db of databases) {
                    try {
                        await deleteDatabase(db.name);
                        totalCleaned++;
                        logResult(`💥 摧毁数据库: ${db.name}`, 'success');
                    } catch (error) {
                        logResult(`⚠️ 摧毁失败: ${db.name}`, 'warning-status');
                    }
                }

                // 步骤2: 清理所有存储
                updateProgress(40);
                logResult('🔥 第二波：清理所有浏览器存储...', 'info');
                
                const localCount = Object.keys(localStorage).length;
                const sessionCount = Object.keys(sessionStorage).length;
                localStorage.clear();
                sessionStorage.clear();
                totalCleaned += localCount + sessionCount;
                logResult(`💥 摧毁存储: ${localCount + sessionCount}个项目`, 'success');

                // 步骤3: 清理Cache API
                updateProgress(60);
                logResult('🔥 第三波：清理Cache API...', 'info');
                
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    for (const cacheName of cacheNames) {
                        await caches.delete(cacheName);
                        totalCleaned++;
                    }
                    logResult(`💥 摧毁缓存: ${cacheNames.length}个`, 'success');
                }

                // 步骤4: 强制垃圾回收
                updateProgress(80);
                logResult('🔥 第四波：强制垃圾回收...', 'info');
                
                if (window.gc) {
                    window.gc();
                    logResult('💥 执行垃圾回收', 'success');
                }

                // 步骤5: 清理可能残留的数据
                updateProgress(90);
                logResult('🔥 最后一波：清理残留数据...', 'info');
                
                const commonDbNames = [
                    'keyval-store',
                    'workbox-runtime',
                    'workbox-expiration',
                    'template-cache',
                    'thumbnail-cache',
                    'video-cache',
                    'image-cache',
                    'ai-video-cache',
                    'supabase-cache',
                    'unified-cache',
                    'unified-cache-v1',
                    'ai-video-saas-cache'
                ];

                for (const dbName of commonDbNames) {
                    try {
                        await deleteDatabase(dbName);
                        logResult(`💥 强制清理: ${dbName}`, 'success');
                    } catch (e) {
                        // 忽略不存在的数据库
                    }
                }

                updateProgress(100);
                logResult('☢️ 核弹级清理完成！所有缓存已被摧毁！', 'success');
                logResult(`📊 总计清理: ${totalCleaned}个项目`, 'info');
                logResult('💡 建议刷新页面或重启浏览器以确保完全清理', 'warning-status');

                // 自动刷新确认
                setTimeout(() => {
                    if (confirm('核弹级清理完成！是否立即刷新页面以确保完全清理？')) {
                        location.reload();
                    }
                }, 3000);

            } catch (error) {
                logResult(`❌ 核弹级清理过程中出错: ${error.message}`, 'error');
            } finally {
                hideProgress();
                await updateCurrentStats();
            }
        }

        function deleteDatabase(name) {
            return new Promise((resolve, reject) => {
                const deleteReq = indexedDB.deleteDatabase(name);
                
                deleteReq.onerror = () => reject(deleteReq.error);
                deleteReq.onsuccess = () => resolve();
                deleteReq.onblocked = () => {
                    // 等待一点时间让其他连接关闭
                    setTimeout(() => resolve(), 1000);
                };
                
                // 设置超时
                setTimeout(() => {
                    reject(new Error(`删除数据库 ${name} 超时`));
                }, 10000);
            });
        }
    </script>
</body>
</html>
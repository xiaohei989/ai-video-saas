<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰¹é‡ç”Ÿæˆè§†é¢‘ç¼©ç•¥å›¾</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .video-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .video-info {
            flex: 1;
        }
        .video-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        .video-id {
            font-size: 12px;
            color: #6c757d;
            font-family: monospace;
        }
        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .status.pending { background: #fff3cd; color: #856404; }
        .status.processing { background: #d1ecf1; color: #0c5460; }
        .status.completed { background: #d4edda; color: #155724; }
        .status.failed { background: #f8d7da; color: #721c24; }
        .thumbnail-preview {
            width: 80px;
            height: 45px;
            background: #e9ecef;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #6c757d;
        }
        .thumbnail-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 14px;
            color: #6c757d;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }
        .btn:hover {
            background: #5a6fd8;
        }
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .btn-danger {
            background: #dc3545;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 20px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .log-info { color: #0c5460; }
        .log-success { color: #155724; }
        .log-error { color: #721c24; }
        .log-warning { color: #856404; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¬ æ‰¹é‡ç”Ÿæˆè§†é¢‘ç¼©ç•¥å›¾</h1>
        <p>ä¸ºæ‰€æœ‰pendingçŠ¶æ€çš„è§†é¢‘ç”Ÿæˆé™æ€ç¼©ç•¥å›¾</p>
    </div>

    <div class="stats">
        <div class="stat-card">
            <div class="stat-number" id="totalCount">-</div>
            <div class="stat-label">æ€»è§†é¢‘æ•°</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="pendingCount">-</div>
            <div class="stat-label">å¾…å¤„ç†</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="completedCount">-</div>
            <div class="stat-label">å·²å®Œæˆ</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="failedCount">-</div>
            <div class="stat-label">å¤±è´¥</div>
        </div>
    </div>

    <div class="controls">
        <button id="loadVideosBtn" class="btn">ğŸ“¥ åŠ è½½è§†é¢‘åˆ—è¡¨</button>
        <button id="startBatchBtn" class="btn" disabled>ğŸš€ å¼€å§‹æ‰¹é‡ç”Ÿæˆ</button>
        <button id="stopBtn" class="btn btn-danger" disabled>â¹ï¸ åœæ­¢å¤„ç†</button>
        
        <div class="progress-bar" style="margin-top: 15px;">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <div id="progressText" style="text-align: center; margin-top: 5px; font-size: 14px; color: #6c757d;">
            å‡†å¤‡å°±ç»ª
        </div>
    </div>

    <div id="videoList"></div>

    <div class="log" id="logContainer">
        <div class="log-entry log-info">ğŸ“‹ ç³»ç»Ÿå°±ç»ªï¼Œç‚¹å‡»"åŠ è½½è§†é¢‘åˆ—è¡¨"å¼€å§‹...</div>
    </div>

    <script type="module">
        // Supabase é…ç½®
        const SUPABASE_URL = 'https://hvkzwrnvxsleeonqqrzq.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2a3p3cm52eHNsZWVvbnFxcnpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3NjQ1NjAsImV4cCI6MjA3MTM0MDU2MH0.VOHVXCUFRk83t1cfPHd6Lf5SwWDQHn1Hl2Mn0qqiyPk'

        // å¯¼å…¥ Supabase ï¼ˆæ¨¡æ‹Ÿå¯¼å…¥ï¼Œå®é™…éœ€è¦é€šè¿‡CDNï¼‰
        const { createClient } = window.supabase
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        // çŠ¶æ€ç®¡ç†
        let videos = []
        let isProcessing = false
        let currentIndex = 0

        // DOM å…ƒç´ 
        const elements = {
            loadVideosBtn: document.getElementById('loadVideosBtn'),
            startBatchBtn: document.getElementById('startBatchBtn'),
            stopBtn: document.getElementById('stopBtn'),
            videoList: document.getElementById('videoList'),
            logContainer: document.getElementById('logContainer'),
            progressFill: document.getElementById('progressFill'),
            progressText: document.getElementById('progressText'),
            totalCount: document.getElementById('totalCount'),
            pendingCount: document.getElementById('pendingCount'),
            completedCount: document.getElementById('completedCount'),
            failedCount: document.getElementById('failedCount')
        }

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('zh-CN')
            const entry = document.createElement('div')
            entry.className = `log-entry log-${type}`
            entry.textContent = `[${timestamp}] ${message}`
            elements.logContainer.appendChild(entry)
            elements.logContainer.scrollTop = elements.logContainer.scrollHeight
            console.log(`[${type.toUpperCase()}] ${message}`)
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats() {
            const total = videos.length
            const pending = videos.filter(v => v.status === 'pending').length
            const completed = videos.filter(v => v.status === 'completed').length
            const failed = videos.filter(v => v.status === 'failed').length

            elements.totalCount.textContent = total
            elements.pendingCount.textContent = pending
            elements.completedCount.textContent = completed
            elements.failedCount.textContent = failed
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress() {
            if (videos.length === 0) return

            const processed = currentIndex
            const total = videos.filter(v => v.originalStatus === 'pending').length
            const percentage = total > 0 ? (processed / total) * 100 : 0

            elements.progressFill.style.width = `${percentage}%`
            elements.progressText.textContent = total > 0 ? 
                `å¤„ç†è¿›åº¦: ${processed}/${total} (${Math.round(percentage)}%)` : 
                'å‡†å¤‡å°±ç»ª'
        }

        // æ¸²æŸ“è§†é¢‘åˆ—è¡¨
        function renderVideoList() {
            elements.videoList.innerHTML = ''
            
            videos.forEach((video, index) => {
                const item = document.createElement('div')
                item.className = 'video-item'
                
                item.innerHTML = `
                    <div class="thumbnail-preview" id="thumb-${video.id}">
                        ${video.thumbnail_url ? 
                            `<img src="${video.thumbnail_url}" alt="ç¼©ç•¥å›¾">` : 
                            'æ— ç¼©ç•¥å›¾'
                        }
                    </div>
                    <div class="video-info">
                        <div class="video-title">${video.title}</div>
                        <div class="video-id">${video.id}</div>
                    </div>
                    <div class="status ${video.status}">${getStatusText(video.status)}</div>
                `
                
                elements.videoList.appendChild(item)
            })

            updateStats()
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusMap = {
                'pending': 'ç­‰å¾…å¤„ç†',
                'processing': 'ç”Ÿæˆä¸­...',
                'completed': 'å·²å®Œæˆ',
                'failed': 'å¤±è´¥'
            }
            return statusMap[status] || status
        }

        // åŠ è½½è§†é¢‘åˆ—è¡¨
        async function loadVideos() {
            try {
                log('ğŸ” æ­£åœ¨åŠ è½½è§†é¢‘åˆ—è¡¨...', 'info')
                elements.loadVideosBtn.disabled = true

                const { data, error } = await supabase
                    .from('videos')
                    .select('id, title, thumbnail_url, thumbnail_generation_status, video_url, status')
                    .eq('status', 'completed') // åªå¤„ç†å·²å®Œæˆçš„è§†é¢‘
                    .order('created_at', { ascending: false })
                    .limit(50) // é™åˆ¶æ•°é‡é¿å…ä¸€æ¬¡å¤„ç†å¤ªå¤š

                if (error) {
                    throw error
                }

                videos = data.map(video => ({
                    ...video,
                    status: video.thumbnail_generation_status || 'pending',
                    originalStatus: video.thumbnail_generation_status || 'pending'
                }))

                log(`âœ… æˆåŠŸåŠ è½½ ${videos.length} ä¸ªè§†é¢‘`, 'success')
                renderVideoList()
                updateProgress()

                const pendingVideos = videos.filter(v => v.status === 'pending')
                if (pendingVideos.length > 0) {
                    elements.startBatchBtn.disabled = false
                    log(`ğŸ¯ å‘ç° ${pendingVideos.length} ä¸ªå¾…å¤„ç†è§†é¢‘`, 'info')
                } else {
                    log('â„¹ï¸ æ²¡æœ‰éœ€è¦å¤„ç†çš„è§†é¢‘', 'warning')
                }

            } catch (error) {
                log(`âŒ åŠ è½½å¤±è´¥: ${error.message}`, 'error')
            } finally {
                elements.loadVideosBtn.disabled = false
            }
        }

        // ç”Ÿæˆå•ä¸ªç¼©ç•¥å›¾ï¼ˆä½¿ç”¨æœ¬åœ°Canvasï¼‰
        async function generateThumbnailForVideo(video) {
            try {
                // æ›´æ–°çŠ¶æ€ä¸ºå¤„ç†ä¸­
                video.status = 'processing'
                renderVideoList()

                log(`ğŸ¬ å¼€å§‹å¤„ç†: ${video.title}`, 'info')

                // ä½¿ç”¨æœ¬åœ°Canvasç”Ÿæˆç¼©ç•¥å›¾
                const thumbnailDataUrl = await extractVideoThumbnail(video.video_url, 0.1)
                
                // ä¸Šä¼ åˆ°R2å­˜å‚¨
                const r2Url = await uploadThumbnailToR2(thumbnailDataUrl, video.id)
                
                // æ›´æ–°æ•°æ®åº“
                const { error: updateError } = await supabase
                    .from('videos')
                    .update({ 
                        thumbnail_url: r2Url, 
                        thumbnail_generation_status: 'completed' 
                    })
                    .eq('id', video.id)

                if (updateError) {
                    throw updateError
                }

                // æ›´æ–°è§†é¢‘çŠ¶æ€å’Œç¼©ç•¥å›¾URL
                video.status = 'completed'
                video.thumbnail_url = r2Url
                
                // æ›´æ–°é¢„è§ˆå›¾
                const thumbElement = document.getElementById(`thumb-${video.id}`)
                if (thumbElement) {
                    thumbElement.innerHTML = `<img src="${r2Url}" alt="ç¼©ç•¥å›¾">`
                }

                log(`âœ… å®Œæˆ: ${video.title}`, 'success')

            } catch (error) {
                video.status = 'failed'
                log(`âŒ å¤±è´¥: ${video.title} - ${error.message}`, 'error')
                
                // æ›´æ–°æ•°æ®åº“çŠ¶æ€ä¸ºå¤±è´¥
                await supabase
                    .from('videos')
                    .update({ thumbnail_generation_status: 'failed' })
                    .eq('id', video.id)
            }

            renderVideoList()
        }

        // æœ¬åœ°Canvasæå–è§†é¢‘ç¼©ç•¥å›¾
        async function extractVideoThumbnail(videoUrl, frameTime = 0.1) {
            return new Promise((resolve, reject) => {
                const video = document.createElement('video')
                const canvas = document.createElement('canvas')
                const context = canvas.getContext('2d')
                
                if (!context) {
                    reject(new Error('Failed to get canvas context'))
                    return
                }
                
                // CORSè®¾ç½®
                video.crossOrigin = 'anonymous'
                video.muted = true
                video.playsInline = true
                
                // ç›‘å¬è§†é¢‘åŠ è½½å…ƒæ•°æ®
                video.addEventListener('loadedmetadata', () => {
                    // è®¾ç½®ç”»å¸ƒå°ºå¯¸ï¼ˆä¼˜åŒ–ä¸º16:9æ¯”ä¾‹ï¼Œ320x180ï¼‰
                    canvas.width = 320
                    canvas.height = 180
                    
                    // è·³è½¬åˆ°æŒ‡å®šæ—¶é—´ç‚¹
                    video.currentTime = Math.min(frameTime, video.duration)
                })
                
                // ç›‘å¬è·³è½¬å®Œæˆ
                video.addEventListener('seeked', async () => {
                    try {
                        // è®¡ç®—è§†é¢‘åœ¨ç”»å¸ƒä¸­çš„ä½ç½®ï¼ˆä¿æŒå®½é«˜æ¯”ï¼‰
                        const videoAspect = video.videoWidth / video.videoHeight
                        const canvasAspect = canvas.width / canvas.height
                        
                        let drawWidth, drawHeight, drawX, drawY
                        
                        if (videoAspect > canvasAspect) {
                            // è§†é¢‘æ›´å®½ï¼Œä»¥é«˜åº¦ä¸ºå‡†
                            drawHeight = canvas.height
                            drawWidth = drawHeight * videoAspect
                            drawX = (canvas.width - drawWidth) / 2
                            drawY = 0
                        } else {
                            // è§†é¢‘æ›´é«˜ï¼Œä»¥å®½åº¦ä¸ºå‡†
                            drawWidth = canvas.width
                            drawHeight = drawWidth / videoAspect
                            drawX = 0
                            drawY = (canvas.height - drawHeight) / 2
                        }
                        
                        // å¡«å……èƒŒæ™¯è‰²
                        context.fillStyle = '#000000'
                        context.fillRect(0, 0, canvas.width, canvas.height)
                        
                        // ç»˜åˆ¶è§†é¢‘å¸§
                        context.drawImage(video, drawX, drawY, drawWidth, drawHeight)
                        
                        // è½¬æ¢ä¸ºWebPæ ¼å¼ï¼ˆå¦‚æœæ”¯æŒï¼‰æˆ–JPEG
                        let dataUrl
                        try {
                            dataUrl = canvas.toDataURL('image/webp', 0.75)
                            // æ£€æŸ¥æ˜¯å¦çœŸçš„ç”Ÿæˆäº†WebP
                            if (!dataUrl.startsWith('data:image/webp')) {
                                throw new Error('WebP not supported')
                            }
                        } catch (webpError) {
                            // å›é€€åˆ°JPEG
                            dataUrl = canvas.toDataURL('image/jpeg', 0.8)
                        }
                        
                        // æ¸…ç†èµ„æº
                        video.remove()
                        canvas.remove()
                        
                        resolve(dataUrl)
                        
                    } catch (error) {
                        video.remove()
                        canvas.remove()
                        reject(error)
                    }
                })
                
                // é”™è¯¯å¤„ç†
                video.addEventListener('error', (e) => {
                    video.remove()
                    canvas.remove()
                    reject(new Error(`Failed to load video: ${e.type}`))
                })
                
                // è®¾ç½®è§†é¢‘æºå¹¶å¼€å§‹åŠ è½½
                video.src = videoUrl
                video.load()
            })
        }

        // ä¸Šä¼ ç¼©ç•¥å›¾åˆ°R2å­˜å‚¨
        async function uploadThumbnailToR2(thumbnailDataUrl, videoId) {
            try {
                // å°†Base64è½¬æ¢ä¸ºBlob
                const blob = await dataUrlToBlob(thumbnailDataUrl)
                
                // è·å–ä¸Šä¼ URL
                const uploadResponse = await fetch(`${SUPABASE_URL}/functions/v1/upload-thumbnail`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    },
                    body: JSON.stringify({
                        videoId,
                        contentType: blob.type,
                        fileSize: blob.size
                    })
                })
                
                if (!uploadResponse.ok) {
                    throw new Error(`è·å–ä¸Šä¼ URLå¤±è´¥: ${uploadResponse.status}`)
                }
                
                const { data } = await uploadResponse.json()
                const { signedUrl, publicUrl } = data
                
                // ä½¿ç”¨é¢„ç­¾åURLä¸Šä¼ æ–‡ä»¶
                const uploadResult = await fetch(signedUrl, {
                    method: 'PUT',
                    body: blob,
                    headers: {
                        'Content-Type': blob.type,
                    }
                })
                
                if (!uploadResult.ok) {
                    throw new Error(`ä¸Šä¼ æ–‡ä»¶å¤±è´¥: ${uploadResult.status}`)
                }
                
                return publicUrl
                
            } catch (error) {
                throw new Error(`R2ä¸Šä¼ å¤±è´¥: ${error.message}`)
            }
        }

        // å°†DataURLè½¬æ¢ä¸ºBlob
        async function dataUrlToBlob(dataUrl) {
            const response = await fetch(dataUrl)
            return response.blob()
        }

        // æ‰¹é‡ç”Ÿæˆç¼©ç•¥å›¾
        async function startBatchGeneration() {
            if (isProcessing) return

            isProcessing = true
            currentIndex = 0
            
            elements.startBatchBtn.disabled = true
            elements.stopBtn.disabled = false
            elements.loadVideosBtn.disabled = true

            const pendingVideos = videos.filter(v => v.originalStatus === 'pending')
            
            log(`ğŸš€ å¼€å§‹æ‰¹é‡ç”Ÿæˆï¼Œå…± ${pendingVideos.length} ä¸ªè§†é¢‘`, 'info')

            for (const video of pendingVideos) {
                if (!isProcessing) {
                    log('â¹ï¸ ç”¨æˆ·åœæ­¢äº†å¤„ç†', 'warning')
                    break
                }

                await generateThumbnailForVideo(video)
                currentIndex++
                updateProgress()

                // æ·»åŠ å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡äºé¢‘ç¹
                await new Promise(resolve => setTimeout(resolve, 1000))
            }

            // å¤„ç†å®Œæˆ
            isProcessing = false
            elements.startBatchBtn.disabled = false
            elements.stopBtn.disabled = true
            elements.loadVideosBtn.disabled = false

            const completedCount = videos.filter(v => v.status === 'completed').length
            const failedCount = videos.filter(v => v.status === 'failed').length
            
            log(`ğŸ‰ æ‰¹é‡å¤„ç†å®Œæˆï¼æˆåŠŸ: ${completedCount}, å¤±è´¥: ${failedCount}`, 'success')
        }

        // åœæ­¢å¤„ç†
        function stopProcessing() {
            isProcessing = false
            log('â¹ï¸ æ­£åœ¨åœæ­¢å¤„ç†...', 'warning')
        }

        // äº‹ä»¶ç›‘å¬
        elements.loadVideosBtn.addEventListener('click', loadVideos)
        elements.startBatchBtn.addEventListener('click', startBatchGeneration)
        elements.stopBtn.addEventListener('click', stopProcessing)

        // åˆå§‹åŒ–
        log('ğŸ¬ æ‰¹é‡ç¼©ç•¥å›¾ç”Ÿæˆå™¨å·²åŠ è½½', 'info')
        log('ğŸ“‹ ç‚¹å‡»"åŠ è½½è§†é¢‘åˆ—è¡¨"å¼€å§‹å¤„ç†', 'info')
    </script>

    <!-- å¼•å…¥ Supabase JS å®¢æˆ·ç«¯ -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</body>
</html>
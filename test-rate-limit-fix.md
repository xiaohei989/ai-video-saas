# é™æµä¿®å¤éªŒè¯æŒ‡å—

## ğŸ”§ ä¿®å¤å†…å®¹æ€»ç»“

æˆ‘ä»¬å·²ç»å®Œæˆäº†è§†é¢‘ç”Ÿæˆé™æµé—®é¢˜çš„å…¨é¢ä¿®å¤ï¼Œä¸»è¦åŒ…æ‹¬ï¼š

### 1. âœ… ç«‹å³é‡ç½®æ–¹æ¡ˆ
- **åˆ›å»ºäº†**: `fix-rate-limit-reset.sql` - ç´§æ€¥é‡ç½®è„šæœ¬
- **åŠŸèƒ½**: æ¸…ç†ç°æœ‰é™æµè®°å½•ï¼Œæä¾›é‡ç½®å‡½æ•°

### 2. âœ… é”®ç”Ÿæˆé€»è¾‘ä¿®å¤
- **ä¿®æ”¹äº†**: `rateLimitMiddleware.ts` 
- **é—®é¢˜**: åŒ¿åç”¨æˆ·å…±äº«IPå¯¼è‡´è®¡æ•°å™¨å†²çª
- **è§£å†³**: ä½¿ç”¨IP+UserAgentæŒ‡çº¹åŒºåˆ†åŒ¿åç”¨æˆ·

### 3. âœ… æ•°æ®åº“ä¼˜åŒ–
- **åˆ›å»ºäº†**: `fix-rate-limit-database.sql`
- **æ”¹è¿›**: æ»‘åŠ¨çª—å£ç®—æ³•ã€æ›´å¥½çš„æ¸…ç†æœºåˆ¶ã€ç”¨æˆ·è‡ªå®šä¹‰é™æµ

### 4. âœ… å‰åç«¯åŒæ­¥
- **ä¿®æ”¹äº†**: `useRateLimiter.tsx`
- **æ”¹è¿›**: ç»Ÿä¸€é”®ç”Ÿæˆç­–ç•¥ï¼Œä¿æŒå‰åç«¯ä¸€è‡´

### 5. âœ… è°ƒè¯•å’Œç®¡ç†å·¥å…·
- **åˆ›å»ºäº†**: `RateLimitDebugger.tsx` (ç®¡ç†å‘˜)
- **åˆ›å»ºäº†**: `RateLimitStatus.tsx` (ç”¨æˆ·)

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæ‰§è¡Œæ•°æ®åº“ä¿®å¤
```sql
-- 1. è¿æ¥åˆ°ä½ çš„Supabaseæ•°æ®åº“
-- 2. æ‰§è¡Œé‡ç½®è„šæœ¬
\i fix-rate-limit-reset.sql

-- 3. æ‰§è¡Œæ•°æ®åº“ä¼˜åŒ–è„šæœ¬  
\i fix-rate-limit-database.sql

-- 4. éªŒè¯å‡½æ•°åˆ›å»ºæˆåŠŸ
SELECT proname FROM pg_proc WHERE proname LIKE '%rate_limit%';
```

### ç¬¬äºŒæ­¥ï¼šéªŒè¯åç«¯ä¿®å¤
```bash
# 1. é‡å¯Edge Functions (å¦‚æœä½¿ç”¨Supabase)
supabase functions deploy --no-verify-jwt

# 2. æµ‹è¯•é™æµä¸­é—´ä»¶
curl -X POST "your-edge-function-url" \
  -H "Authorization: Bearer your-jwt-token" \
  -H "Content-Type: application/json"
```

### ç¬¬ä¸‰æ­¥ï¼šéªŒè¯å‰ç«¯ä¿®å¤
```typescript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æµ‹è¯•
import { useVideoGenerationLimiter } from '@/hooks/useRateLimiter';

const { checkLimit, getStatus } = useVideoGenerationLimiter();
console.log('é™æµçŠ¶æ€:', getStatus());
console.log('æ˜¯å¦å…è®¸:', checkLimit());
```

### ç¬¬å››æ­¥ï¼šç«¯åˆ°ç«¯æµ‹è¯•
1. **ç™»å½•åº”ç”¨**
2. **å°è¯•ç”Ÿæˆè§†é¢‘** - åº”è¯¥æ­£å¸¸å·¥ä½œ
3. **æŸ¥çœ‹é™æµçŠ¶æ€** - ä½¿ç”¨ `RateLimitStatus` ç»„ä»¶
4. **æ¨¡æ‹Ÿè¾¾åˆ°é™åˆ¶** - å¿«é€Ÿå¤šæ¬¡è¯·æ±‚
5. **éªŒè¯é™åˆ¶ç”Ÿæ•ˆ** - åº”è¯¥æ˜¾ç¤ºé™åˆ¶æç¤º

## ğŸ” éªŒè¯æ£€æŸ¥æ¸…å•

### âœ… åŸºæœ¬åŠŸèƒ½æ£€æŸ¥
- [ ] ç”¨æˆ·å¯ä»¥æ­£å¸¸ç”Ÿæˆè§†é¢‘
- [ ] é™æµè®¡æ•°å™¨æ­£ç¡®é€’å¢
- [ ] è¾¾åˆ°é™åˆ¶æ—¶æ˜¾ç¤ºæ­£ç¡®æç¤º
- [ ] æ—¶é—´çª—å£é‡ç½®åæ¢å¤æ­£å¸¸

### âœ… é”®ç”Ÿæˆæ£€æŸ¥
- [ ] å·²ç™»å½•ç”¨æˆ·ä½¿ç”¨ç”¨æˆ·IDä½œä¸ºé”®
- [ ] åŒ¿åç”¨æˆ·ä½¿ç”¨æŒ‡çº¹è€Œéçº¯IP
- [ ] ä¸åŒåŒ¿åç”¨æˆ·æœ‰ä¸åŒçš„é™æµè®¡æ•°

### âœ… æ•°æ®åº“æ£€æŸ¥
```sql
-- æ£€æŸ¥é™æµè®°å½•
SELECT rate_limit_key, request_count, window_start, window_end 
FROM rate_limit_records 
ORDER BY updated_at DESC LIMIT 10;

-- æ£€æŸ¥ç”¨æˆ·é…ç½®
SELECT user_id, action, max_requests, window_seconds 
FROM user_rate_limit_config 
WHERE is_active = true;
```

### âœ… å‰ç«¯æ£€æŸ¥
- [ ] é™æµçŠ¶æ€æ˜¾ç¤ºæ­£ç¡®
- [ ] å‰©ä½™æ¬¡æ•°è®¡ç®—å‡†ç¡®
- [ ] é‡ç½®æ—¶é—´æ˜¾ç¤ºæ­£ç¡®
- [ ] é”™è¯¯æç¤ºå‹å¥½

## ğŸš¨ é—®é¢˜æ’æŸ¥

### å¦‚æœä»ç„¶æç¤º"å·²è¾¾é™åˆ¶"ï¼š

1. **æ£€æŸ¥æ•°æ®åº“è®°å½•**:
```sql
SELECT * FROM rate_limit_records 
WHERE rate_limit_key LIKE '%your-user-id%' 
ORDER BY updated_at DESC;
```

2. **æ‰‹åŠ¨é‡ç½®ç”¨æˆ·**:
```sql
SELECT reset_user_rate_limit('your-user-id', 'video_generation');
```

3. **æ£€æŸ¥é”®ç”Ÿæˆ**:
```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°
console.log('User ID:', user?.id);
console.log('Rate limit key:', getRateLimitKey());
```

### å¦‚æœå‰åç«¯ä¸åŒæ­¥ï¼š

1. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**
2. **é‡å¯å‰ç«¯å¼€å‘æœåŠ¡å™¨**
3. **æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦ä¸€è‡´**

## ğŸ¯ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### åç»­ä¼˜åŒ–é¡¹ç›®ï¼š
1. **Redisé›†æˆ** - ä½¿ç”¨Redisæ›¿ä»£æ•°æ®åº“å­˜å‚¨
2. **åˆ†å¸ƒå¼é™æµ** - æ”¯æŒå¤šå®ä¾‹éƒ¨ç½²
3. **æ™ºèƒ½é™æµ** - åŸºäºç”¨æˆ·è¡Œä¸ºè°ƒæ•´é™åˆ¶
4. **ç›‘æ§å‘Šè­¦** - å¼‚å¸¸é™æµæƒ…å†µè‡ªåŠ¨å‘Šè­¦

## ğŸ“ ç»´æŠ¤å»ºè®®

### å®šæœŸä»»åŠ¡ï¼š
```sql
-- æ¯å¤©æ‰§è¡Œæ¸…ç†ï¼ˆå»ºè®®è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼‰
SELECT cleanup_rate_limit_data_v2();

-- æ¯å‘¨æ£€æŸ¥é™æµç»Ÿè®¡
SELECT * FROM rate_limit_monitor;
```

### ç›‘æ§æŒ‡æ ‡ï¼š
- é™æµäº‹ä»¶é¢‘ç‡
- ç”¨æˆ·æŠ•è¯‰æ•°é‡
- ç³»ç»Ÿæ€§èƒ½å½±å“
- æ•°æ®åº“å­˜å‚¨ä½¿ç”¨é‡

## ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹

1. **ç®¡ç†å‘˜æƒé™**: ç¡®ä¿åªæœ‰ç®¡ç†å‘˜èƒ½è®¿é—® `RateLimitDebugger`
2. **æ•æ„Ÿæ•°æ®**: ä¸è¦åœ¨æ—¥å¿—ä¸­è®°å½•å®Œæ•´çš„JWT
3. **DDOSé˜²æŠ¤**: ç»“åˆIPé»‘åå•åŠŸèƒ½
4. **éšç§ä¿æŠ¤**: åŒ¿åç”¨æˆ·æŒ‡çº¹ä¸åº”è¿‡äºç²¾ç¡®

---

**ä¿®å¤å®Œæˆï¼** ğŸ‰

é€šè¿‡ä»¥ä¸Šä¿®å¤ï¼Œæ‚¨çš„è§†é¢‘ç”Ÿæˆé™æµç³»ç»Ÿç°åœ¨åº”è¯¥èƒ½å¤Ÿï¼š
- âœ… æ­£ç¡®åŒºåˆ†ä¸åŒç”¨æˆ·
- âœ… é¿å…IPå†²çªé—®é¢˜  
- âœ… æä¾›å‡†ç¡®çš„é™æµè®¡æ•°
- âœ… æ”¯æŒçµæ´»çš„ç®¡ç†å’Œè°ƒè¯•
- âœ… ä¿æŒå‰åç«¯åŒæ­¥
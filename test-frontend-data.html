<!DOCTYPE html>
<html>
<head>
  <title>æµ‹è¯•å‰ç«¯æ•°æ®</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
    .section { margin: 20px 0; padding: 15px; background: #2a2a2a; border-radius: 8px; }
    .label { color: #60a5fa; font-weight: bold; }
    .value { color: #34d399; }
    .error { color: #f87171; }
    button { padding: 10px 20px; margin: 5px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #2563eb; }
  </style>
</head>
<body>
  <h1>ğŸ” Squirrel è§†é¢‘å‰ç«¯æ•°æ®æµ‹è¯•</h1>

  <div class="section">
    <button onclick="checkLocalStorage()">æ£€æŸ¥ localStorage</button>
    <button onclick="checkSupabase()">æŸ¥è¯¢ Supabase</button>
    <button onclick="clearProgress()">æ¸…é™¤è¿›åº¦æ•°æ®</button>
  </div>

  <div id="output" class="section"></div>

  <script type="module">
    const VIDEO_ID = 'b80ccead-1634-440b-b8df-156ccaa6126a';

    window.checkLocalStorage = () => {
      const output = document.getElementById('output');
      output.innerHTML = '<h3>ğŸ“¦ localStorage æ•°æ®:</h3>';

      // æ£€æŸ¥ videoProgress
      const progressData = localStorage.getItem('videoProgress');
      if (progressData) {
        const parsed = JSON.parse(progressData);
        output.innerHTML += `<div><span class="label">videoProgress:</span> æ‰¾åˆ° ${Object.keys(parsed).length} ä¸ªä»»åŠ¡</div>`;

        if (parsed[VIDEO_ID]) {
          output.innerHTML += `<div class="error">âŒ å‘ç°æ®‹ç•™è¿›åº¦æ•°æ®ï¼</div>`;
          output.innerHTML += `<pre>${JSON.stringify(parsed[VIDEO_ID], null, 2)}</pre>`;
        } else {
          output.innerHTML += `<div class="value">âœ… æ²¡æœ‰è¯¥è§†é¢‘çš„è¿›åº¦æ•°æ®</div>`;
        }
      } else {
        output.innerHTML += `<div class="value">âœ… localStorage ä¸­æ²¡æœ‰ videoProgress</div>`;
      }
    };

    window.clearProgress = () => {
      const progressData = localStorage.getItem('videoProgress');
      if (progressData) {
        const parsed = JSON.parse(progressData);
        delete parsed[VIDEO_ID];
        localStorage.setItem('videoProgress', JSON.stringify(parsed));
        alert('âœ… å·²æ¸…é™¤è¯¥è§†é¢‘çš„è¿›åº¦æ•°æ®ï¼è¯·åˆ·æ–°é¡µé¢ã€‚');
      } else {
        alert('æ²¡æœ‰éœ€è¦æ¸…é™¤çš„æ•°æ®');
      }
    };

    window.checkSupabase = async () => {
      const output = document.getElementById('output');
      output.innerHTML = '<h3>ğŸŒ Supabase æ•°æ®:</h3><div>æŸ¥è¯¢ä¸­...</div>';

      try {
        const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');
        const supabase = createClient(
          'https://hvkzwrnvxsleeonqqrzq.supabase.co',
          'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2a3p3cm52eHNsZWVvbnFxcnpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI1NTQ3NDcsImV4cCI6MjA0ODEzMDc0N30.0iRc5YFslY1wdMsVYO_5c-MXZSFJKhp8CgJ-wBjVDNA'
        );

        const { data, error } = await supabase
          .from('videos')
          .select('id, title, status, thumbnail_url, video_url')
          .eq('id', VIDEO_ID)
          .single();

        if (error) {
          output.innerHTML = `<div class="error">âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}</div>`;
          return;
        }

        output.innerHTML = '<h3>ğŸŒ Supabase æ•°æ®:</h3>';
        output.innerHTML += `<div><span class="label">çŠ¶æ€:</span> <span class="value">${data.status}</span></div>`;
        output.innerHTML += `<div><span class="label">video_url:</span> ${data.video_url ? 'âœ… æœ‰' : 'âŒ æ— '}</div>`;
        output.innerHTML += `<div><span class="label">thumbnail_url:</span> ${data.thumbnail_url ? 'âœ… æœ‰' : 'âŒ æ— '}</div>`;

        if (data.status === 'completed' && data.video_url && data.thumbnail_url) {
          output.innerHTML += `<div class="value">âœ… æ•°æ®åº“çŠ¶æ€æ­£å¸¸ï¼</div>`;
          output.innerHTML += `<div>ğŸ”— <a href="${data.thumbnail_url}" target="_blank" style="color: #60a5fa;">æŸ¥çœ‹ç¼©ç•¥å›¾</a></div>`;
        }
      } catch (error) {
        output.innerHTML = `<div class="error">âŒ é”™è¯¯: ${error.message}</div>`;
      }
    };

    // è‡ªåŠ¨æ£€æŸ¥
    checkLocalStorage();
  </script>
</body>
</html>

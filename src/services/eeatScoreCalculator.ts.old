/**
 * E-E-A-T è¯„åˆ†è®¡ç®—å™¨
 * Experience, Expertise, Authoritativeness, Trustworthiness
 * ç¬¦åˆ Google 2025 å¹´æœç´¢è´¨é‡è¯„ä¼°æ ‡å‡†
 *
 * å®Œå…¨ç‹¬ç«‹äºæ—§çš„ seoScoreCalculator.ts
 */

import { seoAIService } from './seoAIService'
import { promptTemplateService } from './promptTemplateService'
import {
  calculateKeywordDensity,
  calculateKeywordDensityScore as calculateDensityScore7Point,
  extractFullContent
} from './seoScoreCalculator'
import type {
  EEATGuideData,
  EEATScoreResult,
  EEATAIScoreResult,
  EngagementMetricsData,
  EEATScoreGrade
} from '@/types/eeat'

/**
 * æ„å»º E-E-A-T ä¸“å®¶è¯„åˆ† Prompt
 * ä½¿ç”¨ Google 2025 å¹´æœ€æ–°æ ‡å‡†
 * âœ… æ–°ç‰ˆæœ¬ï¼šä»æ•°æ®åº“åŠ è½½æç¤ºè¯æ¨¡æ¿
 */
async function buildEEATExpertPrompt(data: EEATGuideData): Promise<string> {
  // âœ… ä»æ•°æ®åº“åŠ è½½ E-E-A-T è¯„åˆ†æç¤ºè¯æ¨¡æ¿
  const prompt = await promptTemplateService.buildPrompt('eeat-score', {
    meta_title: data.meta_title || 'æœªæä¾›',
    meta_description: data.meta_description || 'æœªæä¾›',
    meta_keywords: data.meta_keywords || 'æœªæä¾›',
    target_keyword: data.target_keyword || 'æœªæä¾›',
    long_tail_keywords: (data.long_tail_keywords || []).join(', ') || 'æœªæä¾›',
    guide_intro: data.guide_intro || 'æœªæä¾›',
    guide_content: data.guide_content || 'æœªæä¾›',
    content_length: (data.guide_content || '').length,
    faq_count: (data.faq_items || []).length,
    faq_items: (data.faq_items || []).map((item, i) =>
      `Q${i + 1}: ${item.question}\nA${i + 1}: ${item.answer}`
    ).join('\n\n') || 'æœªæä¾›',
    page_views: data.page_views || 0,
    avg_time_on_page: data.avg_time_on_page || 0,
    bounce_rate: data.bounce_rate || 0,
    conversion_rate: data.conversion_rate || 0,
    keyword_density_info: data.keyword_density ? `
### å®æ—¶å…³é”®è¯å¯†åº¦ï¼ˆä»…ä¾›å‚è€ƒï¼‰
${Object.entries(data.keyword_density).map(([kw, density]) =>
  `- ${kw}: ${density}%`
).join('\n')}
` : ''
  })

  return prompt
}

/**
 * è®¡ç®—ç”¨æˆ·å‚ä¸åº¦è¯„åˆ† (0-12åˆ†)
 * åŸºäºæ•°æ®åº“å·²æœ‰å­—æ®µ: page_views, avg_time_on_page, bounce_rate, conversion_rate
 *
 * æ ¹æ® 2024 Google API æ³„éœ²: Google è¿½è¸ª "long clicks"ï¼ˆç”¨æˆ·åœ¨é¡µé¢åœç•™çš„æ—¶é—´ï¼‰
 */
export function calculateEngagementScore(data: EngagementMetricsData): number {
  let score = 0

  // 1. åœç•™æ—¶é—´è¯„åˆ† (0-4åˆ†)
  // åŸºäº Google "long clicks" - åœç•™æ—¶é—´è¶Šé•¿ï¼Œå†…å®¹è´¨é‡è¶Šé«˜çš„ä¿¡å·
  if (data.avg_time_on_page >= 180) {
    score += 4 // 3åˆ†é’Ÿ+ = ä¼˜ç§€ (ç”¨æˆ·æ·±åº¦é˜…è¯»)
  } else if (data.avg_time_on_page >= 120) {
    score += 3 // 2åˆ†é’Ÿ+ = è‰¯å¥½
  } else if (data.avg_time_on_page >= 60) {
    score += 2 // 1åˆ†é’Ÿ+ = åŠæ ¼
  } else if (data.avg_time_on_page >= 30) {
    score += 1 // 30ç§’+ = å·®
  }
  // < 30ç§’ = 0åˆ† (å¯èƒ½æ˜¯è¯¯ç‚¹æˆ–å†…å®¹ä¸ç›¸å…³)

  // 2. è·³å‡ºç‡è¯„åˆ† (0-4åˆ†)
  // è·³å‡ºç‡è¶Šä½ï¼Œè¡¨ç¤ºç”¨æˆ·æ‰¾åˆ°äº†æƒ³è¦çš„å†…å®¹
  if (data.bounce_rate <= 40) {
    score += 4 // â‰¤40% = ä¼˜ç§€
  } else if (data.bounce_rate <= 55) {
    score += 3 // â‰¤55% = è‰¯å¥½
  } else if (data.bounce_rate <= 70) {
    score += 2 // â‰¤70% = åŠæ ¼
  } else if (data.bounce_rate <= 85) {
    score += 1 // â‰¤85% = å·®
  }
  // > 85% = 0åˆ†

  // 3. è½¬åŒ–ç‡è¯„åˆ† (0-2åˆ†)
  // è½¬åŒ–ç‡åæ˜ å†…å®¹æ˜¯å¦çœŸæ­£å¸®åŠ©ç”¨æˆ·è§£å†³é—®é¢˜
  if (data.conversion_rate >= 5) {
    score += 2 // â‰¥5% = ä¼˜ç§€
  } else if (data.conversion_rate >= 2) {
    score += 1 // â‰¥2% = è‰¯å¥½
  }
  // < 2% = 0åˆ†

  // 4. è®¿é—®é‡è¯„åˆ† (0-2åˆ†)
  // è®¿é—®é‡åæ˜ å†…å®¹çš„å¸å¼•åŠ›å’Œæœç´¢æ’å
  if (data.page_views >= 1000) {
    score += 2 // â‰¥1000 = ä¼˜ç§€
  } else if (data.page_views >= 100) {
    score += 1 // â‰¥100 = è‰¯å¥½
  }
  // < 100 = 0åˆ†

  return Math.min(score, 12) // ç¡®ä¿ä¸è¶…è¿‡æœ€å¤§å€¼
}

/**
 * è®¡ç®—å…³é”®è¯å¯†åº¦è¯„åˆ† (0-7åˆ†)
 * å¤ç”¨æ—§ç³»ç»Ÿçš„ç®—æ³•ï¼Œä½†åˆ†å€¼ä»10åˆ†è°ƒæ•´ä¸º7åˆ†
 */
export function calculateKeywordDensityScore(
  keywordDensity: Record<string, number>,
  targetKeyword?: string
): number {
  // å¤ç”¨æ—§ç®—æ³•è®¡ç®—10åˆ†åˆ¶è¯„åˆ†
  const oldScore = calculateDensityScore7Point(keywordDensity, targetKeyword)

  // æ˜ å°„åˆ°7åˆ†åˆ¶: 10åˆ† â†’ 7åˆ†
  // æ˜ å°„è§„åˆ™: 7åˆ†åˆ¶ = (10åˆ†åˆ¶ / 10) * 7
  const newScore = Math.round((oldScore / 10) * 7)

  return newScore
}

/**
 * è°ƒç”¨ AI æœåŠ¡è¿›è¡Œ E-E-A-T è¯„åˆ†
 * æ³¨æ„ï¼šAI åªè¿”å› 88åˆ†çš„è¯„åˆ†ï¼ˆä¸åŒ…æ‹¬ engagement_score å’Œ keyword_density_scoreï¼‰
 */
async function callEEATAI(
  prompt: string,
  aiModel: 'claude' | 'gpt' | 'gemini' | 'claude-code-cli'
): Promise<EEATAIScoreResult> {
  try {
    console.log('[E-E-A-T Score] è°ƒç”¨ AI æœåŠ¡...')

    // è°ƒç”¨ seoAIService (æ”¯æŒå¤šç§AIæ¨¡å‹ï¼ŒåŒ…æ‹¬æœ¬åœ° claude-code-cli)
    const response = await seoAIService.callAI(prompt, aiModel)

    // è§£æå“åº”
    let jsonContent = response

    // å¦‚æœå“åº”åŒ…å« markdown ä»£ç å—ï¼Œæå– JSON
    const jsonMatch = jsonContent.match(/```json\n([\s\S]*?)\n```/) ||
                     jsonContent.match(/```\n([\s\S]*?)\n```/)

    if (jsonMatch) {
      jsonContent = jsonMatch[1]
    }

    const result = JSON.parse(jsonContent.trim())

    // ğŸ”„ é€‚é…å¤šç§AIå“åº”æ ¼å¼
    let eeatResult: EEATAIScoreResult

    if (result.dimension_scores) {
      // âœ… æ–°æ ¼å¼ (ä»æ•°æ®åº“æç¤ºè¯æ¨¡æ¿): {dimension_scores: {...}, suggestions: [...]}
      console.log('[E-E-A-T Score] æ£€æµ‹åˆ°æ–°æ ¼å¼å“åº” (dimension_scores)')

      // è½¬æ¢suggestionså¯¹è±¡æ•°ç»„ä¸ºå­—ç¬¦ä¸²æ•°ç»„
      const rawSuggestions = result.suggestions || []
      const recommendations = rawSuggestions.map((sug: any) => {
        if (typeof sug === 'string') {
          return sug
        }
        // æ–°æ ¼å¼: {category, issue, suggestion, priority, expected_impact}
        return `ã€${sug.category}ã€‘${sug.issue}\nå»ºè®®: ${sug.suggestion}\né¢„æœŸæ•ˆæœ: ${sug.expected_impact || 'æå‡EEATåˆ†æ•°'}`
      })

      eeatResult = {
        trustworthiness_score: result.dimension_scores.trustworthiness || 0,
        authoritativeness_score: result.dimension_scores.authoritativeness || 0,
        expertise_score: result.dimension_scores.expertise || 0,
        comprehensiveness_score: result.dimension_scores.comprehensiveness || 0,
        information_gain_score: result.dimension_scores.information_gain || 0,
        structured_quality_score: result.dimension_scores.structured_quality || 0,
        readability_score: result.dimension_scores.readability || 0,
        keyword_optimization_score: result.dimension_scores.keyword_optimization || 0,
        recommendations: recommendations
      }
    } else {
      // âš ï¸ æ—§æ ¼å¼ (å…¼å®¹æ€§): {trustworthiness_score, authoritativeness_score, ...}
      console.log('[E-E-A-T Score] æ£€æµ‹åˆ°æ—§æ ¼å¼å“åº” (ç›´æ¥å­—æ®µ)')
      eeatResult = result as EEATAIScoreResult
    }

    // éªŒè¯å¿…éœ€å­—æ®µ
    if (
      typeof eeatResult.trustworthiness_score !== 'number' ||
      typeof eeatResult.authoritativeness_score !== 'number' ||
      typeof eeatResult.expertise_score !== 'number' ||
      !Array.isArray(eeatResult.recommendations)
    ) {
      console.error('[E-E-A-T Score] AI è¿”å›æ ¼å¼ä¸æ­£ç¡®:', result)
      throw new Error('AI è¿”å›çš„è¯„åˆ†æ ¼å¼ä¸æ­£ç¡®')
    }

    console.log('[E-E-A-T Score] AI è¯„åˆ†å®Œæˆ:', {
      trust: eeatResult.trustworthiness_score,
      authority: eeatResult.authoritativeness_score,
      expertise: eeatResult.expertise_score,
      recommendations: eeatResult.recommendations.length
    })

    return eeatResult

  } catch (error) {
    console.error('[E-E-A-T Score] AI è°ƒç”¨å¤±è´¥:', error)
    throw error
  }
}

/**
 * ä¸»è¯„åˆ†å‡½æ•° - è®¡ç®—å®Œæ•´çš„ E-E-A-T è¯„åˆ†
 *
 * @param data - SEO æŒ‡å—æ•°æ®
 * @param aiModel - AI æ¨¡å‹é€‰æ‹© ('claude' | 'gpt' | 'gemini' | 'claude-code-cli')
 * @returns E-E-A-T è¯„åˆ†ç»“æœ
 */
export async function calculateEEATScore(
  data: EEATGuideData,
  aiModel: 'claude' | 'gpt' | 'gemini' | 'claude-code-cli' = 'claude'
): Promise<EEATScoreResult> {
  try {
    console.log('[E-E-A-T Score] å¼€å§‹è®¡ç®—è¯„åˆ†...')

    // 1. æå–å®Œæ•´å†…å®¹
    const fullContent = extractFullContent({
      meta_title: data.meta_title,
      meta_description: data.meta_description,
      meta_keywords: data.meta_keywords,
      guide_intro: data.guide_intro,
      guide_content: data.guide_content,
      faq_items: data.faq_items
    })

    // 2. è®¡ç®—å…³é”®è¯å¯†åº¦ï¼ˆå•å…³é”®è¯ä¼˜åŒ–ç­–ç•¥ï¼Œä»…è®¡ç®—ç›®æ ‡å…³é”®è¯ï¼‰
    const allKeywords = data.target_keyword ? [data.target_keyword] : []

    const keywordDensity = calculateKeywordDensity(fullContent, allKeywords)
    console.log('[E-E-A-T Score] å…³é”®è¯å¯†åº¦è®¡ç®—å®Œæˆ:', {
      å…³é”®è¯æ•°é‡: allKeywords.length,
      å¯†åº¦ç»“æœæ•°: Object.keys(keywordDensity).length
    })

    // 3. å°†å¯†åº¦æ•°æ®ä¼ é€’ç»™ AIï¼ˆç”¨äºç”Ÿæˆå‡†ç¡®å»ºè®®ï¼‰
    const dataWithDensity: EEATGuideData = {
      ...data,
      keyword_density: keywordDensity
    }

    // 4. è°ƒç”¨ AI è¿›è¡Œè¯„åˆ† (88åˆ†)
    const aiPrompt = await buildEEATExpertPrompt(dataWithDensity)
    const aiScore = await callEEATAI(aiPrompt, aiModel)

    // 5. ç®—æ³•è®¡ç®—ç”¨æˆ·å‚ä¸åº¦è¯„åˆ† (12åˆ†)
    const engagementScore = calculateEngagementScore({
      page_views: data.page_views || 0,
      unique_visitors: data.unique_visitors || 0,
      avg_time_on_page: data.avg_time_on_page || 0,
      bounce_rate: data.bounce_rate || 0,
      conversion_rate: data.conversion_rate || 0
    })
    console.log('[E-E-A-T Score] ç”¨æˆ·å‚ä¸åº¦è¯„åˆ†:', engagementScore)

    // 6. ç®—æ³•è®¡ç®—å…³é”®è¯å¯†åº¦è¯„åˆ† (7åˆ†)
    const densityScore = calculateKeywordDensityScore(keywordDensity, data.target_keyword)
    console.log('[E-E-A-T Score] å…³é”®è¯å¯†åº¦è¯„åˆ†:', densityScore)

    // 7. åˆå¹¶æ‰€æœ‰è¯„åˆ†
    const totalScore =
      aiScore.trustworthiness_score +       // 0-15
      aiScore.authoritativeness_score +     // 0-10
      aiScore.expertise_score +             // 0-10
      aiScore.comprehensiveness_score +     // 0-12
      aiScore.information_gain_score +      // 0-10
      aiScore.structured_quality_score +    // 0-8
      engagementScore +                     // 0-12 (ç®—æ³•)
      aiScore.readability_score +           // 0-8
      aiScore.keyword_optimization_score +  // 0-8
      densityScore                          // 0-7 (ç®—æ³•)

    console.log('[E-E-A-T Score] æ€»åˆ†è®¡ç®—å®Œæˆ:', {
      æ€»åˆ†: totalScore,
      AIè¯„åˆ†: totalScore - engagementScore - densityScore,
      å‚ä¸åº¦è¯„åˆ†: engagementScore,
      å¯†åº¦è¯„åˆ†: densityScore
    })

    const result: EEATScoreResult = {
      total_score: totalScore,

      // E-E-A-T ç»´åº¦ (35åˆ†)
      trustworthiness_score: aiScore.trustworthiness_score,
      authoritativeness_score: aiScore.authoritativeness_score,
      expertise_score: aiScore.expertise_score,

      // å†…å®¹è´¨é‡ç»´åº¦ (30åˆ†)
      comprehensiveness_score: aiScore.comprehensiveness_score,
      information_gain_score: aiScore.information_gain_score,
      structured_quality_score: aiScore.structured_quality_score,

      // ç”¨æˆ·æ»¡æ„åº¦ç»´åº¦ (20åˆ†)
      engagement_score: engagementScore,
      readability_score: aiScore.readability_score,

      // æŠ€æœ¯SEOç»´åº¦ (15åˆ†)
      keyword_optimization_score: aiScore.keyword_optimization_score,
      keyword_density_score: densityScore,

      // å…¶ä»–æ•°æ®
      keyword_density: keywordDensity,
      recommendations: aiScore.recommendations || []
    }

    return result

  } catch (error) {
    console.error('[E-E-A-T Score] è¯„åˆ†å¤±è´¥:', error)
    throw error
  }
}

/**
 * è·å– E-E-A-T è¯„åˆ†ç­‰çº§
 */
export function getEEATScoreGrade(score: number): EEATScoreGrade {
  if (score >= 90) {
    return { grade: 'A+', color: 'success', label: 'å“è¶Š (Google 2025 æ ‡å‡†)' }
  } else if (score >= 80) {
    return { grade: 'A', color: 'success', label: 'ä¼˜ç§€' }
  } else if (score >= 70) {
    return { grade: 'B', color: 'info', label: 'è‰¯å¥½' }
  } else if (score >= 60) {
    return { grade: 'C', color: 'warning', label: 'åŠæ ¼' }
  } else if (score >= 40) {
    return { grade: 'D', color: 'warning', label: 'éœ€æ”¹è¿›' }
  } else {
    return { grade: 'F', color: 'error', label: 'ä¸åˆæ ¼' }
  }
}

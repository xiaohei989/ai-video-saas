/**
 * è·¨å¹³å°å…¨å±æ’­æ”¾å·¥å…·å‡½æ•°
 * å¤„ç†iOS Safariå’Œå…¶ä»–æµè§ˆå™¨çš„å…¨å±APIå·®å¼‚
 */

// æ‰©å±•HTMLVideoElementæ¥å£ä»¥åŒ…å«webkitæ–¹æ³•
interface WebKitVideoElement extends HTMLVideoElement {
  webkitEnterFullscreen?: () => void
  webkitExitFullscreen?: () => void
  webkitDisplayingFullscreen?: boolean
}

// æ‰©å±•Documentæ¥å£ä»¥åŒ…å«webkitå…¨å±å±æ€§
interface WebKitDocument extends Document {
  webkitFullscreenElement?: Element
  webkitExitFullscreen?: () => void
  webkitIsFullScreen?: boolean
}

/**
 * è®¾å¤‡å’Œæµè§ˆå™¨èƒ½åŠ›æ£€æµ‹
 */
export interface DeviceCapabilities {
  isiOS: boolean
  isiOSChrome: boolean
  isiOSSafari: boolean
  supportsWebkitFullscreen: boolean
  supportsStandardFullscreen: boolean
  isMobile: boolean
}

/**
 * å…¨å±çŠ¶æ€ä¿¡æ¯
 */
export interface FullscreenState {
  isFullscreen: boolean
  method: 'webkit' | 'standard' | 'none'
  element: Element | null
}

/**
 * æ£€æµ‹è®¾å¤‡å’Œæµè§ˆå™¨èƒ½åŠ›
 */
export function detectDeviceCapabilities(): DeviceCapabilities {
  if (typeof navigator === 'undefined' || typeof window === 'undefined') {
    return {
      isiOS: false,
      isiOSChrome: false,
      isiOSSafari: false,
      supportsWebkitFullscreen: false,
      supportsStandardFullscreen: false,
      isMobile: false
    }
  }

  const userAgent = navigator.userAgent
  const isiOS = /iPad|iPhone|iPod/.test(userAgent)
  const isiOSChrome = isiOS && /CriOS/.test(userAgent)
  const isiOSSafari = isiOS && /Safari/.test(userAgent) && !/CriOS/.test(userAgent)
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent)
  
  // æ£€æµ‹webkitå…¨å±æ”¯æŒ
  const testVideo = document.createElement('video') as WebKitVideoElement
  const supportsWebkitFullscreen = typeof testVideo.webkitEnterFullscreen === 'function'
  
  // æ£€æµ‹æ ‡å‡†å…¨å±æ”¯æŒ
  const testDiv = document.createElement('div')
  const supportsStandardFullscreen = typeof testDiv.requestFullscreen === 'function'

  return {
    isiOS,
    isiOSChrome,
    isiOSSafari,
    supportsWebkitFullscreen,
    supportsStandardFullscreen,
    isMobile
  }
}

/**
 * è·å–å½“å‰å…¨å±çŠ¶æ€
 */
export function getFullscreenState(): FullscreenState {
  const doc = document as WebKitDocument
  
  // æ£€æŸ¥webkitå…¨å±çŠ¶æ€
  if (doc.webkitIsFullScreen || doc.webkitFullscreenElement) {
    return {
      isFullscreen: true,
      method: 'webkit',
      element: doc.webkitFullscreenElement || null
    }
  }
  
  // æ£€æŸ¥æ ‡å‡†å…¨å±çŠ¶æ€
  if (doc.fullscreenElement) {
    return {
      isFullscreen: true,
      method: 'standard',
      element: doc.fullscreenElement
    }
  }
  
  return {
    isFullscreen: false,
    method: 'none',
    element: null
  }
}

/**
 * iOSä¸“ç”¨ï¼šè§†é¢‘å…¨å±å¤„ç†
 */
export async function enterVideoFullscreeniOS(video: WebKitVideoElement): Promise<boolean> {
  if (!video.webkitEnterFullscreen) {
    console.warn('[Fullscreen] iOS webkitå…¨å±APIä¸å¯ç”¨')
    return false
  }

  try {
    video.webkitEnterFullscreen()
    console.log('[Fullscreen] iOS webkitå…¨å±å·²è§¦å‘')
    return true
  } catch (error) {
    console.error('[Fullscreen] iOS webkitå…¨å±å¤±è´¥:', error)
    return false
  }
}

/**
 * iOSä¸“ç”¨ï¼šé€€å‡ºè§†é¢‘å…¨å±
 */
export async function exitVideoFullscreeniOS(video: WebKitVideoElement): Promise<boolean> {
  if (!video.webkitExitFullscreen) {
    console.warn('[Fullscreen] iOS webkité€€å‡ºå…¨å±APIä¸å¯ç”¨')
    return false
  }

  try {
    video.webkitExitFullscreen()
    console.log('[Fullscreen] iOS webkité€€å‡ºå…¨å±å·²è§¦å‘')
    return true
  } catch (error) {
    console.error('[Fullscreen] iOS webkité€€å‡ºå…¨å±å¤±è´¥:', error)
    return false
  }
}

/**
 * æ ‡å‡†å…¨å±APIï¼šè¿›å…¥å…¨å±
 */
export async function enterFullscreenStandard(element: HTMLElement): Promise<boolean> {
  if (!element.requestFullscreen) {
    console.warn('[Fullscreen] æ ‡å‡†å…¨å±APIä¸å¯ç”¨')
    return false
  }

  try {
    await element.requestFullscreen()
    console.log('[Fullscreen] æ ‡å‡†å…¨å±å·²è¿›å…¥')
    return true
  } catch (error) {
    console.error('[Fullscreen] æ ‡å‡†å…¨å±å¤±è´¥:', error)
    return false
  }
}

/**
 * æ ‡å‡†å…¨å±APIï¼šé€€å‡ºå…¨å±
 */
export async function exitFullscreenStandard(): Promise<boolean> {
  if (!document.exitFullscreen) {
    console.warn('[Fullscreen] æ ‡å‡†é€€å‡ºå…¨å±APIä¸å¯ç”¨')
    return false
  }

  try {
    await document.exitFullscreen()
    console.log('[Fullscreen] æ ‡å‡†å…¨å±å·²é€€å‡º')
    return true
  } catch (error) {
    console.error('[Fullscreen] æ ‡å‡†é€€å‡ºå…¨å±å¤±è´¥:', error)
    return false
  }
}

/**
 * æ™ºèƒ½å…¨å±åˆ‡æ¢ï¼šè‡ªåŠ¨é€‰æ‹©åˆé€‚çš„API
 */
export async function toggleFullscreen(
  videoElement: HTMLVideoElement,
  containerElement?: HTMLElement
): Promise<boolean> {
  const capabilities = detectDeviceCapabilities()
  const state = getFullscreenState()

  console.log('[Fullscreen] è®¾å¤‡èƒ½åŠ›:', capabilities)
  console.log('[Fullscreen] å½“å‰çŠ¶æ€:', state)

  // å¦‚æœå·²ç»åœ¨å…¨å±çŠ¶æ€ï¼Œå°è¯•é€€å‡º
  if (state.isFullscreen) {
    if (capabilities.isiOS && capabilities.supportsWebkitFullscreen) {
      return await exitVideoFullscreeniOS(videoElement as WebKitVideoElement)
    } else if (capabilities.supportsStandardFullscreen) {
      return await exitFullscreenStandard()
    }
  } else {
    // å°è¯•è¿›å…¥å…¨å±
    if (capabilities.isiOS && capabilities.supportsWebkitFullscreen) {
      // iOSä½¿ç”¨è§†é¢‘ä¸“ç”¨å…¨å±
      return await enterVideoFullscreeniOS(videoElement as WebKitVideoElement)
    } else if (capabilities.supportsStandardFullscreen && containerElement) {
      // å…¶ä»–å¹³å°ä½¿ç”¨æ ‡å‡†å…¨å±
      return await enterFullscreenStandard(containerElement)
    }
  }

  console.warn('[Fullscreen] å½“å‰è®¾å¤‡ä¸æ”¯æŒå…¨å±åŠŸèƒ½')
  return false
}

/**
 * åˆ›å»ºå…¨å±äº‹ä»¶ç›‘å¬å™¨
 */
export function createFullscreenEventListener(
  callback: (isFullscreen: boolean, method: 'webkit' | 'standard') => void
): () => void {
  const capabilities = detectDeviceCapabilities()
  const cleanupFunctions: Array<() => void> = []

  // iOS webkitäº‹ä»¶ç›‘å¬
  if (capabilities.isiOS) {
    const handleWebkitBegin = () => {
      console.log('[Fullscreen] iOS webkitå¼€å§‹å…¨å±')
      callback(true, 'webkit')
    }
    
    const handleWebkitEnd = () => {
      console.log('[Fullscreen] iOS webkitç»“æŸå…¨å±')
      callback(false, 'webkit')
    }
    
    // æ³¨æ„ï¼šè¿™äº›äº‹ä»¶éœ€è¦ç»‘å®šåˆ°videoå…ƒç´ ä¸Šï¼Œè€Œä¸æ˜¯document
    // è¿™é‡Œæä¾›é€šç”¨çš„äº‹ä»¶åç§°ï¼Œå…·ä½“ç»‘å®šåœ¨ç»„ä»¶ä¸­å¤„ç†
    cleanupFunctions.push(() => {
      // iOSäº‹ä»¶çš„æ¸…ç†ä¼šåœ¨ç»„ä»¶ä¸­å¤„ç†
    })
  }

  // æ ‡å‡†å…¨å±äº‹ä»¶ç›‘å¬
  if (capabilities.supportsStandardFullscreen) {
    const handleFullscreenChange = () => {
      const state = getFullscreenState()
      console.log('[Fullscreen] æ ‡å‡†å…¨å±çŠ¶æ€å˜åŒ–:', state)
      callback(state.isFullscreen, 'standard')
    }

    document.addEventListener('fullscreenchange', handleFullscreenChange)
    cleanupFunctions.push(() => {
      document.removeEventListener('fullscreenchange', handleFullscreenChange)
    })
  }

  // è¿”å›æ¸…ç†å‡½æ•°
  return () => {
    cleanupFunctions.forEach(cleanup => cleanup())
  }
}

/**
 * è·å–å…¨å±æŒ‰é’®çš„æç¤ºæ–‡æœ¬
 */
export function getFullscreenTooltip(isFullscreen: boolean): string {
  const capabilities = detectDeviceCapabilities()
  
  if (capabilities.isiOS) {
    return isFullscreen ? 'é€€å‡ºå…¨å± (iOS)' : 'å…¨å±æ’­æ”¾ (iOS)'
  }
  
  return isFullscreen ? 'é€€å‡ºå…¨å±' : 'å…¨å±æ’­æ”¾'
}

/**
 * æ£€æŸ¥æ˜¯å¦æ”¯æŒå…¨å±åŠŸèƒ½
 */
export function supportsFullscreen(): boolean {
  const capabilities = detectDeviceCapabilities()
  return capabilities.supportsWebkitFullscreen || capabilities.supportsStandardFullscreen
}

/**
 * è·å–å…¨å±åŠŸèƒ½ä¸å¯ç”¨çš„åŸå› 
 */
export function getFullscreenUnavailableReason(): string {
  const capabilities = detectDeviceCapabilities()
  
  if (capabilities.isiOS && !capabilities.supportsWebkitFullscreen) {
    return 'iOS Safariå…¨å±åŠŸèƒ½ä¸å¯ç”¨'
  }
  
  if (!capabilities.supportsStandardFullscreen) {
    return 'æµè§ˆå™¨ä¸æ”¯æŒå…¨å±åŠŸèƒ½'
  }
  
  return 'æœªçŸ¥åŸå› '
}

/**
 * åˆ›å»ºiOSä¸“ç”¨çš„è§†é¢‘äº‹ä»¶ç»‘å®šå·¥å…·
 */
export function bindVideoFullscreenEventsiOS(
  video: WebKitVideoElement,
  onEnter: () => void,
  onExit: () => void
): () => void {
  if (!video) return () => {}

  // ğŸ”§ ä¿®å¤ï¼šæ·»åŠ ç»„ä»¶å¸è½½çŠ¶æ€æ£€æŸ¥ï¼Œé˜²æ­¢äº‹ä»¶å¤„ç†å™¨åœ¨ç»„ä»¶å¸è½½åè¢«è°ƒç”¨
  let isActive = true

  const handleWebkitBegin = () => {
    // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦ä»ç„¶æ´»è·ƒçŠ¶æ€
    if (!isActive) return
    
    // å®‰å…¨è°ƒç”¨å›è°ƒå‡½æ•°
    if (typeof onEnter === 'function') {
      try {
        onEnter()
      } catch (error) {
        console.warn('[FullscreenHelper] iOS fullscreen enter callback error:', error)
      }
    }
  }
  
  const handleWebkitEnd = () => {
    // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦ä»ç„¶æ´»è·ƒçŠ¶æ€
    if (!isActive) return
    
    // å®‰å…¨è°ƒç”¨å›è°ƒå‡½æ•°
    if (typeof onExit === 'function') {
      try {
        onExit()
      } catch (error) {
        console.warn('[FullscreenHelper] iOS fullscreen exit callback error:', error)
      }
    }
  }

  video.addEventListener('webkitbeginfullscreen', handleWebkitBegin)
  video.addEventListener('webkitendfullscreen', handleWebkitEnd)

  return () => {
    // ğŸ”§ ä¿®å¤ï¼šæ ‡è®°ä¸ºéæ´»è·ƒçŠ¶æ€ï¼Œé˜²æ­¢åç»­äº‹ä»¶å¤„ç†
    isActive = false
    
    // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
    if (video) {
      video.removeEventListener('webkitbeginfullscreen', handleWebkitBegin)
      video.removeEventListener('webkitendfullscreen', handleWebkitEnd)
    }
  }
}
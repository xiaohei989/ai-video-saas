/**
 * SimpleVideoPlayer - åŸºäºä¸»æµè§†é¢‘ç½‘ç«™æœ€ä½³å®è·µçš„ç®€åŒ–æ’­æ”¾å™¨
 * 
 * è®¾è®¡ç†å¿µï¼š
 * - ä½¿ç”¨åŸç”Ÿ <video> æ ‡ç­¾è·å¾—æœ€ä½³æ€§èƒ½
 * - preload="metadata" å®ç°å¿«é€Ÿå¯åŠ¨
 * - æœ€å°åŒ– JavaScript æ§åˆ¶ï¼Œä¾èµ–æµè§ˆå™¨åŸç”Ÿä¼˜åŒ–
 * - å¯¹æ ‡ YouTubeã€Twitter ç­‰ä¸»æµç½‘ç«™çš„æ’­æ”¾ä½“éªŒ
 */

import React, { useState, useRef, useEffect, useCallback, useMemo } from 'react'
import { Play, Pause, Volume2, VolumeX, Maximize, Minimize } from 'lucide-react'
import { cn } from '@/utils/cn'
import { getProxyVideoUrl, getVideoFallbackUrl } from '@/utils/videoUrlProxy'
import { getOptimalThumbnailSource, supportsMediaFragments } from '@/utils/thumbnailFallback'
import { ensurePreconnect, ensurePreloadVideo } from '@/utils/networkPriority'
import { 
  toggleFullscreen as toggleFullscreenHelper,
  getFullscreenState,
  detectDeviceCapabilities,
  bindVideoFullscreenEventsiOS,
  getFullscreenTooltip
} from '@/utils/fullscreenHelper'
import { useVideoPlayback, VideoPlayerInstance } from '@/contexts/VideoPlaybackContext'
import { useResponsiveDevice, supportsHover } from '@/utils/deviceDetection'

export interface SimpleVideoPlayerProps {
  // åŸºæœ¬å±æ€§
  src: string
  poster?: string
  className?: string
  alt?: string
  
  // æ’­æ”¾æ§åˆ¶
  autoPlayOnHover?: boolean
  showPlayButton?: boolean
  muted?: boolean
  disablePreload?: boolean
  
  // äº‹ä»¶å›è°ƒ
  onPlay?: () => void
  onPause?: () => void
  onTimeUpdate?: (currentTime: number, duration: number, isPlaying: boolean) => void
  onLoadStart?: () => void
  onCanPlay?: () => void
  onError?: () => void
  onClick?: () => void
  // æ–°å¢ï¼šç¼“å†²è¿›åº¦å›è°ƒï¼ˆç”¨äºå¤–å±‚è‡ªå®šä¹‰åŠ è½½UIæ˜¾ç¤ºç™¾åˆ†æ¯”ï¼‰
  onBufferProgress?: (progress: number) => void
  
  // æ ·å¼æ§åˆ¶
  objectFit?: 'contain' | 'cover'
  
  // æ ‡è¯†ç¬¦ï¼ˆç”¨äºåˆ†æå’Œè°ƒè¯•ï¼‰
  videoId?: string
  videoTitle?: string
  
  // URLå›é€€ï¼ˆå¯é€‰ï¼‰
  fallbackSrc?: string
}

export default function SimpleVideoPlayer({
  src,
  poster,
  className,
  alt,
  autoPlayOnHover = false,
  showPlayButton = true,
  muted = false, // é»˜è®¤æœ‰å£°éŸ³æ’­æ”¾
  disablePreload = false,
  onPlay,
  onPause,
  onTimeUpdate,
  onLoadStart,
  onCanPlay,
  onError,
  onClick,
  onBufferProgress,
  objectFit = 'cover',
  videoId,
  videoTitle,
  fallbackSrc,
}: SimpleVideoPlayerProps) {
  const videoRef = useRef<HTMLVideoElement>(null)
  const containerRef = useRef<HTMLDivElement>(null)
  const [isPlaying, setIsPlaying] = useState(false)
  const [isHovered, setIsHovered] = useState(false)
  const [currentTime, setCurrentTime] = useState(0)
  const [duration, setDuration] = useState(0)
  const [showControls, setShowControls] = useState(false)
  const [isMuted, setIsMuted] = useState(muted)
  const [isFullscreen, setIsFullscreen] = useState(false)
  // ç§»é™¤ isHoverLoadingï¼Œç»Ÿä¸€ä½¿ç”¨ isBuffering çŠ¶æ€
  
  // è§†é¢‘åŠ è½½çŠ¶æ€
  const [isLoading, setIsLoading] = useState(true)
  const [hasError, setHasError] = useState(false)
  const [hasMetadata, setHasMetadata] = useState(false)
  const [currentVideoSrc, setCurrentVideoSrc] = useState(src)
  const [hasTriedFallback, setHasTriedFallback] = useState(false)
  
  // ğŸš€ ç¼“å†²è¿›åº¦ç›¸å…³çŠ¶æ€
  const [bufferProgress, setBufferProgress] = useState(0) // åŸå§‹è¿›åº¦
  const bufferProgressRef = useRef(0)
  const [uiProgress, setUiProgress] = useState(0) // å¹³æ»‘æ˜¾ç¤ºè¿›åº¦
  const uiTargetRef = useRef(0)
  const progressAnimRef = useRef<number | null>(null)
  const heartbeatRef = useRef<number | null>(null)
  const lastRealUpdateRef = useRef<number>(0)
  const [isBuffering, setIsBuffering] = useState(false) // æ˜¯å¦æ­£åœ¨ç¼“å†²
  const [canPlaySmooth, setCanPlaySmooth] = useState(false) // æ˜¯å¦æœ‰è¶³å¤Ÿç¼“å†²å¯ä»¥æµç•…æ’­æ”¾
  const [currentPreload, setCurrentPreload] = useState<"none" | "metadata" | "auto">(disablePreload ? "none" : "metadata")
  
  // ğŸ”§ ä¿®å¤ç‚¹å‡»æš‚åœåè‡ªåŠ¨æ’­æ”¾çš„é—®é¢˜
  const [userPaused, setUserPaused] = useState(false) // ç”¨æˆ·æ˜¯å¦ä¸»åŠ¨æš‚åœ
  // ç”¨æˆ·æ˜¯å¦åœ¨æœ¬æ’­æ”¾å™¨ä¸Šäº§ç”Ÿè¿‡äº¤äº’ï¼ˆç”¨äºç§»åŠ¨ç«¯ä»…åœ¨äº¤äº’åå±•ç¤ºåŠ è½½åŠ¨ç”»ï¼‰
  const [hasInteracted, setHasInteracted] = useState(false)
  // ğŸ”§ ç§»åŠ¨ç«¯ä¸“ç”¨ï¼šæ’­æ”¾ç‚¹å‡»é˜²æŠ–ï¼Œé¿å…å¿«é€Ÿç‚¹å‡»å¯¼è‡´çš„æ’­æ”¾/æš‚åœå¾ªç¯
  const mobilePlayDebounceRef = useRef<number | null>(null)
  
  // ğŸ”§ ä¿®å¤ï¼šç»„ä»¶æŒ‚è½½çŠ¶æ€è¿½è¸ªï¼Œé˜²æ­¢ç»„ä»¶å¸è½½åè°ƒç”¨state setters
  const isMountedRef = useRef(true)

  // ğŸ” è°ƒè¯•ï¼šæ·»åŠ è¯¦ç»†çš„é”™è¯¯æ—¥å¿—ç³»ç»Ÿ
  const safeSetState = (setter: any, value: any, stateName: string) => {
    if (!isMountedRef.current) {
      return
    }
    
    if (typeof setter !== 'function') {
      console.error(`[SimpleVideoPlayer] ${stateName} setterä¸æ˜¯å‡½æ•°:`, typeof setter, setter)
      return
    }
    
    try {
      setter(value)
    } catch (error) {
      console.error(`[SimpleVideoPlayer] è°ƒç”¨ ${stateName} setteræ—¶å‡ºé”™:`, error)
    }
  }
  
  // æ‚¬åœæ’­æ”¾æ§åˆ¶ - ç®€åŒ–ç‰ˆæœ¬
  
  // è®¾å¤‡èƒ½åŠ›æ£€æµ‹ - ä½¿ç”¨å“åº”å¼æ£€æµ‹
  const { isMobile, deviceType } = useResponsiveDevice()
  const [deviceCapabilities] = useState(detectDeviceCapabilities())
  const canHover = supportsHover() // æ£€æµ‹æ˜¯å¦æ”¯æŒæ‚¬åœ
  // æ‚¬åœè½»åº¦æŠ¢å å®šæ—¶å™¨ï¼ˆé¿å…é¢‘ç¹ hover å³æ—¶æ‰“æ–­ï¼‰
  const hoverPreemptTimerRef = useRef<number | null>(null)
  // æ‚¬åœè‡ªåŠ¨æ’­æ”¾é‡è¯•å®šæ—¶å™¨
  const hoverRetryTimerRef = useRef<number | null>(null)

  // ğŸ”§ ä¿®å¤ï¼šå°†playerIdå®šä¹‰æå‰ï¼Œé¿å…åœ¨useCallbackä¸­å¼•ç”¨æœªå®šä¹‰çš„å˜é‡
  // ç®€åŒ–çš„å…¨å±€æ’­æ”¾ç®¡ç† - ä»…ç”¨äºç‚¹å‡»æ’­æ”¾æ§åˆ¶
  const { registerPlayer, unregisterPlayer, requestPlay, notifyPause, isCurrentlyPlaying, isPendingPlay, immediateStopAll, isPlayMutexLocked } = useVideoPlayback()
  
  // ç”Ÿæˆå”¯ä¸€çš„æ’­æ”¾å™¨ID
  const playerId = useMemo(() => {
    if (videoId) return videoId
    // å¦‚æœæ²¡æœ‰æä¾›videoIdï¼ŒåŸºäºsrcç”Ÿæˆå”¯ä¸€ID
    return `video-${src.split('/').pop()?.split('?')[0] || Math.random().toString(36).substr(2, 9)}`
  }, [videoId, src])

  // è¿›åº¦åŠ¨ç”»ï¼šç¼“æ…¢æ¨è¿›æ˜¾ç¤ºåˆ°ç›®æ ‡å€¼
  const ensureProgressAnimator = useCallback(() => {
    if (progressAnimRef.current) return
    progressAnimRef.current = window.setInterval(() => {
      // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥ç»„ä»¶æ˜¯å¦ä»ç„¶æŒ‚è½½
      if (!isMountedRef.current) return
      
      const target = uiTargetRef.current
      safeSetState(setUiProgress, (prev: number) => {
        const diff = target - prev
        if (diff <= 0.05) return target
        const step = Math.min(Math.max(diff * 0.2, 0.5), 1.5) // 0.5%~1.5%
        const next = Math.min(prev + step, target)
        // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨ setTimeout é¿å…åœ¨ setState å›è°ƒä¸­ç›´æ¥è°ƒç”¨çˆ¶ç»„ä»¶çš„å›è°ƒ
        setTimeout(() => {
          if (isMountedRef.current) {
            onBufferProgress?.(next)
          }
        }, 0)
        return next
      }, 'uiProgress')
    }, 66)
  }, [onBufferProgress, safeSetState])

  const stopProgressAnimator = useCallback(() => {
    if (progressAnimRef.current) {
      clearInterval(progressAnimRef.current)
      progressAnimRef.current = null
    }
  }, [])

  const setUiTarget = useCallback((value: number) => {
    const clamped = Math.max(0, Math.min(100, value))
    uiTargetRef.current = Math.max(uiTargetRef.current, clamped)
    // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨ setTimeout é¿å…åœ¨æ¸²æŸ“æœŸé—´ç›´æ¥å¯åŠ¨åŠ¨ç”»
    setTimeout(() => ensureProgressAnimator(), 0)
  }, [ensureProgressAnimator])

  // å¿ƒè·³æ¨è¿›ï¼Œç¼ºå°‘çœŸå®è¿›åº¦æ—¶ç¼“æ…¢åˆ°65%
  const startHeartbeat = useCallback(() => {
    if (heartbeatRef.current) return
    console.log(`[SimpleVideoPlayer] å¼€å§‹å¿ƒè·³è¿›åº¦æ›´æ–°: ${playerId}`)
    heartbeatRef.current = window.setInterval(() => {
      // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥ç»„ä»¶æ˜¯å¦ä»ç„¶æŒ‚è½½
      if (!isMountedRef.current) return
      
      const now = Date.now()
      // ğŸ”§ ä¿®å¤ï¼šç§»é™¤65%ç¡¬ç¼–ç é™åˆ¶ï¼Œå…è®¸è¿›åº¦æ­£å¸¸æ›´æ–°åˆ°95%
      // æœ€å5%ä¿ç•™ç»™çœŸå®çš„æ’­æ”¾äº‹ä»¶æ›´æ–°ï¼Œé¿å…æ˜¾ç¤º100%ä½†å®é™…æœªå®Œæˆ
      if (now - lastRealUpdateRef.current > 600 && uiTargetRef.current < 95) {
        // ğŸš€ ä¼˜åŒ–ï¼šæ ¹æ®å½“å‰è¿›åº¦è°ƒæ•´å¢é•¿é€Ÿåº¦
        const currentProgress = uiTargetRef.current
        let increment = 1
        
        // 0-30%: æ­£å¸¸é€Ÿåº¦
        if (currentProgress < 30) {
          increment = 1
        }
        // 30-60%: ç¨æ…¢
        else if (currentProgress < 60) {
          increment = 0.8
        }
        // 60-80%: æ›´æ…¢
        else if (currentProgress < 80) {
          increment = 0.5
        }
        // 80-95%: æœ€æ…¢ï¼Œç»™çœŸå®åŠ è½½æ›´å¤šæ—¶é—´
        else {
          increment = 0.2
        }
        
        const newProgress = Math.min(95, uiTargetRef.current + increment)
        
        // ç§»åŠ¨ç«¯ï¼šåœ¨å…³é”®è¿›åº¦ç‚¹è®°å½•æ—¥å¿—
        if (isMobile && (newProgress >= 65 && currentProgress < 65)) {
          console.log(`[SimpleVideoPlayer-Mobile] çªç ´65%è¿›åº¦é™åˆ¶: ${playerId}, æ–°è¿›åº¦: ${newProgress}%`)
        }
        
        safeSetState(setUiTarget, newProgress, 'uiTarget')
      }
    }, 400)
  }, [setUiTarget, playerId, isMobile])

  const stopHeartbeat = useCallback(() => {
    if (heartbeatRef.current) {
      clearInterval(heartbeatRef.current)
      heartbeatRef.current = null
    }
  }, [])

  // åŸå§‹è¿›åº¦è®°å½• + è®¾ç½®æ˜¾ç¤ºç›®æ ‡ï¼ˆå•è°ƒé€’å¢ï¼‰
  const setProgressMonotonic = useCallback((value: number) => {
    // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥ç»„ä»¶æ˜¯å¦ä»ç„¶æŒ‚è½½
    if (!isMountedRef.current) return
    
    const clamped = Math.max(0, Math.min(100, value))
    safeSetState(setBufferProgress, (prev: number) => {
      const next = Math.max(prev, clamped)
      bufferProgressRef.current = next
      return next
    }, 'bufferProgress')
    lastRealUpdateRef.current = Date.now()
    safeSetState(setUiTarget, clamped, 'uiTarget')
  }, [setUiTarget])

  // ç®€åŒ–çš„è§†é¢‘æºä¼˜åŒ– - ä¸å†åŒºåˆ†æ‚¬åœæ¨¡å¼
  const getOptimizedVideoUrl = (videoSrc: string): string => {
    const proxyUrl = getProxyVideoUrl(videoSrc)
    // ä¸ºæå‡å…¼å®¹æ€§ï¼Œç»Ÿä¸€ç§»é™¤ Media Fragmentsï¼ˆ#t=...ï¼‰
    return proxyUrl
  }

  // æ™ºèƒ½ç¼©ç•¥å›¾æºé€‰æ‹©
  const optimalPoster = getOptimalThumbnailSource(src, poster)

  // ğŸš€ ä¼˜åŒ–ï¼šå½“æœ‰ç¼©ç•¥å›¾æ—¶ï¼Œç«‹å³å…è®¸æ˜¾ç¤ºå†…å®¹ï¼Œæ— éœ€ç­‰å¾…è§†é¢‘åŠ è½½
  useEffect(() => {
    if (optimalPoster && isLoading) {
      // å¦‚æœæœ‰å¯ç”¨çš„ç¼©ç•¥å›¾ï¼Œå¯ä»¥ç«‹å³æ˜¾ç¤ºå†…å®¹ï¼Œæ— éœ€ç­‰å¾…è§†é¢‘å…ƒæ•°æ®
      // ğŸ”§ ä¿®å¤ï¼šç§»é™¤ isLoading ä¾èµ–ï¼Œé¿å…æ¸²æŸ“æœŸé—´ setState å¾ªç¯
      safeSetState(setIsLoading, false, 'isLoading')
    }
  }, [optimalPoster, playerId]) // ç§»é™¤ isLoading ä¾èµ–

  // åˆ›å»ºæ’­æ”¾å™¨å®ä¾‹æ¥å£
  const playerInstance = useMemo<VideoPlayerInstance>(() => ({
    id: playerId,
    pause: () => {
      const video = videoRef.current
      if (video && !video.paused) {
        video.pause()
      }
    },
    play: async () => {
      const video = videoRef.current
      if (video && (video.paused || video.ended)) {
        // ğŸ”§ å…³é”®ä¿®å¤ï¼šå¦‚æœè§†é¢‘å·²ç»“æŸï¼Œé‡ç½®åˆ°å¼€å§‹ä½ç½®
        if (video.ended) {
          video.currentTime = 0
        }
        await video.play()
      }
    },
    getCurrentTime: () => videoRef.current?.currentTime || 0,
    getDuration: () => videoRef.current?.duration || 0,
    isPlaying: () => !!(videoRef.current && !videoRef.current.paused && !videoRef.current.ended),
    // ç«‹å³åœæ­¢æ–¹æ³•ï¼šæš‚åœå¹¶é‡ç½®åˆ°å¼€å§‹ä½ç½®
    stopImmediate: () => {
      const video = videoRef.current
      if (video) {
        if (!video.paused) {
          video.pause()
        }
        video.currentTime = 0
      }
    }
  }), [playerId])

  // æ³¨å†Œå’Œæ³¨é”€æ’­æ”¾å™¨
  useEffect(() => {
    // ğŸ”§ ä¿®å¤ï¼šå®‰å…¨è°ƒç”¨registerPlayerï¼Œé˜²æ­¢contextè¢«é”€æ¯æ—¶è°ƒç”¨å¤±è´¥
    if (typeof registerPlayer === 'function') {
      registerPlayer(playerId, playerInstance)
    }
    
    return () => {
      // ğŸ”§ ä¿®å¤ï¼šå®‰å…¨è°ƒç”¨unregisterPlayerï¼Œé˜²æ­¢contextè¢«é”€æ¯æ—¶è°ƒç”¨å¤±è´¥
      if (typeof unregisterPlayer === 'function') {
        unregisterPlayer(playerId)
      }
    }
  }, [playerId, registerPlayer, unregisterPlayer])

  // å¤„ç†srcå˜åŒ–ï¼Œé‡ç½®å›é€€çŠ¶æ€å’Œç¼“å†²çŠ¶æ€
  useEffect(() => {
    if (src !== currentVideoSrc) {
      safeSetState(setCurrentVideoSrc, src, 'currentVideoSrc')
      safeSetState(setHasTriedFallback, false, 'hasTriedFallback')
      safeSetState(setHasError, false, 'hasError')
      safeSetState(setIsLoading, true, 'isLoading')
      // ğŸ”„ åªåœ¨è§†é¢‘æºæ”¹å˜æ—¶æ‰é‡ç½®ç¼“å†²çŠ¶æ€
      safeSetState(setBufferProgress, 0, 'bufferProgress')
      bufferProgressRef.current = 0
      safeSetState(setUiProgress, 0, 'uiProgress')
      uiTargetRef.current = 0
      safeSetState(setCanPlaySmooth, false, 'canPlaySmooth')
      safeSetState(setIsBuffering, false, 'isBuffering')
      safeSetState(setCurrentPreload, disablePreload ? "none" : "metadata", 'currentPreload')
    }
  }, [src])

  // åŸºäºæ‚¬åœå°è¯•è‡ªåŠ¨æ’­æ”¾ï¼ˆå¯é‡è¯•ï¼‰
  const attemptHoverAutoplay = useCallback((enableRetry: boolean = false) => {
    const video = videoRef.current
    if (!video) return
    if (!(autoPlayOnHover && isHovered && !userPaused)) return
    if (isCurrentlyPlaying(playerId) || !video.paused) return
    // ä¿æŒå½“å‰é™éŸ³çŠ¶æ€ï¼Œä¸å†å¼ºåˆ¶é™éŸ³ä»¥æ»¡è¶³è‡ªåŠ¨æ’­æ”¾ç­–ç•¥
    // è‹¥äº’æ–¥é”è¢«å ç”¨ï¼Œä¼˜å…ˆé‡Šæ”¾ï¼ˆæ‚¬æµ®è‡ªåŠ¨æ’­æ”¾ä¼˜å…ˆå½“å‰è§†é¢‘ï¼‰
    try {
      // ğŸ”§ ä¿®å¤ï¼šå®‰å…¨è°ƒç”¨isPlayMutexLockedå’ŒimmediateStopAllï¼Œé˜²æ­¢contextè¢«é”€æ¯æ—¶è°ƒç”¨å¤±è´¥
      if (typeof isPlayMutexLocked === 'function' && isPlayMutexLocked()) {
        if (typeof immediateStopAll === 'function') {
          immediateStopAll()
        }
      }
    } catch {}
    // ğŸ”§ ä¿®å¤ï¼šå®‰å…¨è°ƒç”¨requestPlayï¼Œé˜²æ­¢contextè¢«é”€æ¯æ—¶è°ƒç”¨å¤±è´¥
    const ok = typeof requestPlay === 'function' ? requestPlay(playerId) : false
    if (ok) {
      video.play().catch(() => {})
    } else if (enableRetry) {
      if (hoverRetryTimerRef.current) window.clearTimeout(hoverRetryTimerRef.current)
      hoverRetryTimerRef.current = window.setTimeout(() => {
        try {
          // ğŸ”§ ä¿®å¤ï¼šå®‰å…¨è°ƒç”¨isPlayMutexLockedå’ŒimmediateStopAllï¼Œé˜²æ­¢contextè¢«é”€æ¯æ—¶è°ƒç”¨å¤±è´¥
          if (typeof isPlayMutexLocked === 'function' && isPlayMutexLocked()) {
            if (typeof immediateStopAll === 'function') {
              immediateStopAll()
            }
          }
        } catch {}
        // ğŸ”§ ä¿®å¤ï¼šå®‰å…¨è°ƒç”¨requestPlayï¼Œé˜²æ­¢contextè¢«é”€æ¯æ—¶è°ƒç”¨å¤±è´¥
        const ok2 = typeof requestPlay === 'function' ? requestPlay(playerId) : false
        if (ok2) {
          video.play().catch(() => {})
        }
      }, 120)
    }
  }, [autoPlayOnHover, isHovered, userPaused, isCurrentlyPlaying, playerId, isMuted, requestPlay, isPlayMutexLocked, immediateStopAll])

  // å¤„ç†æ’­æ”¾çŠ¶æ€å˜åŒ–
  useEffect(() => {
    const video = videoRef.current
    if (!video) return

    const handlePlay = () => {
      safeSetState(setIsPlaying, true, 'isPlaying')
      safeSetState(setIsBuffering, false, 'isBuffering') // æ’­æ”¾å¼€å§‹æ—¶å–æ¶ˆç¼“å†²çŠ¶æ€
      safeSetState(setIsLoading, false, 'isLoading') // ğŸ”§ ä¿®å¤ï¼šè§†é¢‘å¼€å§‹æ’­æ”¾æ—¶ç«‹å³å–æ¶ˆåŠ è½½çŠ¶æ€ï¼Œé¿å…éª¨éª¼å±é®æŒ¡ç”»é¢
      safeSetState(setUiTarget, 100, 'uiTarget')
      stopHeartbeat()
      onPlay?.()
    }

    const handlePause = () => {
      safeSetState(setIsPlaying, false, 'isPlaying')
      // ğŸ”§ ä¿®å¤ï¼šå®‰å…¨è°ƒç”¨notifyPauseï¼Œé˜²æ­¢contextè¢«é”€æ¯æ—¶è°ƒç”¨å¤±è´¥
      if (typeof notifyPause === 'function') {
        notifyPause(playerId)
      }
      onPause?.()
    }

    const handleTimeUpdate = () => {
      const time = video.currentTime
      const dur = video.duration || 0
      safeSetState(setCurrentTime, time, 'currentTime')
      onTimeUpdate?.(time, dur, !video.paused)
    }

    const handleLoadedMetadata = () => {
      safeSetState(setDuration, video.duration || 0, 'duration')
      safeSetState(setHasMetadata, true, 'hasMetadata')
      safeSetState(setIsLoading, false, 'isLoading')
      // å…ƒæ•°æ®å·²å°±ç»ªï¼Œç»™å‡ºä¿å®ˆçš„è¿›åº¦åé¦ˆï¼Œé¿å…é•¿æ—¶é—´æ˜¾ç¤º0%
      safeSetState(setProgressMonotonic, 10, 'progressMonotonic')
      safeSetState(setUiTarget, 15, 'uiTarget')
    }

    const handleEnded = () => {
      safeSetState(setIsPlaying, false, 'isPlaying')
      // ğŸ”§ å…³é”®ä¿®å¤ï¼šè§†é¢‘ç»“æŸåæ€»æ˜¯é‡ç½®åˆ°å¼€å§‹ä½ç½®ï¼Œç¡®ä¿å¯ä»¥é‡æ–°æ’­æ”¾
      video.currentTime = 0
      // ğŸ”§ ä¿®å¤ï¼šå®‰å…¨è°ƒç”¨notifyPauseï¼Œé˜²æ­¢contextè¢«é”€æ¯æ—¶è°ƒç”¨å¤±è´¥
      if (typeof notifyPause === 'function') {
        notifyPause(playerId)
      }
    }

    // åŠ è½½çŠ¶æ€å¤„ç†
    const handleLoadStart = () => {
      safeSetState(setIsLoading, true, 'isLoading')
      safeSetState(setHasError, false, 'hasError')
      // ğŸ”§ ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šç®€åŒ–ç¼“å†²åˆ¤æ–­é€»è¾‘ï¼Œé¿å…å¤æ‚çš„äº¤äº’çŠ¶æ€ä¾èµ–
      const shouldBuffer = isMobile ? 
        hasInteracted : // ç§»åŠ¨ç«¯ï¼šä»…åœ¨ç”¨æˆ·äº¤äº’åæ˜¾ç¤ºç¼“å†²
        (autoPlayOnHover && isHovered) || hasInteracted // æ¡Œé¢ç«¯ï¼šä¿æŒåŸæœ‰é€»è¾‘
      
      safeSetState(setIsBuffering, shouldBuffer, 'isBuffering')
      // åŠ è½½å¼€å§‹æ—¶ç»™ä¸€ä¸ªæœ€å°è¿›åº¦ï¼Œé¿å…æ˜¾ç¤ºä¸º0%
      safeSetState(setProgressMonotonic, 1, 'progressMonotonic')
      safeSetState(setUiTarget, 5, 'uiTarget')
      if (shouldBuffer) startHeartbeat()
      onLoadStart?.()
    }

    const handleLoadedData = () => {
      safeSetState(setIsLoading, false, 'isLoading')
      // å·²æœ‰å½“å‰å¸§æ•°æ®ï¼Œè¿›åº¦è‡³å°‘æå‡åˆ°25%
      safeSetState(setProgressMonotonic, 25, 'progressMonotonic')
      safeSetState(setUiTarget, 30, 'uiTarget')
    }

    const handleError = () => {
      
      // ä½¿ç”¨æ™ºèƒ½å›é€€æœºåˆ¶
      if (!hasTriedFallback) {
        const fallbackUrl = getVideoFallbackUrl(currentVideoSrc, src)
        
        if (fallbackUrl !== currentVideoSrc) {
          
          safeSetState(setHasTriedFallback, true, 'hasTriedFallback')
          safeSetState(setCurrentVideoSrc, fallbackUrl, 'currentVideoSrc')
          safeSetState(setIsLoading, true, 'isLoading')
          safeSetState(setHasError, false, 'hasError')
          
          // æ›´æ–°videoå…ƒç´ çš„src
          if (video) {
            video.src = fallbackUrl
            video.load()
          }
          return
        }
      }
      
      // å¦‚æœè¿˜æœ‰ç”¨æˆ·æä¾›çš„å›é€€URLä¸”è¿˜æœªå°è¯•è¿‡ï¼Œåˆ™å°è¯•å›é€€
      if (fallbackSrc && currentVideoSrc !== fallbackSrc && !currentVideoSrc.includes(fallbackSrc)) {
        
        safeSetState(setCurrentVideoSrc, fallbackSrc, 'currentVideoSrc')
        safeSetState(setIsLoading, true, 'isLoading')
        safeSetState(setHasError, false, 'hasError')
        
        // æ›´æ–°videoå…ƒç´ çš„src
        if (video) {
          video.src = getOptimizedVideoUrl(fallbackSrc)
          video.load()
        }
        return
      }
      
      // æ‰€æœ‰å›é€€ç­–ç•¥éƒ½å¤±è´¥äº†ï¼Œæ˜¾ç¤ºé”™è¯¯
      safeSetState(setIsLoading, false, 'isLoading')
      safeSetState(setHasError, true, 'hasError')
      onError?.()
    }

    const handleCanPlay = () => {
      safeSetState(setIsLoading, false, 'isLoading')
      safeSetState(setIsBuffering, false, 'isBuffering') // è§†é¢‘å¯ä»¥æ’­æ”¾æ—¶å–æ¶ˆç¼“å†²çŠ¶æ€
      safeSetState(setCanPlaySmooth, true, 'canPlaySmooth') // æ ‡è®°å¯ä»¥æµç•…æ’­æ”¾
      // å¯æ’­æ”¾æ—¶ï¼Œæå‡åˆ°è‡³å°‘60%
      safeSetState(setProgressMonotonic, 60, 'progressMonotonic')
      safeSetState(setUiTarget, 65, 'uiTarget')
      // å°è¯•æ‚¬åœè‡ªåŠ¨æ’­æ”¾ï¼ˆå¿…è¦æ—¶é‡è¯•ï¼‰
      attemptHoverAutoplay(true)
      
      onCanPlay?.()
    }

    // ğŸš€ ç¼“å†²è¿›åº¦ç›‘å¬å™¨
    const handleProgress = () => {
      // å½“è¿˜æ²¡æœ‰bufferä¿¡æ¯æ—¶ï¼Œé‡‡ç”¨å°±ç»ªæ€è¿‘ä¼¼è¿›åº¦ï¼Œé¿å…å¡åœ¨0%
      if (!video.buffered.length) {
        // æ ¹æ®readyStateç»™è¿‘ä¼¼ç™¾åˆ†æ¯”
        const approx = video.readyState >= 4 ? 90 : video.readyState >= 3 ? 60 : video.readyState >= 2 ? 25 : 10
        safeSetState(setProgressMonotonic, approx, 'progressMonotonic')
        safeSetState(setUiTarget, Math.max(uiTargetRef.current, approx), 'uiTarget')
        return
      }
      
      const duration = video.duration
      if (!duration || !isFinite(duration) || duration <= 0) {
        // æœªçŸ¥æ—¶é•¿æ—¶é‡‡ç”¨è¿‘ä¼¼ç™¾åˆ†æ¯”
        const approx = video.readyState >= 4 ? 90 : video.readyState >= 3 ? 60 : video.readyState >= 2 ? 25 : 10
        safeSetState(setProgressMonotonic, approx, 'progressMonotonic')
        safeSetState(setUiTarget, Math.max(uiTargetRef.current, approx), 'uiTarget')
        return
      }
      
      // è®¡ç®—å·²ç¼“å†²çš„æœ€å¤§æ—¶é—´ç‚¹
      let bufferedEnd = 0
      for (let i = 0; i < video.buffered.length; i++) {
        bufferedEnd = Math.max(bufferedEnd, video.buffered.end(i))
      }
      
      // è®¡ç®—ç¼“å†²è¿›åº¦ç™¾åˆ†æ¯”
      const progress = (bufferedEnd / duration) * 100
      safeSetState(setProgressMonotonic, progress, 'progressMonotonic')
      safeSetState(setUiTarget, Math.max(uiTargetRef.current, progress), 'uiTarget')
      
      // åˆ¤æ–­æ˜¯å¦æœ‰è¶³å¤Ÿç¼“å†²å¯ä»¥å¼€å§‹æ’­æ”¾ï¼ˆè‡³å°‘3ç§’æˆ–10%ï¼‰
      const bufferedSeconds = bufferedEnd - video.currentTime
      const hasEnoughBuffer = bufferedSeconds >= 3 || progress >= 10
      safeSetState(setCanPlaySmooth, hasEnoughBuffer, 'canPlaySmooth')
      
      // ğŸš€ ç®€åŒ–ç¼“å†²é€»è¾‘ï¼šå½“ç¼“å†²è¶³å¤Ÿæ—¶å°è¯•è‡ªåŠ¨å¼€å§‹æ’­æ”¾
      if (hasEnoughBuffer && isBuffering && autoPlayOnHover && isHovered && !userPaused) {
        
        // ğŸ”§ å»¶è¿Ÿéšè—ç¼“å†²çŠ¶æ€ï¼Œç¡®ä¿ç”¨æˆ·èƒ½çœ‹åˆ°100%
        if (progress >= 99) {
          setTimeout(() => {
            // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥ç»„ä»¶æ˜¯å¦ä»ç„¶æŒ‚è½½
            if (!isMountedRef.current) return
            safeSetState(setIsBuffering, false, 'isBuffering')
          }, 300) // å»¶è¿Ÿ300mséšè—
        } else {
          // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥ç»„ä»¶æ˜¯å¦ä»ç„¶æŒ‚è½½
          if (!isMountedRef.current) return
          safeSetState(setIsBuffering, false, 'isBuffering')
        }
        // å°è¯•æ‚¬åœè‡ªåŠ¨æ’­æ”¾ï¼ˆå¿…è¦æ—¶é‡è¯•ï¼‰
        attemptHoverAutoplay(true)
      } else if (hasEnoughBuffer && isBuffering && userPaused && isHovered) {
        // å³ä½¿ç”¨æˆ·æš‚åœäº†ï¼Œä¹Ÿè¦éšè—ç¼“å†²çŠ¶æ€
        safeSetState(setIsBuffering, false, 'isBuffering')
      }
      
    }

    // ğŸš€ ç¼“å†²çŠ¶æ€ç›‘å¬å™¨
    const handleWaiting = () => {
      const shouldBuffer = (autoPlayOnHover && isHovered) || hasInteracted
      safeSetState(setIsBuffering, shouldBuffer, 'isBuffering')
      // ç­‰å¾…ç¼“å†²æ—¶ï¼Œæ ¹æ®readyStateè®¾ç½®ä¸€ä¸ªä¿åº•è¿›åº¦ï¼Œé¿å…åœåœ¨0%
      const approx = video.readyState >= 3 ? 60 : video.readyState >= 2 ? 25 : 10
      safeSetState(setProgressMonotonic, approx, 'progressMonotonic')
      safeSetState(setUiTarget, Math.max(uiTargetRef.current, approx), 'uiTarget')
    }

    const handleCanPlayThrough = () => {
      safeSetState(setIsBuffering, false, 'isBuffering')
      safeSetState(setCanPlaySmooth, true, 'canPlaySmooth')
      // è¶³ä»¥æµç•…æ’­æ”¾ï¼Œè¿›åº¦æå‡åˆ°90%
      safeSetState(setProgressMonotonic, 90, 'progressMonotonic')
      safeSetState(setUiTarget, 90, 'uiTarget')
      stopHeartbeat()
      // å†æ¬¡å°è¯•æ‚¬æµ®è‡ªåŠ¨æ’­æ”¾ï¼ˆé˜²æ­¢é”™è¿‡ canplayï¼‰
      attemptHoverAutoplay(true)
    }

    video.addEventListener('play', handlePlay)
    video.addEventListener('pause', handlePause)
    video.addEventListener('timeupdate', handleTimeUpdate)
    video.addEventListener('loadedmetadata', handleLoadedMetadata)
    video.addEventListener('ended', handleEnded)
    video.addEventListener('loadstart', handleLoadStart)
    video.addEventListener('loadeddata', handleLoadedData)
    video.addEventListener('error', handleError)
    video.addEventListener('canplay', handleCanPlay)
    video.addEventListener('progress', handleProgress)
    video.addEventListener('waiting', handleWaiting)
    video.addEventListener('canplaythrough', handleCanPlayThrough)

    return () => {
      video.removeEventListener('play', handlePlay)
      video.removeEventListener('pause', handlePause)
      video.removeEventListener('timeupdate', handleTimeUpdate)
      video.removeEventListener('loadedmetadata', handleLoadedMetadata)
      video.removeEventListener('ended', handleEnded)
      video.removeEventListener('loadstart', handleLoadStart)
      video.removeEventListener('loadeddata', handleLoadedData)
      video.removeEventListener('error', handleError)
      video.removeEventListener('canplay', handleCanPlay)
      video.removeEventListener('progress', handleProgress)
      video.removeEventListener('waiting', handleWaiting)
      video.removeEventListener('canplaythrough', handleCanPlayThrough)
    }
  }, [onPlay, onPause, onTimeUpdate, onLoadStart, onCanPlay, onError, currentVideoSrc, hasTriedFallback, fallbackSrc, playerId, notifyPause, isBuffering, autoPlayOnHover, isHovered, isCurrentlyPlaying, requestPlay, userPaused, attemptHoverAutoplay])

  // ğŸš€ æ·»åŠ åŠ è½½è¶…æ—¶æœºåˆ¶ï¼Œé˜²æ­¢ isLoading çŠ¶æ€æ°¸ä¹…å¡ä½
  useEffect(() => {
    if (!isLoading || disablePreload) return

    const timeout = setTimeout(() => {
      // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥ç»„ä»¶æ˜¯å¦ä»ç„¶æŒ‚è½½
      if (!isMountedRef.current) return
      
      const video = videoRef.current
      if (video && isLoading) {
        safeSetState(setIsLoading, false, 'isLoading')
      }
    }, 3000) // 3ç§’è¶…æ—¶

    return () => clearTimeout(timeout)
  }, [isLoading, playerId, disablePreload])

  // ğŸš€ æ·»åŠ çŠ¶æ€ä¸€è‡´æ€§æ£€æŸ¥ï¼Œæ£€æµ‹å¹¶ä¿®æ­£çŠ¶æ€ä¸ä¸€è‡´çš„æƒ…å†µ
  useEffect(() => {
    const video = videoRef.current
    if (!video || disablePreload) return

    // å®šæœŸæ£€æŸ¥çŠ¶æ€ä¸€è‡´æ€§
    const checkInterval = setInterval(() => {
      // æ£€æµ‹1ï¼šè§†é¢‘å·²å‡†å¤‡å¥½ä½†ä»æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      if (isLoading && video.readyState >= 1) {
        safeSetState(setIsLoading, false, 'isLoading')
        safeSetState(setHasMetadata, true, 'hasMetadata')
      }

      // æ£€æµ‹2ï¼šè§†é¢‘æœ‰durationä½†hasMetadataä¸ºfalse
      if (!hasMetadata && video.duration && video.duration > 0) {
        safeSetState(setHasMetadata, true, 'hasMetadata')
        safeSetState(setDuration, video.duration, 'duration')
      }
    }, 1000) // æ¯ç§’æ£€æŸ¥ä¸€æ¬¡

    return () => clearInterval(checkInterval)
  }, [playerId, disablePreload]) // ğŸ”§ ä¿®å¤ï¼šç§»é™¤çŠ¶æ€ä¾èµ–ï¼Œé¿å…å¾ªç¯

  // ğŸš€ ç»„ä»¶æŒ‚è½½åç«‹å³è¿›è¡Œä¸€æ¬¡çŠ¶æ€æ£€æŸ¥
  useEffect(() => {
    const video = videoRef.current
    if (!video || disablePreload) return

    // çŸ­æš‚å»¶è¿Ÿåæ£€æŸ¥åˆå§‹çŠ¶æ€ï¼Œç¡®ä¿ video å…ƒç´ å·²ç»å¼€å§‹åŠ è½½
    const initialCheck = setTimeout(() => {
      // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥ç»„ä»¶æ˜¯å¦ä»ç„¶æŒ‚è½½
      if (!isMountedRef.current) return
      
      // å¦‚æœè§†é¢‘å·²ç»æœ‰posteræˆ–èƒŒæ™¯å›¾ï¼Œä½†ä»åœ¨loadingçŠ¶æ€ï¼Œå¯èƒ½éœ€è¦é‡ç½®
      if (isLoading && (optimalPoster || video.poster)) {
        // æ£€æŸ¥è§†é¢‘æ˜¯å¦å®é™…éœ€è¦åŠ è½½çŠ¶æ€
        if (video.readyState === 0 && video.networkState === video.NETWORK_NO_SOURCE) {
          // è§†é¢‘è¿˜æ²¡å¼€å§‹åŠ è½½ï¼Œè¿™æ˜¯æ­£å¸¸çš„
        } else if (video.readyState >= 1) {
          // è§†é¢‘å·²ç»æœ‰å…ƒæ•°æ®äº†ï¼Œé‡ç½®åŠ è½½çŠ¶æ€
          // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥ç»„ä»¶æ˜¯å¦ä»ç„¶æŒ‚è½½ï¼ˆåŒé‡æ£€æŸ¥ï¼‰
          if (!isMountedRef.current) return
          safeSetState(setIsLoading, false, 'isLoading')
        }
      }
    }, 100)

    return () => clearTimeout(initialCheck)
  }, [disablePreload]) // åªåœ¨æŒ‚è½½æ—¶æ‰§è¡Œä¸€æ¬¡

  // ğŸ¯ ç®€åŒ–æ‚¬åœæ’­æ”¾æ§åˆ¶ - æ ¹æ®ç”¨æˆ·è¦æ±‚å®Œå…¨é‡å†™
  const handleMouseEnter = useCallback(() => {
    // ç§»åŠ¨ç«¯æˆ–ä¸æ”¯æŒæ‚¬åœçš„è®¾å¤‡ä¸è§¦å‘é¼ æ ‡æ‚¬åœé€»è¾‘
    if (isMobile || !canHover) {
      return
    }

    safeSetState(setIsHovered, true, 'isHovered')
    safeSetState(setShowControls, true, 'showControls')
    
    const video = videoRef.current
    if (!autoPlayOnHover || !video) return
    
    
    // ğŸ”§ å¦‚æœç”¨æˆ·ä¸»åŠ¨æš‚åœäº†ï¼Œä¸è‡ªåŠ¨æ’­æ”¾
    if (userPaused) {
      return
    }
    
    // ğŸš€ ç®€åŒ–é€»è¾‘ï¼šæ£€æŸ¥è§†é¢‘æ˜¯å¦å¯ä»¥æ’­æ”¾
    if (video.readyState >= 3) {
      // ğŸ”§ ä¿®å¤ï¼šå®‰å…¨è°ƒç”¨requestPlayï¼Œé˜²æ­¢contextè¢«é”€æ¯æ—¶è°ƒç”¨å¤±è´¥
      const success = typeof requestPlay === 'function' ? requestPlay(playerId) : false
      if (success) {
        video.play().catch(() => {})
      }
    } else {
      // è§†é¢‘è¿˜åœ¨åŠ è½½ - æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
      safeSetState(setIsBuffering, true, 'isBuffering')
      
      // å¯ç”¨é¢„åŠ è½½åŠ é€Ÿç¼“å†²
      if (currentPreload !== "auto") {
        safeSetState(setCurrentPreload, "auto", 'currentPreload')
        video.preload = "auto"
        // ä¼˜å…ˆç½‘ç»œï¼šé¢„è¿æ¥ + rel=preload æå‡å½“å‰è§†é¢‘ä¼˜å…ˆçº§
        try {
          const prioritizedUrl = getOptimizedVideoUrl(currentVideoSrc)
          ensurePreconnect(prioritizedUrl)
          ensurePreloadVideo(prioritizedUrl)
        } catch {}
        video.load()
      }
      // æ‚¬åœè½»åº¦æŠ¢å ï¼šçŸ­å»¶è¿Ÿåè‹¥ä»éœ€ç¼“å†²ä¸”äº’æ–¥é”è¢«å ç”¨ï¼Œåˆ™é‡Šæ”¾é”ä»¥ä¼˜å…ˆå½“å‰äº¤äº’è§†é¢‘
      if (hoverPreemptTimerRef.current) {
        clearTimeout(hoverPreemptTimerRef.current)
      }
      hoverPreemptTimerRef.current = window.setTimeout(() => {
        if (isHovered && autoPlayOnHover && isBuffering && !userPaused && typeof isPlayMutexLocked === 'function' && isPlayMutexLocked()) {
          try { 
            // ğŸ”§ ä¿®å¤ï¼šå®‰å…¨è°ƒç”¨immediateStopAllï¼Œé˜²æ­¢contextè¢«é”€æ¯æ—¶è°ƒç”¨å¤±è´¥
            if (typeof immediateStopAll === 'function') {
              immediateStopAll()
            }
          } catch {}
          // é”é‡Šæ”¾åå°è¯•ä¸€æ¬¡è‡ªåŠ¨æ’­æ”¾
          attemptHoverAutoplay(true)
        }
      }, 250)
    }
  }, [autoPlayOnHover, currentPreload, isMobile, playerId, requestPlay, userPaused, isHovered, isBuffering, isPlayMutexLocked, currentVideoSrc, immediateStopAll, attemptHoverAutoplay])

  const handleMouseLeave = useCallback(() => {
    if (isMobile || !canHover) {
      return
    }

    // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥ç»„ä»¶æ˜¯å¦ä»ç„¶æŒ‚è½½
    if (!isMountedRef.current) return
    
    safeSetState(setIsHovered, false, 'isHovered')
    safeSetState(setShowControls, false, 'showControls')
    
    const video = videoRef.current
    if (!autoPlayOnHover || !video) return
    
    
    // ğŸ›‘ ä¿®å¤æ‚¬åœç¦»å¼€é€»è¾‘ï¼šåŒºåˆ†ç”¨æˆ·ä¸»åŠ¨æš‚åœå’Œæ‚¬åœç¦»å¼€
    if (!video.paused) {
      video.pause()
      // åªæœ‰åœ¨æ‚¬åœè‡ªåŠ¨æ’­æ”¾æ¨¡å¼ä¸‹æ‰é‡ç½®ä½ç½®
      // å¦‚æœç”¨æˆ·ä¸»åŠ¨æš‚åœè¿‡ï¼Œä¿æŒå½“å‰ä½ç½®
      if (!userPaused) {
        video.currentTime = 0  // é‡ç½®åˆ°å¼€å§‹ä½ç½®
      }
      // ğŸ”§ ä¿®å¤ï¼šå†æ¬¡æ£€æŸ¥ç»„ä»¶æŒ‚è½½çŠ¶æ€
      if (isMountedRef.current) {
        safeSetState(setIsPlaying, false, 'isPlaying')
      }
      // ğŸ”§ ä¿®å¤ï¼šå®‰å…¨è°ƒç”¨notifyPauseï¼Œé˜²æ­¢contextè¢«é”€æ¯æ—¶è°ƒç”¨å¤±è´¥
      if (typeof notifyPause === 'function') {
        notifyPause(playerId)
      }
    }
    
    // éšè—æ‰€æœ‰UIç»„ä»¶
    if (isMountedRef.current) {
      safeSetState(setIsBuffering, false, 'isBuffering')
    }
    
    // ğŸ”§ é‡ç½®ç”¨æˆ·æš‚åœçŠ¶æ€ï¼Œä¸‹æ¬¡é¼ æ ‡è¿›å…¥æ—¶å¯ä»¥é‡æ–°è‡ªåŠ¨æ’­æ”¾
    safeSetState(setUserPaused, false, 'userPaused')
    // æ¸…ç†æ‚¬åœè½»åº¦æŠ¢å è®¡æ—¶å™¨
    if (hoverPreemptTimerRef.current) {
      clearTimeout(hoverPreemptTimerRef.current)
      hoverPreemptTimerRef.current = null
    }
    // æ¸…ç†æ‚¬åœè‡ªåŠ¨æ’­æ”¾é‡è¯•
    if (hoverRetryTimerRef.current) {
      clearTimeout(hoverRetryTimerRef.current)
      hoverRetryTimerRef.current = null
    }
    
  }, [autoPlayOnHover, isMobile, playerId, notifyPause])

  // ğŸ¯ ä¿®å¤ç‚¹å‡»æ’­æ”¾/æš‚åœ - ç¡®ä¿æ’­æ”¾çŠ¶æ€ä¸UIåŒæ­¥
  const handlePlayPause = useCallback(async (e?: React.MouseEvent) => {
    e?.stopPropagation()
    
    const video = videoRef.current
    if (!video) return

    // ğŸ”§ ç§»åŠ¨ç«¯é˜²æŠ–ä¼˜åŒ–ï¼šå¢åŠ é˜²æŠ–æ—¶é—´åˆ°250msï¼Œç¡®ä¿è§¦æ‘¸äº‹ä»¶ç¨³å®š
    if (isMobile) {
      if (mobilePlayDebounceRef.current) {
        clearTimeout(mobilePlayDebounceRef.current)
      }
      // é˜²æŠ–æ—¶é—´å¢åŠ åˆ°250msï¼Œé¿å…ç§»åŠ¨ç«¯å¿«é€Ÿè§¦æ‘¸å¯¼è‡´çš„çŠ¶æ€æ··ä¹±
      const now = Date.now()
      const lastClickTime = (video as any).__lastClickTime || 0
      if (now - lastClickTime < 250) {
        console.log('[SimpleVideoPlayer] ç§»åŠ¨ç«¯é˜²æŠ–ï¼šå¿½ç•¥å¿«é€Ÿç‚¹å‡»')
        return
      }
      (video as any).__lastClickTime = now
      
      // ğŸš€ æ·»åŠ è§¦æ‘¸çŠ¶æ€è·Ÿè¸ªï¼Œé¿å…åŒæ—¶å¤„ç†touchå’Œclickäº‹ä»¶
      if ((video as any).__touchInProgress) {
        console.log('[SimpleVideoPlayer] è§¦æ‘¸äº‹ä»¶è¿›è¡Œä¸­ï¼Œè·³è¿‡clickå¤„ç†')
        return
      }
    }

    // ç§»åŠ¨ç«¯ç‚¹å‡»æ—¶ç«‹å³æ˜¾ç¤ºæ§åˆ¶å±‚ï¼Œé¿å…ç”¨æˆ·æ²¡æœ‰åé¦ˆ
    safeSetState(setShowControls, true, 'showControls')
    safeSetState(setHasInteracted, true, 'hasInteracted')

    // ğŸ”§ ç§»åŠ¨ç«¯ä¿®å¤ï¼šä½¿ç”¨videoå…ƒç´ çš„å®é™…æ’­æ”¾çŠ¶æ€è€Œä¸æ˜¯å…¨å±€çŠ¶æ€ï¼Œé¿å…çŠ¶æ€åŒæ­¥å»¶è¿Ÿ
    const isActuallyPlaying = !video.paused && !video.ended
    const isCurrentlyPlayingNow = isCurrentlyPlaying(playerId)

    if (isActuallyPlaying || isCurrentlyPlayingNow) {
      // ğŸ”§ ç§»åŠ¨ç«¯è°ƒè¯•æ—¥å¿—
      if (isMobile) {
        console.log(`[SimpleVideoPlayer-Mobile] æš‚åœæ’­æ”¾: ${playerId}, å½“å‰æ—¶é—´: ${video.currentTime.toFixed(2)}s`)
      }
      
      // å½“å‰æ’­æ”¾ä¸­ï¼Œç›´æ¥æš‚åœ
      video.pause()
      // ğŸ”§ ä¿®å¤ç‚¹å‡»æš‚åœé—®é¢˜ï¼šç”¨æˆ·ä¸»åŠ¨ç‚¹å‡»æš‚åœæ—¶ä¸é‡ç½®ä½ç½®ï¼Œä¿æŒå½“å‰æ’­æ”¾è¿›åº¦
      // åªæœ‰åœ¨æ‚¬åœç¦»å¼€æ—¶æ‰é‡ç½®ä½ç½®ï¼ˆåœ¨ handleMouseLeave ä¸­å¤„ç†ï¼‰
      // ğŸ”§ ä¿®å¤ï¼šå®‰å…¨è°ƒç”¨notifyPauseï¼Œé˜²æ­¢contextè¢«é”€æ¯æ—¶è°ƒç”¨å¤±è´¥
      if (typeof notifyPause === 'function') {
        notifyPause(playerId)
      }
      
      // ğŸ”§ å…³é”®ä¿®å¤ï¼šè®¾ç½®ç”¨æˆ·æš‚åœæ ‡è®°ï¼Œé˜²æ­¢æ‚¬åœæ—¶è‡ªåŠ¨æ’­æ”¾
      safeSetState(setUserPaused, true, 'userPaused')
    } else {
      // ğŸ”§ ä¿®å¤ï¼šç­‰å¾…æ’­æ”¾è¯·æ±‚å®Œæˆåå†æ›´æ–°UIçŠ¶æ€
      try {
        // å…ˆæ£€æŸ¥æ˜¯å¦å¯ä»¥æ’­æ”¾
        if (!video.src || video.networkState === video.NETWORK_NO_SOURCE) {
          return
        }

        // ç§»åŠ¨ç«¯ç‚¹å‡»ï¼šæ— æ¡ä»¶å¼€å¯å®Œæ•´é¢„åŠ è½½ï¼Œå¹¶åœ¨æœªå°±ç»ªæ—¶ä¸»åŠ¨è§¦å‘åŠ è½½
        if (isMobile) {
          console.log(`[SimpleVideoPlayer-Mobile] å¼€å§‹æ’­æ”¾å‡†å¤‡: ${playerId}`)
          console.log(`[SimpleVideoPlayer-Mobile] è§†é¢‘å°±ç»ªçŠ¶æ€: ${video.readyState}, ç½‘ç»œçŠ¶æ€: ${video.networkState}`)
          console.log(`[SimpleVideoPlayer-Mobile] ç¼“å†²è¿›åº¦: ${bufferProgress}%, UIè¿›åº¦: ${uiProgress}%`)
          
          if (currentPreload !== "auto") safeSetState(setCurrentPreload, "auto", 'currentPreload')
          video.preload = "auto"
          if (video.readyState < 3) {
            safeSetState(setIsBuffering, true, 'isBuffering')
            console.log(`[SimpleVideoPlayer-Mobile] è§¦å‘ç¼“å†²çŠ¶æ€ï¼ŒreadyState: ${video.readyState}`)
            // æå‡ç½‘ç»œä¼˜å…ˆçº§
            try {
              const prioritizedUrl = getOptimizedVideoUrl(currentVideoSrc)
              ensurePreconnect(prioritizedUrl)
              ensurePreloadVideo(prioritizedUrl)
            } catch {}
            try {
              video.load()
            } catch {}
          }
        }

        // ğŸ”§ ç”¨æˆ·ä¸»åŠ¨æ’­æ”¾æ—¶ï¼Œæ¸…é™¤æš‚åœæ ‡è®°
        safeSetState(setUserPaused, false, 'userPaused')

        // ğŸ”§ å…³é”®ä¿®å¤ï¼šå…ˆè¯·æ±‚æ’­æ”¾æƒé™ï¼Œè®©å…¨å±€ç®¡ç†å™¨å¤„ç†å…¶ä»–è§†é¢‘çš„åœæ­¢
        // ç§»é™¤ immediateStopAll() è°ƒç”¨ï¼Œé¿å…åœæ­¢å½“å‰æ­£åœ¨æ’­æ”¾çš„è§†é¢‘
        
        // æå‡ç½‘ç»œä¼˜å…ˆçº§ï¼šé¢„è¿æ¥ + rel=preload
        try {
          const prioritizedUrl = getOptimizedVideoUrl(currentVideoSrc)
          ensurePreconnect(prioritizedUrl)
          ensurePreloadVideo(prioritizedUrl)
        } catch {}

        // ğŸ”§ ä¿®å¤ï¼šå®‰å…¨è°ƒç”¨requestPlayï¼Œé˜²æ­¢contextè¢«é”€æ¯æ—¶è°ƒç”¨å¤±è´¥
        const success = typeof requestPlay === 'function' ? requestPlay(playerId) : false
        // ğŸ”§ ç§»åŠ¨ç«¯ä¿®å¤ï¼šå¦‚æœå…¨å±€ç®¡ç†å™¨æ‹’ç»æ’­æ”¾è¯·æ±‚ï¼ŒçŸ­å»¶è¿Ÿåé‡è¯•
        if (!success) {
          // çŸ­å»¶è¿Ÿåé‡è¯•ï¼Œè®©å…¨å±€ç®¡ç†å™¨æœ‰æ—¶é—´å¤„ç†çŠ¶æ€æ›´æ–°
          setTimeout(() => {
            // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥ç»„ä»¶æ˜¯å¦ä»ç„¶æŒ‚è½½
            if (!isMountedRef.current) return
            
            // ğŸ”§ ä¿®å¤ï¼šå®‰å…¨è°ƒç”¨requestPlayï¼Œé˜²æ­¢contextè¢«é”€æ¯æ—¶è°ƒç”¨å¤±è´¥
            const retrySuccess = typeof requestPlay === 'function' ? requestPlay(playerId) : false
            if (retrySuccess) {
              video.play().catch(() => {})
            }
          }, 50)
        }

        // ğŸ“± æ¡Œé¢/ç§»åŠ¨ç»Ÿä¸€ï¼šç‚¹å‡»åç¡®ä¿è¿›å…¥é¢„åŠ è½½å¹¶åœ¨å½“å‰æ‰‹åŠ¿å†…è°ƒç”¨ play
        // é¢„åŠ è½½ï¼šä¸è¶³å¯æ’­æ•°æ®æ—¶ï¼Œåˆ‡æ¢ä¸º auto å¹¶è§¦å‘ load
        if (currentPreload !== "auto") safeSetState(setCurrentPreload, "auto", 'currentPreload')
        video.preload = "auto"
        if (video.readyState < 2) {
          safeSetState(setIsBuffering, true, 'isBuffering')
          try {
            const prioritizedUrl = getOptimizedVideoUrl(currentVideoSrc)
            ensurePreconnect(prioritizedUrl)
            ensurePreloadVideo(prioritizedUrl)
          } catch {}
          try { video.load() } catch {}
        }

        // ğŸ”§ å…³é”®ä¿®å¤ï¼šç§»åŠ¨ç«¯æ’­æ”¾å‰é‡ç½®è§†é¢‘åˆ°å¼€å§‹ä½ç½®
        // è®©å…¨å±€ç®¡ç†å™¨å®Œå…¨æ§åˆ¶æ’­æ”¾ï¼Œé¿å…çŠ¶æ€ä¸åŒæ­¥
        if (video.ended) {
          video.currentTime = 0
        }
        
        // ğŸ”§ ç§»åŠ¨ç«¯ä¿®å¤ï¼šæ’­æ”¾çŠ¶æ€å®Œå…¨ç”±å…¨å±€ç®¡ç†å™¨æ§åˆ¶
        // ç§»é™¤æ‰‹åŠ¨æ’­æ”¾è°ƒç”¨ï¼Œé¿å…ä¸å…¨å±€ç®¡ç†å™¨çš„æ’­æ”¾é€»è¾‘å†²çª
      } catch (error) {
        // ğŸ”§ ä¿®å¤ï¼šå®‰å…¨è°ƒç”¨notifyPauseï¼Œé˜²æ­¢contextè¢«é”€æ¯æ—¶è°ƒç”¨å¤±è´¥
        if (typeof notifyPause === 'function') {
          notifyPause(playerId)
        }
      }
    }
  }, [
    playerId,
    currentPreload,
    isMobile,
    isCurrentlyPlaying,
    notifyPause,
    requestPlay
  ])

  // ç‚¹å‡»è§†é¢‘åŒºåŸŸæ’­æ”¾/æš‚åœ
  const handleVideoClick = (e: React.MouseEvent) => {
    e.preventDefault()
    onClick?.()
    handlePlayPause(e)
  }

  // é™éŸ³åˆ‡æ¢
  const handleMuteToggle = (e: React.MouseEvent) => {
    e.stopPropagation()
    
    const video = videoRef.current
    if (!video) return
    
    const newMuted = !isMuted
    video.muted = newMuted
    safeSetState(setIsMuted, newMuted, 'isMuted')
  }

  // è¿›åº¦æ¡ç‚¹å‡»è·³è½¬
  const handleProgressClick = (e: React.MouseEvent) => {
    e.stopPropagation()
    
    const video = videoRef.current
    if (!video || !duration) return

    const rect = e.currentTarget.getBoundingClientRect()
    const clickX = e.clientX - rect.left
    const clickRatio = clickX / rect.width
    const newTime = clickRatio * duration
    
    video.currentTime = newTime
    safeSetState(setCurrentTime, newTime, 'currentTime')
  }

  // å…¨å±åˆ‡æ¢åŠŸèƒ½ - iOSå…¼å®¹ç‰ˆæœ¬
  const toggleFullscreen = async () => {
    const video = videoRef.current
    const container = containerRef.current
    
    if (!video) {
      return
    }

    try {
      const success = await toggleFullscreenHelper(video, container || undefined)
      if (!success) {
        // iOSè®¾å¤‡çš„å›é€€æ–¹æ¡ˆ
        if (deviceCapabilities.isiOS) {
          // iOSç”¨æˆ·å¯ä»¥ä½¿ç”¨åŸç”Ÿè§†é¢‘æ§åˆ¶æ¡è¿›å…¥å…¨å±
        }
      }
    } catch (error) {
    }
  }

  // iOSå…¨å±äº‹ä»¶ç›‘å¬
  useEffect(() => {
    const video = videoRef.current
    if (!video || !deviceCapabilities.isiOS) return

    const cleanup = bindVideoFullscreenEventsiOS(
      video,
      () => {
        safeSetState(setIsFullscreen, true, 'isFullscreen')
      },
      () => {
        safeSetState(setIsFullscreen, false, 'isFullscreen')
      }
    )

    return cleanup
  }, [deviceCapabilities.isiOS])

  // æ ‡å‡†å…¨å±äº‹ä»¶ç›‘å¬ï¼ˆéiOSï¼‰
  useEffect(() => {
    if (deviceCapabilities.isiOS) return

    const handleFullscreenChange = () => {
      const state = getFullscreenState()
      safeSetState(setIsFullscreen, state.isFullscreen, 'isFullscreen')
    }

    document.addEventListener('fullscreenchange', handleFullscreenChange)
    return () => {
      document.removeEventListener('fullscreenchange', handleFullscreenChange)
    }
  }, [deviceCapabilities.isiOS])

  // ğŸ”§ å¼ºåŒ–ç»„ä»¶å¸è½½æ¸…ç†ï¼šç¡®ä¿æ‰€æœ‰èµ„æºè¢«å½»åº•æ¸…ç†
  useEffect(() => {
    return () => {
      console.log(`[SimpleVideoPlayer] æ¸…ç†æ’­æ”¾å™¨èµ„æº: ${playerId}`)
      
      // ğŸ”§ ä¿®å¤ï¼šæ ‡è®°ç»„ä»¶å·²å¸è½½ï¼Œé˜²æ­¢åç»­state setterè°ƒç”¨
      isMountedRef.current = false
      
      // æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨
      if (hoverPreemptTimerRef.current) {
        clearTimeout(hoverPreemptTimerRef.current)
        hoverPreemptTimerRef.current = null
      }
      if (hoverRetryTimerRef.current) {
        clearTimeout(hoverRetryTimerRef.current)
        hoverRetryTimerRef.current = null
      }
      if (progressAnimRef.current) {
        clearInterval(progressAnimRef.current)
        progressAnimRef.current = null
      }
      if (heartbeatRef.current) {
        clearInterval(heartbeatRef.current)
        heartbeatRef.current = null
      }
      if (mobilePlayDebounceRef.current) {
        clearTimeout(mobilePlayDebounceRef.current)
        mobilePlayDebounceRef.current = null
      }
      
      // ğŸš€ ç§»åŠ¨ç«¯ä¸“ç”¨ï¼šæ¸…ç†è§¦æ‘¸çŠ¶æ€å’Œè§†é¢‘å…ƒç´ çŠ¶æ€
      const video = videoRef.current
      if (video && isMobile) {
        (video as any).__touchInProgress = false
        (video as any).__lastClickTime = 0
        console.log(`[SimpleVideoPlayer] æ¸…ç†ç§»åŠ¨ç«¯è§†é¢‘çŠ¶æ€: ${playerId}`)
      }
      
      // ğŸ”§ å¼ºåˆ¶é‡Šæ”¾å…¨å±€æ’­æ”¾é”ï¼Œé˜²æ­¢å¡ä½çŠ¶æ€å½±å“å…¶ä»–è§†é¢‘
      try {
        if (typeof isCurrentlyPlaying === 'function' && isCurrentlyPlaying(playerId)) {
          // ğŸ”§ ä¿®å¤ï¼šå®‰å…¨è°ƒç”¨notifyPauseï¼Œé˜²æ­¢contextè¢«é”€æ¯æ—¶è°ƒç”¨å¤±è´¥
          if (typeof notifyPause === 'function') {
            notifyPause(playerId)
            console.log(`[SimpleVideoPlayer] å¼ºåˆ¶é‡Šæ”¾æ’­æ”¾çŠ¶æ€: ${playerId}`)
          }
        }
      } catch (error) {
        console.warn(`[SimpleVideoPlayer] æ¸…ç†æ’­æ”¾çŠ¶æ€å¤±è´¥: ${playerId}`, error)
      }
      
      // ğŸ”§ ä¿®å¤ï¼šç»„ä»¶å¸è½½æ—¶ä¸è°ƒç”¨state settersï¼Œé¿å…"false is not a function"é”™è¯¯
      // åªæ¸…ç†refå€¼ï¼Œä¸è®¾ç½®state
      uiTargetRef.current = 0
      bufferProgressRef.current = 0
      
      console.log(`[SimpleVideoPlayer] èµ„æºæ¸…ç†å®Œæˆ: ${playerId}`)
    }
  }, [playerId, isCurrentlyPlaying, notifyPause, isMobile])

  // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
  const formatTime = (seconds: number) => {
    if (!isFinite(seconds)) return '0:00'
    const mins = Math.floor(seconds / 60)
    const secs = Math.floor(seconds % 60)
    return `${mins}:${secs.toString().padStart(2, '0')}`
  }


  return (
    <div 
      ref={containerRef}
      className={cn("relative group bg-muted overflow-hidden", className)}
      onMouseEnter={handleMouseEnter}
      onMouseLeave={handleMouseLeave}
    >

      {/* åŸç”Ÿè§†é¢‘å…ƒç´  */}
      <video
        ref={videoRef}
        src={getOptimizedVideoUrl(currentVideoSrc)}
        poster={optimalPoster}
        className={cn(
          `w-full h-full cursor-pointer`,
          objectFit === 'cover' ? 'object-cover' : 'object-contain',
          // ğŸš€ ä¿®å¤ï¼šç§»é™¤ opacity-0ï¼Œæ”¹ç”¨æ›´ç²¾ç¡®çš„çŠ¶æ€æ§åˆ¶
          // è®© CSS èƒŒæ™¯å›¾å§‹ç»ˆå¯è§ï¼Œåªåœ¨çœŸæ­£é”™è¯¯æ—¶æ‰å®Œå…¨éšè—
          hasError && !optimalPoster ? 'hidden' : ''
        )}
        onClick={handleVideoClick}
        muted={isMuted}
        playsInline // ç§»åŠ¨ç«¯å†…è”æ’­æ”¾
        preload={disablePreload ? "none" : currentPreload} // ğŸš€ åŠ¨æ€é¢„åŠ è½½ï¼šæ‚¬åœæ—¶è‡ªåŠ¨ç¼“å†²
        crossOrigin="anonymous"
        aria-label={alt || videoTitle || 'è§†é¢‘æ’­æ”¾å™¨'}
        style={{
          // æ™ºèƒ½å›é€€ï¼šä½¿ç”¨ CSS èƒŒæ™¯å›¾ç¡®ä¿ç¼©ç•¥å›¾æ˜¾ç¤º
          backgroundImage: optimalPoster ? `url(${optimalPoster})` : undefined,
          backgroundSize: 'cover',
          backgroundPosition: 'center',
          backgroundRepeat: 'no-repeat'
        }}
      />

      {/* ğŸš€ ä¿®å¤UIæ¸²æŸ“ï¼šæ¡Œé¢ç«¯æ‚¬åœæ˜¾ç¤ºï¼Œç§»åŠ¨ç«¯å§‹ç»ˆæ˜¾ç¤ºæ’­æ”¾æŒ‰é’® */}
      {(
        // æ¡Œé¢ç«¯ï¼šæ‚¬åœæ—¶æ˜¾ç¤ºï¼ˆæ”¯æŒè‡ªåŠ¨æ’­æ”¾ï¼‰
        (isHovered && autoPlayOnHover && canHover) ||
        // ç§»åŠ¨ç«¯æˆ–ä¸æ”¯æŒæ‚¬åœï¼šå§‹ç»ˆæ˜¾ç¤ºæ’­æ”¾æŒ‰é’®
        (isMobile && showPlayButton) ||
        // æ¡Œé¢ç«¯ä¸æ”¯æŒè‡ªåŠ¨æ’­æ”¾ï¼šå§‹ç»ˆæ˜¾ç¤ºæ’­æ”¾æŒ‰é’®
        (!autoPlayOnHover && showPlayButton)
      ) && (
        <>
          
          {/* ğŸš€ ä¸­å¤®æ’­æ”¾æŒ‰é’®ï¼šåªåœ¨æš‚åœçŠ¶æ€æ˜¾ç¤ºï¼Œæ’­æ”¾çŠ¶æ€éšè— */}
          {!isBuffering && showPlayButton && !isCurrentlyPlaying(playerId) && !isPendingPlay(playerId) && (
            <div
              className="absolute inset-0 flex items-center justify-center cursor-pointer transition-opacity duration-200 z-10"
              onClick={handlePlayPause}
              onTouchStart={(e) => {
                // ğŸ”§ ç§»åŠ¨ç«¯è§¦æ‘¸ä¼˜åŒ–ï¼šé¿å…é‡å¤è§¦å‘ç¼“å†²çŠ¶æ€
                if (isMobile) {
                  const video = videoRef.current
                  if (video) {
                    // è®¾ç½®è§¦æ‘¸çŠ¶æ€æ ‡è®°ï¼Œé˜²æ­¢touchå’Œclickäº‹ä»¶å†²çª
                    (video as any).__touchInProgress = true
                    // 250msåæ¸…é™¤è§¦æ‘¸çŠ¶æ€
                    setTimeout(() => {
                      // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥ç»„ä»¶æ˜¯å¦ä»ç„¶æŒ‚è½½
                      if (!isMountedRef.current) return
                      (video as any).__touchInProgress = false
                    }, 250)
                  }
                  
                  // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥ç»„ä»¶æ˜¯å¦ä»ç„¶æŒ‚è½½
                  if (!isMountedRef.current) return
                  
                  safeSetState(setShowControls, true, 'showControls')
                  safeSetState(setHasInteracted, true, 'hasInteracted')
                  // æ¸è¿›å¼é¢„åŠ è½½ï¼šä»…åœ¨éœ€è¦æ—¶åˆ‡æ¢åˆ°auto
                  if (currentPreload !== 'auto' && !isBuffering) {
                    safeSetState(setCurrentPreload, 'auto', 'currentPreload')
                  }
                  // ğŸš€ é¿å…é‡å¤è®¾ç½®ç¼“å†²çŠ¶æ€ï¼Œè®©handleLoadStartç»Ÿä¸€ç®¡ç†
                  console.log('[SimpleVideoPlayer] è§¦æ‘¸å¼€å§‹ï¼Œå‡†å¤‡æ’­æ”¾')
                }
              }}
            >
              {/* ğŸ¯ æ ‡å‡†è§†é¢‘æ’­æ”¾å™¨è¡Œä¸ºï¼šæš‚åœæ—¶æ˜¾ç¤ºæ’­æ”¾æŒ‰é’®ï¼Œæ’­æ”¾æ—¶éšè—æŒ‰é’® */}
              <div className="h-12 w-12 md:h-14 md:w-14 bg-black/60 rounded-full flex items-center justify-center backdrop-blur-sm border border-white/20 hover:bg-black/80 transition-all duration-200">
                <Play className="h-6 w-6 md:h-8 md:w-8 text-white" />
              </div>
            </div>
          )}
        </>
      )}
      
      {/* ğŸš€ ç®€å•çš„åŠé€æ˜åœ†ç¯ç¼“å†²è¿›åº¦æŒ‡ç¤ºå™¨ - ä¸æ’­æ”¾æŒ‰é’®å°ºå¯¸ä¸€è‡´ */}
      {isBuffering && (
        <div className="absolute inset-0 flex items-center justify-center z-10">
          <div className="relative h-12 w-12 md:h-14 md:w-14 flex items-center justify-center">
            {/* åŠé€æ˜é»‘è‰²åœ†å½¢èƒŒæ™¯ - ä¸æ’­æ”¾æŒ‰é’®è¾¹æ¡†åšåº¦ä¸€è‡´ */}
            <div className="absolute inset-0 h-12 w-12 md:h-14 md:w-14 bg-black/60 rounded-full border border-white/20 z-0"></div>
            
            {/* è¿›åº¦åœ†ç¯ */}
            <svg className="absolute inset-0 h-12 w-12 md:h-14 md:w-14 transform -rotate-90 z-10" viewBox="0 0 48 48">
              <circle
                cx="24"
                cy="24"
                r="22"
                fill="none"
                stroke="white"
                strokeWidth="2"
                strokeOpacity="0.8"
                strokeLinecap="round"
                strokeDasharray={138.23} // 2Ï€ Ã— 22 â‰ˆ 138.23
                strokeDashoffset={138.23 - (138.23 * uiProgress) / 100}
                className="transition-all duration-300"
              />
            </svg>
            
            {/* ä¸­å¿ƒç™¾åˆ†æ¯”æ–‡å­— - æ˜¾ç¤ºåœ¨æœ€å‰é¢ */}
            <div className="relative z-20 text-white text-xs md:text-sm font-medium">
              {Math.round(uiProgress)}%
            </div>
          </div>
        </div>
      )}
      
      {/* æ’­æ”¾æ§åˆ¶æ  - æ‚¬åœä¸”æœ‰è§†é¢‘æ—¶æ˜¾ç¤ºï¼ˆæ— è®ºæ’­æ”¾è¿˜æ˜¯æš‚åœï¼‰ */}
      {showControls && duration > 0 && (
        <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent">
          {/* è¿›åº¦æ¡åŒºåŸŸ */}
          <div className="px-4 pt-4 pb-2">
            <div 
              className="relative w-full h-1 bg-white/30 rounded-full cursor-pointer group/progress"
              onClick={handleProgressClick}
            >
              {/* æ’­æ”¾è¿›åº¦ */}
              <div 
                className="absolute left-0 top-0 h-full bg-white rounded-full transition-all duration-150"
                style={{ width: `${duration > 0 ? (currentTime / duration) * 100 : 0}%` }}
              />
              {/* æ‚¬åœæ—¶çš„è¿›åº¦ç‚¹ */}
              <div 
                className="absolute top-1/2 w-3 h-3 bg-white rounded-full shadow-md -translate-y-1/2 
                          opacity-0 group-hover/progress:opacity-100 transition-opacity"
                style={{ left: `calc(${duration > 0 ? (currentTime / duration) * 100 : 0}% - 6px)` }}
              />
            </div>
          </div>
          
          {/* æ§åˆ¶æŒ‰é’®åŒºåŸŸ */}
          <div className="flex items-center justify-between px-4 pb-3">
            {/* å·¦ä¾§æ§åˆ¶ç»„ */}
            <div className="flex items-center gap-2">
              {/* ğŸš€ æ’­æ”¾/æš‚åœæŒ‰é’® - æ ¹æ®æ’­æ”¾çŠ¶æ€æ˜¾ç¤ºä¸åŒå›¾æ ‡ */}
              <button
                onClick={handlePlayPause}
                className="flex items-center justify-center w-8 h-8 text-white hover:bg-white/20 
                         active:bg-white/40 active:scale-95 rounded-full transition-all duration-150
                         touch-manipulation select-none"
                aria-label={isCurrentlyPlaying(playerId) ? "æš‚åœ" : "æ’­æ”¾"}
                style={{ 
                  WebkitTapHighlightColor: 'transparent',
                  userSelect: 'none',
                  touchAction: 'manipulation'
                }}
              >
                {isCurrentlyPlaying(playerId) ? (
                  <Pause className="h-4 w-4" />
                ) : (
                  <Play className="h-4 w-4" />
                )}
              </button>
              
              {/* é™éŸ³æ§åˆ¶æŒ‰é’® */}
              <button
                onClick={handleMuteToggle}
                className="flex items-center justify-center w-8 h-8 text-white hover:bg-white/20 
                         active:bg-white/40 active:scale-95 rounded-full transition-all duration-150
                         touch-manipulation select-none"
                aria-label={isMuted ? 'å–æ¶ˆé™éŸ³' : 'é™éŸ³'}
                style={{ 
                  WebkitTapHighlightColor: 'transparent',
                  userSelect: 'none',
                  touchAction: 'manipulation'
                }}
              >
                {isMuted ? (
                  <VolumeX className="h-4 w-4" />
                ) : (
                  <Volume2 className="h-4 w-4" />
                )}
              </button>
            </div>
            
            {/* å³ä¾§æ§åˆ¶ç»„ */}
            <div className="flex items-center gap-0.5">
              {/* æ—¶é—´æ˜¾ç¤º - ç»†å­—ä½“ï¼Œä½äºå…¨å±æŒ‰é’®å·¦ä¾§ */}
              <div className="text-white text-xs font-light font-sans">
                {formatTime(currentTime)} / {formatTime(duration)}
              </div>
              
              {/* å…¨å±æŒ‰é’® - ä½äºæœ€å³ä¾§ */}
              <button
                onClick={toggleFullscreen}
                className="flex items-center justify-center w-8 h-8 text-white hover:bg-white/20 
                         active:bg-white/40 active:scale-95 rounded-full transition-all duration-150
                         touch-manipulation select-none"
                aria-label={getFullscreenTooltip(isFullscreen)}
                title={getFullscreenTooltip(isFullscreen)}
                style={{ 
                  WebkitTapHighlightColor: 'transparent',
                  userSelect: 'none',
                  touchAction: 'manipulation'
                }}
              >
                {isFullscreen ? (
                  <Minimize className="h-4 w-4" />
                ) : (
                  <Maximize className="h-4 w-4" />
                )}
              </button>
            </div>
          </div>
        </div>
      )}

    </div>
  )
}

// è½»é‡ç‰ˆæ’­æ”¾å™¨ï¼ˆLightVideoPlayerï¼‰å·²ç§»é™¤ï¼Œé¿å…é‡å¤å®ç°ä¸ç»´æŠ¤è´Ÿæ‹…

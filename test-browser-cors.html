<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµè§ˆå™¨CORSæµ‹è¯• - é¢„ç­¾åURLä¸Šä¼ </title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .progress {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background-color: #28a745;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª æµè§ˆå™¨CORSæµ‹è¯• - é¢„ç­¾åURLä¸Šä¼ </h1>
        
        <div class="info status">
            <strong>æµ‹è¯•ç›®æ ‡:</strong> éªŒè¯é¢„ç­¾åURLæ–¹æ¡ˆåœ¨æµè§ˆå™¨ç¯å¢ƒä¸‹çš„CORSå…¼å®¹æ€§
        </div>

        <h2>ğŸ“‹ æµ‹è¯•æ­¥éª¤</h2>
        <ol>
            <li>è·å–é¢„ç­¾åURL</li>
            <li>ä¸‹è½½æµ‹è¯•è§†é¢‘</li>
            <li>ä½¿ç”¨é¢„ç­¾åURLä¸Šä¼ åˆ°R2</li>
            <li>éªŒè¯ä¸Šä¼ ç»“æœ</li>
        </ol>

        <div>
            <button id="startTest" onclick="startCORSTest()">å¼€å§‹CORSæµ‹è¯•</button>
            <button id="clearLog" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        </div>

        <div id="progress" class="progress" style="display: none;">
            <div id="progressBar" class="progress-bar" style="width: 0%;"></div>
        </div>

        <div id="status" class="info status" style="display: none;">
            æ­£åœ¨åˆå§‹åŒ–æµ‹è¯•...
        </div>

        <h2>ğŸ“Š æµ‹è¯•æ—¥å¿—</h2>
        <div id="log">
            <div class="info status">ç­‰å¾…å¼€å§‹æµ‹è¯•...</div>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://hvkzwrnvxsleeonqqrzq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2a3p3cm52eHNsZWVvbnFxcnpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3NjQ1NjAsImV4cCI6MjA3MTM0MDU2MH0.VOHVXCUFRk83t1cfPHd6Lf5SwWDQHn1Hl2Mn0qqiyPk';
        
        // æµ‹è¯•è§†é¢‘URLï¼ˆä½¿ç”¨æˆ‘ä»¬çš„æµ‹è¯•è§†é¢‘ï¼‰
        const testVideoUrl = 'https://heyoo.oss-ap-southeast-1.aliyuncs.com/fba658c2-4ae0-4097-9f64-59a9575390c4_normal.mp4';

        let logContainer = document.getElementById('log');
        let statusDiv = document.getElementById('status');
        let progressDiv = document.getElementById('progress');
        let progressBar = document.getElementById('progressBar');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = `${type} status`;
            div.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logContainer.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
        }

        function updateProgress(percent) {
            progressBar.style.width = percent + '%';
        }

        function updateStatus(message, type = 'info') {
            statusDiv.className = `${type} status`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }

        function clearLog() {
            logContainer.innerHTML = '<div class="info status">æ—¥å¿—å·²æ¸…é™¤</div>';
            statusDiv.style.display = 'none';
            progressDiv.style.display = 'none';
        }

        async function startCORSTest() {
            const button = document.getElementById('startTest');
            button.disabled = true;
            progressDiv.style.display = 'block';
            
            try {
                log('ğŸš€ å¼€å§‹æµè§ˆå™¨CORSæµ‹è¯•');
                updateStatus('æ­£åœ¨è¿›è¡ŒCORSæµ‹è¯•...', 'info');
                updateProgress(10);

                const testVideoId = `browser-test-${Date.now()}`;
                log(`ğŸ“¹ æµ‹è¯•è§†é¢‘ID: ${testVideoId}`);

                // ç¬¬ä¸€æ­¥ï¼šè·å–é¢„ç­¾åURL
                log('ğŸ”— æ­¥éª¤1: è·å–é¢„ç­¾åURL...');
                updateProgress(20);

                const urlResponse = await fetch(`${supabaseUrl}/functions/v1/generate-upload-url`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${supabaseKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        videoId: testVideoId,
                        contentType: 'video/mp4',
                        expiresIn: 3600
                    })
                });

                if (!urlResponse.ok) {
                    throw new Error(`é¢„ç­¾åURLè·å–å¤±è´¥: ${urlResponse.status}`);
                }

                const urlData = await urlResponse.json();
                if (!urlData.success) {
                    throw new Error(`é¢„ç­¾åURLç”Ÿæˆå¤±è´¥: ${urlData.error}`);
                }

                const { signedUrl, publicUrl } = urlData.data;
                log('âœ… é¢„ç­¾åURLè·å–æˆåŠŸ', 'success');
                log(`ğŸ“‹ å…¬å¼€URL: <a href="${publicUrl}" target="_blank">${publicUrl}</a>`);
                updateProgress(40);

                // ç¬¬äºŒæ­¥ï¼šä¸‹è½½æµ‹è¯•è§†é¢‘
                log('â¬‡ï¸ æ­¥éª¤2: ä¸‹è½½æµ‹è¯•è§†é¢‘...');
                updateProgress(50);

                const videoResponse = await fetch(testVideoUrl);
                if (!videoResponse.ok) {
                    throw new Error(`è§†é¢‘ä¸‹è½½å¤±è´¥: ${videoResponse.status}`);
                }

                const videoBlob = await videoResponse.blob();
                log(`âœ… è§†é¢‘ä¸‹è½½æˆåŠŸ: ${videoBlob.size} bytes (${(videoBlob.size / 1024 / 1024).toFixed(2)} MB)`, 'success');
                updateProgress(70);

                // ç¬¬ä¸‰æ­¥ï¼šä½¿ç”¨é¢„ç­¾åURLä¸Šä¼ ï¼ˆè¿™é‡Œæ˜¯å…³é”®çš„CORSæµ‹è¯•ç‚¹ï¼‰
                log('â¬†ï¸ æ­¥éª¤3: ä½¿ç”¨é¢„ç­¾åURLä¸Šä¼ åˆ°R2... (CORSæµ‹è¯•å…³é”®ç‚¹)', 'warning');
                updateProgress(80);

                try {
                    const uploadResponse = await fetch(signedUrl, {
                        method: 'PUT',
                        body: videoBlob,
                        headers: {
                            'Content-Type': 'video/mp4'
                        }
                    });

                    if (!uploadResponse.ok) {
                        const errorText = await uploadResponse.text();
                        throw new Error(`ä¸Šä¼ å¤±è´¥: ${uploadResponse.status} - ${errorText}`);
                    }

                    log('âœ… R2ä¸Šä¼ æˆåŠŸ - CORSé…ç½®æ­£ç¡®ï¼', 'success');
                    updateProgress(90);

                    // ç¬¬å››æ­¥ï¼šéªŒè¯ä¸Šä¼ ç»“æœ
                    log('ğŸ” æ­¥éª¤4: éªŒè¯ä¸Šä¼ ç»“æœ...');
                    
                    // ç­‰å¾…R2å¤„ç†
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    const verifyResponse = await fetch(publicUrl, { method: 'HEAD' });
                    if (verifyResponse.ok) {
                        log('âœ… æ–‡ä»¶å¯é€šè¿‡å…¬å¼€URLè®¿é—®', 'success');
                        log(`ğŸ“Š æ–‡ä»¶ä¿¡æ¯: Content-Type: ${verifyResponse.headers.get('content-type')}, Size: ${verifyResponse.headers.get('content-length')} bytes`);
                    } else {
                        log('âš ï¸ æ–‡ä»¶æš‚æ—¶æ— æ³•è®¿é—®ï¼ˆå¯èƒ½éœ€è¦ç­‰å¾…CDNåŒæ­¥ï¼‰', 'warning');
                    }

                    updateProgress(100);
                    updateStatus('ğŸ‰ CORSæµ‹è¯•å®Œå…¨æˆåŠŸï¼é¢„ç­¾åURLæ–¹æ¡ˆåœ¨æµè§ˆå™¨ä¸­å·¥ä½œæ­£å¸¸', 'success');
                    
                    log('ğŸ¯ ========== æµ‹è¯•æ€»ç»“ ==========', 'success');
                    log('âœ… é¢„ç­¾åURLè·å– - æˆåŠŸ', 'success');
                    log('âœ… è§†é¢‘æ–‡ä»¶ä¸‹è½½ - æˆåŠŸ', 'success');
                    log('âœ… R2è·¨åŸŸä¸Šä¼  - æˆåŠŸ (æ— CORSé”™è¯¯)', 'success');
                    log('âœ… æ–‡ä»¶è®¿é—®éªŒè¯ - æˆåŠŸ', 'success');
                    log('ğŸ‰ ç»“è®º: æ–¹æ¡ˆ2å®Œå…¨å¯è¡Œï¼ŒCORSé…ç½®æ­£ç¡®ï¼', 'success');

                } catch (corsError) {
                    if (corsError.message.includes('CORS') || corsError.message.includes('cors')) {
                        log('âŒ CORSé”™è¯¯: éœ€è¦é…ç½®R2å­˜å‚¨æ¡¶çš„CORSè®¾ç½®', 'error');
                        updateStatus('CORSé…ç½®éœ€è¦è°ƒæ•´', 'error');
                    } else {
                        throw corsError;
                    }
                }

            } catch (error) {
                log(`ğŸ’¥ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                updateStatus(`æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error('è¯¦ç»†é”™è¯¯:', error);

                log('ğŸ” æ•…éšœæ’é™¤å»ºè®®:', 'warning');
                log('1. æ£€æŸ¥Edge Functionæ˜¯å¦æ­£ç¡®éƒ¨ç½²', 'warning');
                log('2. éªŒè¯ç¯å¢ƒå˜é‡é…ç½®', 'warning');
                log('3. ç¡®è®¤R2 CORSè®¾ç½®æ­£ç¡®', 'warning');
                log('4. æ£€æŸ¥ç½‘ç»œè¿æ¥', 'warning');
            } finally {
                button.disabled = false;
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºåˆå§‹ä¿¡æ¯
        window.addEventListener('load', function() {
            log('ğŸŒ æµè§ˆå™¨ç¯å¢ƒæµ‹è¯•é¡µé¢å·²åŠ è½½');
            log('ğŸ“‹ æµ‹è¯•å°†éªŒè¯é¢„ç­¾åURLæ–¹æ¡ˆçš„CORSå…¼å®¹æ€§');
            log('âš¡ ç‚¹å‡»"å¼€å§‹CORSæµ‹è¯•"æŒ‰é’®å¼€å§‹æµ‹è¯•');
        });
    </script>
</body>
</html>
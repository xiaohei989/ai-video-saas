<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视频播放错误测试 V2</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .video-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        .video-section.problem {
            border-color: #ff6b6b;
            background-color: #fff5f5;
        }
        .video-section.normal {
            border-color: #51cf66;
            background-color: #f8fff8;
        }
        video {
            width: 100%;
            max-width: 400px;
            height: auto;
            border-radius: 4px;
        }
        .error-info {
            margin-top: 10px;
            padding: 10px;
            background: #ffe6e6;
            border-left: 4px solid #ff4444;
            border-radius: 4px;
            font-size: 14px;
        }
        .success-info {
            margin-top: 10px;
            padding: 10px;
            background: #e6ffe6;
            border-left: 4px solid #44ff44;
            border-radius: 4px;
            font-size: 14px;
        }
        .device-info {
            background: #e6f3ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
            min-height: 44px;
        }
        button:hover {
            background: #0056b3;
        }
        button:active {
            background: #004085;
        }
        .big-button {
            background: #28a745;
            font-size: 18px;
            padding: 15px 30px;
            font-weight: bold;
        }
        .big-button:hover {
            background: #1e7e34;
        }
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        .step-number {
            display: inline-block;
            width: 30px;
            height: 30px;
            background: #007bff;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 视频播放错误诊断测试页面 V2</h1>
        
        <div class="warning-box">
            <h3>⚠️ 错误代码 20 (NotAllowedError) 解决方案</h3>
            <p><strong>问题原因:</strong> 移动浏览器要求视频播放必须由用户手势触发</p>
            <p><strong>解决方法:</strong> 必须先点击下面的"🎯 用户点击播放测试"按钮</p>
        </div>

        <div class="device-info" id="deviceInfo">
            <h3>设备信息</h3>
            <div id="deviceDetails">正在检测设备信息...</div>
        </div>

        <!-- 用户交互测试区域 -->
        <div style="text-align: center; margin: 30px 0;">
            <h2>👆 必须先进行用户交互测试</h2>
            <button class="big-button" onclick="startUserInteractionTest()">
                🎯 用户点击播放测试 (解决错误代码20)
            </button>
        </div>

        <!-- 问题视频 -->
        <div class="video-section problem">
            <h3>🚨 问题视频: fireplace-seduction-selfie.mp4</h3>
            <p><strong>URL:</strong> https://cdn.veo3video.me/templates/videos/fireplace-seduction-selfie.mp4?v=1758008502567</p>
            <p><strong>已知问题:</strong> 移动端无法播放，码率较低 (2.08 Mbps)</p>
            
            <video id="problemVideo" controls preload="none" webkit-playsinline playsinline>
                <source src="https://cdn.veo3video.me/templates/videos/fireplace-seduction-selfie.mp4?v=1758008502567" type="video/mp4">
                您的浏览器不支持视频播放
            </video>
            
            <div>
                <button onclick="testVideoWithUserGesture('problemVideo')">
                    <span class="step-number">1</span>手势播放测试
                </button>
                <button onclick="testVideoLoad('problemVideo')">
                    <span class="step-number">2</span>加载测试
                </button>
                <button onclick="checkVideoInfo('problemVideo')">
                    <span class="step-number">3</span>技术信息
                </button>
            </div>
            
            <div id="problemVideoResult"></div>
        </div>

        <!-- 正常对比视频 -->
        <div class="video-section normal">
            <h3>✅ 对比视频: 正常播放的模板视频</h3>
            <p><strong>URL:</strong> https://cdn.veo3video.me/templates/videos/asmr-surreal-toast-spread.mp4</p>
            <p><strong>状态:</strong> 正常播放，码率适中</p>
            
            <video id="normalVideo" controls preload="none" webkit-playsinline playsinline>
                <source src="https://cdn.veo3video.me/templates/videos/asmr-surreal-toast-spread.mp4" type="video/mp4">
                您的浏览器不支持视频播放
            </video>
            
            <div>
                <button onclick="testVideoWithUserGesture('normalVideo')">
                    <span class="step-number">1</span>手势播放测试
                </button>
                <button onclick="testVideoLoad('normalVideo')">
                    <span class="step-number">2</span>加载测试
                </button>
                <button onclick="checkVideoInfo('normalVideo')">
                    <span class="step-number">3</span>技术信息
                </button>
            </div>
            
            <div id="normalVideoResult"></div>
        </div>

        <div class="warning-box">
            <h3>📋 测试步骤（按顺序进行）</h3>
            <p><span class="step-number">1</span> 先点击"🎯 用户点击播放测试"建立用户交互</p>
            <p><span class="step-number">2</span> 点击"手势播放测试"测试视频播放</p>
            <p><span class="step-number">3</span> 点击"加载测试"检查视频加载状态</p>
            <p><span class="step-number">4</span> 点击"技术信息"查看视频详细参数</p>
        </div>
    </div>

    <script>
        let userInteractionEstablished = false;

        // 设备信息检测
        function detectDevice() {
            const ua = navigator.userAgent;
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
            const isIOS = /iPad|iPhone|iPod/.test(ua);
            const isAndroid = /Android/.test(ua);
            const browser = getBrowserName();
            const isHTTPS = location.protocol === 'https:';
            
            document.getElementById('deviceDetails').innerHTML = `
                <div><strong>用户代理:</strong> ${ua}</div>
                <div><strong>设备类型:</strong> ${isMobile ? '📱 移动设备' : '🖥️ 桌面设备'}</div>
                <div><strong>操作系统:</strong> ${isIOS ? '🍎 iOS' : isAndroid ? '🤖 Android' : '💻 其他'}</div>
                <div><strong>浏览器:</strong> ${browser}</div>
                <div><strong>协议:</strong> ${isHTTPS ? '🔒 HTTPS (安全)' : '⚠️ HTTP (不安全)'}</div>
                <div><strong>屏幕分辨率:</strong> ${window.screen.width}x${window.screen.height}</div>
                <div><strong>视窗大小:</strong> ${window.innerWidth}x${window.innerHeight}</div>
                <div><strong>像素比:</strong> ${window.devicePixelRatio}</div>
            `;
        }

        function getBrowserName() {
            const ua = navigator.userAgent;
            if (ua.includes('CriOS')) return 'Chrome (iOS)';
            if (ua.includes('Chrome') && !ua.includes('Edge')) return 'Chrome';
            if (ua.includes('Firefox')) return 'Firefox';
            if (ua.includes('Safari') && !ua.includes('Chrome')) return 'Safari';
            if (ua.includes('Edge')) return 'Edge';
            return '未知浏览器';
        }

        // 显示结果信息
        function showResult(videoId, message, isSuccess = false) {
            const resultDiv = document.getElementById(videoId + 'Result');
            const className = isSuccess ? 'success-info' : 'error-info';
            resultDiv.innerHTML = `<div class="${className}">${message}</div>`;
            
            // 同时弹出提示
            alert(message);
        }

        // 用户交互测试
        function startUserInteractionTest() {
            userInteractionEstablished = true;
            
            const message = `✅ 用户交互已建立！
            
📊 详细信息:
- 时间: ${new Date().toLocaleString()}
- 设备: ${navigator.userAgent.includes('Mobile') ? '移动设备' : '桌面设备'}
- 浏览器: ${getBrowserName()}
- 协议: ${location.protocol}

🎯 现在可以进行视频播放测试了！
请点击"手势播放测试"按钮继续。`;
            
            alert(message);
            
            // 更新按钮状态
            const button = event.target;
            button.style.background = '#28a745';
            button.innerHTML = '✅ 用户交互已建立';
            button.disabled = true;
        }

        // 带用户手势的视频播放测试
        function testVideoWithUserGesture(videoId) {
            if (!userInteractionEstablished) {
                showResult(videoId, '❌ 请先点击"🎯 用户点击播放测试"建立用户交互！');
                return;
            }

            const video = document.getElementById(videoId);
            const startTime = Date.now();
            
            console.log(`开始用户手势播放测试: ${videoId}`);
            
            // 先尝试加载视频
            video.load();
            
            // 添加事件监听
            const events = {
                loadstart: '开始加载',
                loadedmetadata: '元数据加载完成',
                loadeddata: '数据加载完成', 
                canplay: '可以播放',
                canplaythrough: '可以流畅播放',
                play: '开始播放',
                playing: '正在播放',
                error: '发生错误',
                stalled: '播放停滞',
                waiting: '等待数据'
            };
            
            const eventLog = [];
            
            Object.keys(events).forEach(eventName => {
                video.addEventListener(eventName, function(e) {
                    const elapsed = Date.now() - startTime;
                    const logEntry = `[${elapsed}ms] ${events[eventName]}`;
                    eventLog.push(logEntry);
                    console.log(`${videoId} - ${logEntry}`);
                    
                    if (eventName === 'error') {
                        const error = e.target.error;
                        const errorMsg = `❌ 视频加载/播放错误!

🚨 错误详情:
- 视频ID: ${videoId}
- 错误代码: ${error ? error.code : '未知'}
- 错误信息: ${error ? getMediaErrorMessage(error.code) : '无详细信息'}
- 网络状态: ${getNetworkState(video.networkState)}
- 就绪状态: ${getReadyState(video.readyState)}

📊 事件日志:
${eventLog.join('\\n')}

🔧 可能的解决方案:
1. 检查网络连接
2. 确认视频文件存在
3. 检查视频格式兼容性
4. 尝试使用HTTPS协议`;
                        
                        showResult(videoId, errorMsg);
                    }
                }, { once: true });
            });
            
            // 尝试播放
            setTimeout(() => {
                const playPromise = video.play();
                
                if (playPromise !== undefined) {
                    playPromise
                        .then(() => {
                            const elapsed = Date.now() - startTime;
                            const successMsg = `✅ 视频播放成功！

📊 播放详情:
- 视频ID: ${videoId}
- 播放时长: ${elapsed}ms
- 当前时间: ${video.currentTime.toFixed(2)}s
- 总时长: ${video.duration ? video.duration.toFixed(2) + 's' : '未知'}
- 视频尺寸: ${video.videoWidth}x${video.videoHeight}
- 音量: ${video.volume}
- 是否静音: ${video.muted ? '是' : '否'}

📋 事件日志:
${eventLog.join('\\n')}

🎉 这个视频在您的设备上可以正常播放！`;
                            
                            showResult(videoId, successMsg, true);
                        })
                        .catch(error => {
                            const elapsed = Date.now() - startTime;
                            const errorMsg = `❌ 视频播放失败！

🚨 错误详情:
- 视频ID: ${videoId}
- 错误类型: ${error.name}
- 错误消息: ${error.message}
- 错误代码: ${error.code || '未提供'}
- 用时: ${elapsed}ms

📊 视频状态:
- 网络状态: ${getNetworkState(video.networkState)}
- 就绪状态: ${getReadyState(video.readyState)}
- 当前时间: ${video.currentTime}s
- 是否暂停: ${video.paused ? '是' : '否'}

📋 事件日志:
${eventLog.join('\\n')}

🔧 建议解决方案:
${getErrorSolution(error.name, error.code)}`;
                            
                            showResult(videoId, errorMsg);
                        });
                } else {
                    showResult(videoId, '⚠️ 浏览器不支持 play() Promise API');
                }
            }, 500);
        }

        // 视频加载测试
        function testVideoLoad(videoId) {
            const video = document.getElementById(videoId);
            const startTime = Date.now();
            
            video.addEventListener('loadedmetadata', function() {
                const elapsed = Date.now() - startTime;
                const loadMsg = `📊 视频加载测试结果:

✅ 基本信息:
- 加载时间: ${elapsed}ms  
- 总时长: ${video.duration ? video.duration.toFixed(2) + 's' : '未知'}
- 视频尺寸: ${video.videoWidth}x${video.videoHeight}
- 网络状态: ${getNetworkState(video.networkState)}
- 就绪状态: ${getReadyState(video.readyState)}

📡 网络信息:
- 当前源: ${video.currentSrc}
- 预加载: ${video.preload}
- 跨域: ${video.crossOrigin || '未设置'}

💡 结论: ${video.readyState >= 1 ? '✅ 视频元数据加载正常' : '❌ 视频元数据加载失败'}`;
                
                showResult(videoId, loadMsg, video.readyState >= 1);
            }, { once: true });
            
            video.addEventListener('error', function(e) {
                const elapsed = Date.now() - startTime;
                const error = e.target.error;
                const errorMsg = `❌ 视频加载失败！

🚨 加载错误:
- 用时: ${elapsed}ms
- 错误代码: ${error ? error.code : '未知'}
- 错误信息: ${error ? getMediaErrorMessage(error.code) : '无详细信息'}
- 当前源: ${video.currentSrc}

🔧 解决建议:
${error ? getLoadErrorSolution(error.code) : '请检查网络连接和视频文件'}`;
                
                showResult(videoId, errorMsg);
            }, { once: true });
            
            // 开始加载
            video.load();
        }

        // 检查视频详细信息
        function checkVideoInfo(videoId) {
            const video = document.getElementById(videoId);
            
            const info = `📊 视频技术详情 - ${videoId}

🎬 基本信息:
- 当前时间: ${video.currentTime.toFixed(2)}s
- 总时长: ${video.duration ? video.duration.toFixed(2) + 's' : '未知'}
- 播放状态: ${video.paused ? '⏸️ 暂停' : '▶️ 播放中'}
- 静音状态: ${video.muted ? '🔇 已静音' : '🔊 有声音'}
- 音量: ${(video.volume * 100).toFixed(0)}%
- 播放速度: ${video.playbackRate}x

📺 视频属性:
- 视频宽度: ${video.videoWidth}px
- 视频高度: ${video.videoHeight}px
- 显示宽度: ${video.clientWidth}px
- 显示高度: ${video.clientHeight}px
- 宽高比: ${video.videoWidth && video.videoHeight ? (video.videoWidth/video.videoHeight).toFixed(2) : '未知'}

🌐 网络状态:
- 网络状态: ${getNetworkState(video.networkState)}
- 就绪状态: ${getReadyState(video.readyState)}
- 是否可播放: ${video.readyState >= 3 ? '✅ 是' : '❌ 否'}
- 缓冲范围: ${getBufferedRanges(video)}

🔗 源信息:
- 当前源: ${video.currentSrc}
- 预加载: ${video.preload}
- 跨域设置: ${video.crossOrigin || '未设置'}
- 循环播放: ${video.loop ? '是' : '否'}

📱 移动端属性:
- 内联播放: ${video.playsInline ? '✅ 支持' : '❌ 不支持'}
- 自动播放: ${video.autoplay ? '开启' : '关闭'}`;
            
            alert(info);
            console.log(info);
        }

        function getBufferedRanges(video) {
            const buffered = video.buffered;
            if (buffered.length === 0) return '无缓冲数据';
            
            const ranges = [];
            for (let i = 0; i < buffered.length; i++) {
                ranges.push(`${buffered.start(i).toFixed(2)}s - ${buffered.end(i).toFixed(2)}s`);
            }
            return ranges.join(', ');
        }

        function getMediaErrorMessage(code) {
            const messages = {
                1: 'MEDIA_ERR_ABORTED - 用户取消了视频加载',
                2: 'MEDIA_ERR_NETWORK - 网络错误导致视频下载失败', 
                3: 'MEDIA_ERR_DECODE - 视频解码错误',
                4: 'MEDIA_ERR_SRC_NOT_SUPPORTED - 视频格式不支持或源无效'
            };
            return messages[code] || `未知错误代码: ${code}`;
        }

        function getNetworkState(state) {
            const states = {
                0: 'NETWORK_EMPTY - 未初始化',
                1: 'NETWORK_IDLE - 已选择资源但未使用网络',
                2: 'NETWORK_LOADING - 正在下载数据',
                3: 'NETWORK_NO_SOURCE - 未找到合适的资源'
            };
            return states[state] || `未知状态: ${state}`;
        }

        function getReadyState(state) {
            const states = {
                0: 'HAVE_NOTHING - 无数据',
                1: 'HAVE_METADATA - 有元数据', 
                2: 'HAVE_CURRENT_DATA - 有当前数据',
                3: 'HAVE_FUTURE_DATA - 有未来数据',
                4: 'HAVE_ENOUGH_DATA - 有足够数据'
            };
            return states[state] || `未知状态: ${state}`;
        }

        function getErrorSolution(errorName, errorCode) {
            const solutions = {
                'NotAllowedError': '• 确保通过用户手势触发播放\n• 尝试先静音播放\n• 检查浏览器自动播放政策',
                'AbortError': '• 检查网络连接稳定性\n• 重新加载页面\n• 清除浏览器缓存',
                'NetworkError': '• 检查网络连接\n• 确认视频URL有效\n• 尝试使用HTTPS',
                'NotSupportedError': '• 检查视频格式兼容性\n• 尝试其他浏览器\n• 确认编解码器支持'
            };
            
            return solutions[errorName] || '• 重新加载页面\n• 检查网络连接\n• 尝试其他浏览器';
        }

        function getLoadErrorSolution(code) {
            const solutions = {
                1: '• 用户可能取消了加载，请重试',
                2: '• 检查网络连接\n• 确认视频服务器正常\n• 尝试使用WiFi',
                3: '• 视频文件可能损坏\n• 检查视频编码格式\n• 联系技术支持',
                4: '• 视频格式不受支持\n• 检查文件扩展名\n• 尝试重新编码视频'
            };
            
            return solutions[code] || '• 重新加载页面\n• 检查视频文件\n• 联系技术支持';
        }

        // 页面加载完成后初始化
        window.addEventListener('load', function() {
            console.log('视频错误测试页面 V2 加载完成');
            detectDevice();
        });
    </script>
</body>
</html>